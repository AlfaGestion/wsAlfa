

GO

/****** Object:  StoredProcedure [dbo].[sp_web_V_MV_CPTE]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_V_MV_CPTE]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_setTareas]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_setTareas]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_setRespuestaTarea]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_setRespuestaTarea]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_setExtensionTareas]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_setExtensionTareas]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_setCobranzaConPago]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_setCobranzaConPago]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_setCobranza]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_setCobranza]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getTransferenciasCaja]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getTransferenciasCaja]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getTareas]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getTareas]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getTareaHelpdesk]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getTareaHelpdesk]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getStockDepositos]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getStockDepositos]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getSaldoTJCaja]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getSaldoTJCaja]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getSaldosStockPagination]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getSaldosStockPagination]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getSaldosStockCardTotal]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getSaldosStockCardTotal]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getSaldosStock]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getSaldosStock]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getSaldosCuentas]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getSaldosCuentas]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getSaldoConsolidadoCaja]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getSaldoConsolidadoCaja]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getRemitosTransportePendientesChofer]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getRemitosTransportePendientesChofer]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getPedidos]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getPedidos]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getListaDePrecios_query]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getListaDePrecios_query]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getListaDePrecios]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getListaDePrecios]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getLibroIva]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getLibroIva]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getIngresosEgresosCaja]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getIngresosEgresosCaja]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getFichaStockArticulo]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getFichaStockArticulo]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getFamiliasArticulos]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getFamiliasArticulos]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getEstadosRemitosTransporte]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getEstadosRemitosTransporte]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getDetalleVentasPorCpteCaja]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getDetalleVentasPorCpteCaja]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getDetallePorRubroCaja]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getDetallePorRubroCaja]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getDetallePorProductoCaja]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getDetallePorProductoCaja]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getDetalleEfectivoCaja]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getDetalleEfectivoCaja]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getDetalleDiarioCaja]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getDetalleDiarioCaja]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getDestinatariosTransporte]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getDestinatariosTransporte]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getDatosEmpresa]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getDatosEmpresa]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getCuentaCorriente]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getCuentaCorriente]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getComprobantesCtaCte]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getComprobantesCtaCte]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getComprobantesCanceladosCaja]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getComprobantesCanceladosCaja]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getComprobantes]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getComprobantes]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getClientesTransporte]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getClientesTransporte]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getChoferes]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getChoferes]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getArticulosPrecios]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getArticulosPrecios]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getAcumuladoVentasCaja]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_getAcumuladoVentasCaja]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_creaLineaAsiento]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_creaLineaAsiento]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_CreaCobranza]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_CreaCobranza]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_CreaCobPorFactura]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_CreaCobPorFactura]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_CreaAsientoIngresoEgreso]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_CreaAsientoIngresoEgreso]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_CreaAplicacionCobranzaFactura]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_CreaAplicacionCobranzaFactura]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_CreaAplicacion]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_CreaAplicacion]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_CpteInsumos]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_CpteInsumos]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_CalificarRespuesta]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_CalificarRespuesta]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_AplicacionCobranzaAutomatica]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_AplicacionCobranzaAutomatica]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_AltaTarea]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_AltaTarea]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_AltaTabla]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_AltaTabla]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_altaCliente]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_altaCliente]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_AltaArticulo]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_AltaArticulo]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_Alta_Comprobante]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_Alta_Comprobante]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_ActualizaEstadoRemitoTransporte]    Script Date: 25/04/2023 11:23:26 ******/
DROP PROCEDURE [dbo].[sp_web_ActualizaEstadoRemitoTransporte]
GO

/****** Object:  StoredProcedure [dbo].[sp_web_ActualizaEstadoRemitoTransporte]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO








CREATE PROCEDURE [dbo].[sp_web_ActualizaEstadoRemitoTransporte]
	@id_remito int,
	@estado nvarchar(4),
	@obs nvarchar(250)
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @WHERE NVARCHAR(250)
	DECLARE @rs NVARCHAR(MAX)
	DECLARE @BASETTE NVARCHAR(250)

	SET @BASETTE = (SELECT VALOR
	FROM TA_CONFIGURACION
	WHERE CLAVE='SAT_BASEDEDATOS')

	SET @estado = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@estado)),4)

	SET @rs = '
	USE ' + @BASETTE + '
	
	DECLARE @TIPOESTADO NVARCHAR(1)
	DECLARE @FECHAENT NVARCHAR(16)
	
	SET @TIPOESTADO = (SELECT LTRIM(TIPO) FROM TA_ESTADOS WHERE LTRIM(CODIGO)=LTRIM('''+@estado+'''))
	IF @TIPOESTADO = ''O'' SET @TIPOESTADO = ''''
	
	IF @TIPOESTADO = ''P'' OR @TIPOESTADO = ''E''
		SET @FECHAENT = GETDATE() 
	ELSE
		SET @FECHAENT = NULL
	
	DECLARE @CLIENTE NVARCHAR(4)
	DECLARE @NRO_VIAJE VARCHAR(13)
	DECLARE @TC VARCHAR(2)
	DECLARE @NRO_REMITO VARCHAR(13)
	DECLARE @NRO_SALIDA INT
	
	SELECT @CLIENTE = CLIENTE,@NRO_VIAJE=NRO_VIAJE,@TC=TIPO_DOCUMENTO,
	@NRO_REMITO = DOCUMENTO_SUCURSAL + NUMERO_DOCUMENTO + DOCUMENTO_LETRA, @NRO_SALIDA=NRO_SALIDA
	FROM MV_RUTEOCAB WHERE ID=' + CONVERT(NVARCHAR,@id_remito) + '

	INSERT INTO MV_SEGUIMIENTO (CLIENTE,NRO_VIAJE,TIPO_DOCUMENTO,NRO_COMPROBANTE,NRO_SALIDA,FECHA_HORA,COD_NOVEDAD,OBSERVACION)
	VALUES (@CLIENTE,@NRO_VIAJE,@TC,@NRO_REMITO,@NRO_SALIDA,CAST(GETDATE() AS date),''' + @estado + ''',''' + @obs + ''')
	
	
	UPDATE MV_RUTEOCAB 
	SET CODIGO_ESTADO='''+@estado+''', Devolucion=@TIPOESTADO,
	PE=''1'',PEDEV=''0'',
	DEV_PESO_BRUTO=0,DEV_BULTOS=0,DEV_M3=0,DEV_VD=0,DEV_CR=0,FH_ENT_DESTINO=@FECHAENT
	WHERE ID=' + CONVERT(NVARCHAR,@id_remito) + ''


	EXEC(@rs)

END







GO

/****** Object:  StoredProcedure [dbo].[sp_web_Alta_Comprobante]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[sp_web_Alta_Comprobante]
    @pCliente                         nvarchar(15) = null,
    @pVendedor                        nvarchar(4) = null,
    @pFecha                           datetime = null,
    @pObservaciones                   NVARCHAR(250) = null,
    @pLat                             NVARCHAR(15) = null,
    @pLng                             NVARCHAR(15) = null,
    @pTC                              NVARCHAR(4) = null,
    @pSucursal                        NVARCHAR(4) = null,
    @pNumero                          NVARCHAR(8) = null,
    @pLetra                           NVARCHAR(1) = null,
    @pResultado                       smallint = NULL OUTPUT,
    @pMensaje                         varchar(255) = NULL OUTPUT,
    @pIdComprobanteRES                int = NULL OUTPUT
AS
DECLARE @IdComprobante NVARCHAR(13)
DECLARE @nombre NVARCHAR(50)
DECLARE @domicilio NVARCHAR(50)
DECLARE @calle NVARCHAR(50)
DECLARE @numero NVARCHAR(50)
DECLARE @piso NVARCHAR(50)
DECLARE @departamento NVARCHAR(50)
DECLARE @telefono NVARCHAR(100)
DECLARE @localidad NVARCHAR(50)
DECLARE @idProvincia NVARCHAR(4)
DECLARE @codigoPostal NVARCHAR(10)
DECLARE @documentoTipo NVARCHAR(4)
DECLARE @documentoNumero NVARCHAR(15)
DECLARE @condicionIva NVARCHAR(50)
DECLARE @idCondCpraVta NVARCHAR(4)
DECLARE @comentarios NVARCHAR(100)
DECLARE @idLista NVARCHAR(4)
DECLARE @vendedorCliente NVARCHAR(4)
DECLARE @clasePrecio INT

SET NOCOUNT ON

IF @pCliente = ''
    SET @pCliente = (SELECT VALOR FROM TA_CONFIGURACION WHERE CLAVE='CUENTACONSUMIDORFINAL')

SELECT @nombre = ISNULL(RAZON_SOCIAL,''),
       @calle = ISNULL(CALLE,'.'),
       @numero = ISNULL(NUMERO,'.'),
       @piso = ISNULL(PISO,''),
       @departamento = ISNULL(DEPARTAMENTO,''),
       @telefono = TELEFONO,
       @localidad = LOCALIDAD,
       @idProvincia = PROVINCIA,
       @codigoPostal = CPOSTAL,
       @documentoTipo = DOCUMENTO_TIPO,
       @documentoNumero = NUMERO_DOCUMENTO,
       @condicionIva = IVA,
       @idCondCpraVta = IDCOND_CPRA_VTA,
       @clasePrecio = TRY_CAST(CLASE AS INT),
       @idLista = IDLISTA,
       @vendedorCliente = IDVENDEDOR
FROM VT_CLIENTES
WHERE CODIGO = @pCliente

SET @domicilio = @calle + ' ' + @numero
IF (@piso <> '') SET @domicilio = @domicilio + ' ' + LTRIM(RTRIM(@piso)) + ' Piso '
IF (@departamento <> '') SET @domicilio = @domicilio + ' Dpto: ' + LTRIM(RTRIM(@departamento))
IF @condicionIva IS NULL SET @condicionIva = '   1'
IF @documentoTipo = 'None' SET @documentoTipo = '   1'

IF @pNumero IS NULL OR LTRIM(RTRIM(@pNumero)) = ''
BEGIN
    DECLARE @ultimoNumero INT
    SELECT @ultimoNumero = MAX(TRY_CAST(NUMERO AS INT)) 
    FROM V_MV_CPTE 
    WHERE TC = @pTC AND SUCURSAL = @pSucursal AND LETRA = @pLetra

    SET @ultimoNumero = ISNULL(@ultimoNumero, 0) + 1
    SET @pNumero = RIGHT('00000000' + CAST(@ultimoNumero AS NVARCHAR), 8)
END

SET @IdComprobante = @pSucursal + @pNumero + @pLetra

IF @clasePrecio IS NULL SET @clasePrecio = 1
IF @pVendedor = '' OR @pVendedor IS NULL
    SET @pVendedor = @vendedorCliente

SET @pVendedor = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pVendedor)),4)
SET @idLista = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@idLista)),4)

SET DATEFORMAT YMD
SET NOCOUNT ON

BEGIN TRANSACTION
BEGIN TRY

    INSERT INTO V_MV_CPTE
    (TC, IDCOMPROBANTE, IDCOMPLEMENTO,
     FECHA, FECHAESTFIN, FECHAESTINICIO, CUENTA,
     NOMBRE, DOMICILIO, TELEFONO,
     LOCALIDAD, IDPROVINCIA, CODIGOPOSTAL,
     DOCUMENTOTIPO, DOCUMENTONUMERO, CONDICIONIVA,
     IDCOND_CPRA_VTA, COMENTARIOS, IMPORTE, IMPORTE_S_IVA,
     MONEDA, IDVENDEDOR, CLASEPRECIO, UNEGOCIO_DESTINO, IdLista, IDMOTIVOCPRAVTA, IDDEPOSITO, AlicIva, ImporteIva, NEtoGravado, NetoNoGravado, Unegocio,
     FechaHora_Grabacion, SUCURSAL, NUMERO, LETRA)
    VALUES
    (
        @pTC, @IdComprobante, 0,
        @pFecha, @pFecha, @pFecha, @pCliente,
        @Nombre, @Domicilio, ISNULL(@Telefono,''),
        @Localidad, @idProvincia, LTRIM(@codigoPostal),
        @documentoTipo, LTRIM(@documentoNumero), @condicionIva,
        @idCondCpraVta, @pObservaciones, 0, 0,
        '   1', @pVendedor, @clasePrecio, '   1', @idLista,'   1','   1',21,0,0,0,'   1',
        GETDATE(),@pSucursal,@pNumero,@pLetra
    )

    COMMIT TRANSACTION

    SET @pResultado = 11
    SET @pMensaje = 'El Pedido se ha dado de alta con éxito'
    SET @pIdComprobanteRES = SCOPE_IDENTITY()

    INSERT INTO S_TA_UBICACIONES_VENDEDOR (lat, long, idvendedor, fechahora, idcomprobante)
    VALUES (@pLat, @pLng, @pVendedor, GETDATE(), @IdComprobante)

END TRY
BEGIN CATCH
    ROLLBACK TRANSACTION
    SET @pIdComprobanteRES = NULL
    SET @pResultado = ERROR_NUMBER()
    SET @pMensaje = ERROR_MESSAGE()
END CATCH

	

GO

/****** Object:  StoredProcedure [dbo].[sp_web_AltaArticulo]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[sp_web_AltaArticulo]
	@pCodigoArticulo				NVARCHAR(25) = NULL,
	@pCodigoBarras					NVARCHAR(20) = NULL,
	@pDescripcion					NVARCHAR(50) = NULL,
	@pPrecio						MONEY = 0,
	@pCosto							MONEY = 0,
	@pAlicIva						NVARCHAR(4) = NULL,
	@pExento						BIT = 0,
	@pBalanza						BIT = 0,
	@pUd							NVARCHAR(4) = NULL,
	@pRubro							NVARCHAR(4) = NULL,
	@pMarca							NVARCHAR(4) = NULL,
	@pIdArticulo					NVARCHAR(25) = NULL OUTPUT
AS

DECLARE @esRetail NVARCHAR(2)
DECLARE @clasePrecioProv NVARCHAR(1)
DECLARE @clasePrecio NVARCHAR(1)
DECLARE @esModificacion BIT
DECLARE @ultimoCodigoArticulo NVARCHAR(25)
DECLARE @SQL NVARCHAR(MAX)
DECLARE @ErrorSave INT
DECLARE @ErrorMensaje as nvarchar(250)

SET NOCOUNT ON

SET @esModificacion = 0

IF @pCodigoArticulo <> ''
	SET @pIdArticulo = @pCodigoArticulo
ELSE
	BEGIN
		IF @pCodigoBarras <> ''
			--Busco existencia por codigo de barras
			SET @pIdArticulo = (SELECT IDARTICULO FROM V_MA_ARTICULOS WHERE CODIGOBARRA = @pCodigoBarras)
		ELSE
			--Busco existencia por descripcion
			SET @pIdArticulo = (SELECT IDARTICULO FROM V_MA_ARTICULOS WHERE DESCRIPCION = @pDescripcion)
	END

IF @pIdArticulo <> '' SET @esModificacion = 1

SET @esRetail = (SELECT VALOR FROM TA_CONFIGURACION WHERE CLAVE = 'RETAIL')

IF @esRetail = 'SI'
	SET @clasePrecioProv = (SELECT ISNULL(CLAVE,'1') FROM TA_CONFIGURACION WHERE CLAVE = 'ClasePrecioListaProv')
ELSE
	SET @clasePrecioProv = ''

SET @clasePrecio = (SELECT ISNULL(VALOR,'1') FROM TA_CONFIGURACION WHERE CLAVE = 'ClasePrecioVenta')
IF @clasePrecio = '' SET @clasePrecio = '1'


IF @pUd <> '' 
	SET @pUd = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pUd)),4)
ELSE
	SET @pUd = (SELECT TOP 1 IDUNIDAD FROM V_TA_UNIDAD)


IF @pMarca <> '' 
	SET @pMarca = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pMarca)),4)
ELSE
	SET @pMarca  = null


IF @pRubro <> '' 
	SET @pRubro = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pRubro)),4)
ELSE
	SET @pRubro = null

--Asigno codigo de articulo si es alta
IF @esModificacion = 0
	BEGIN
		SET @ultimoCodigoArticulo = (SELECT CAST(MAX(IDARTICULO) as NUMERIC) +1 FROM V_MA_ARTICULOS WHERE SUBSTRING(IDARTICULO,1,1) = ' ' AND CHARINDEX('e',IDARTICULO,1) = 0)
	
		IF @ultimoCodigoArticulo IS NULL OR @ultimoCodigoArticulo = '' 
			SET @pIdArticulo = '1'
		ELSE
			--PRINT('ACA ' + @ultimoCodigoArticulo)
			SET @pIdArticulo = convert(varchar,convert(NUMERIC, @ultimoCodigoArticulo))
			--PRINT('ACA2 ' + @pIdArticulo)
			--PRINT('ACA2 ' + convert(varchar,convert(NUMERIC,@pIdArticulo)))
	END


--print(@pIdArticulo)
SET @pIdArticulo = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pIdArticulo)),25)

SET NOCOUNT ON
BEGIN TRANSACTION
--PRINT(@esModificacion)
IF @esModificacion = 0
	BEGIN
		INSERT INTO V_MA_ARTICULOS (IDARTICULO,DESDETRIGGER,CODIGOBARRA,DESCRIPCION,IDUNIDAD,USASERIE,USALOTE,EXENTO,SUSPENDIDO,PESABLE,IDTIPO,IDRUBRO,
		FHULTIMOCOSTO,FHALTA,COSTO ,CUENTAPROVEEDOR,CODIGOARTPROVEEDOR,RUTAIMAGEN,TASAIVA)
		VALUES (@pIdArticulo,0,@pCodigoBarras,@pDescripcion,@pUd,0,0,@pExento,0,@pBalanza,@pMarca,@pRubro,GETDATE(),GETDATE(),@pCosto,'','','',@pAlicIva)
		
		SET @SQL = 'UPDATE V_MA_ARTICULOS SET DESDETRIGGER = 0,PRECIO' + @clasePrecio + ' = ' + convert(varchar,convert(decimal(15,2),@pPrecio)) + ' WHERE IDARTICULO=''' +  @pIdArticulo + ''''

		IF @esRetail = 'SI' SET @SQL = @SQL + 'UPDATE V_MA_ARTICULOS SET DESDETRIGGER = 0,PRECIO' + @clasePrecioProv + ' = ' + convert(varchar,convert(decimal(15,2),@pCosto)) + ' WHERE IDARTICULO=''' +  @pIdArticulo + ''''
		EXEC(@SQL)
	END
ELSE
	BEGIN
		UPDATE V_MA_ARTICULOS SET DesdeTrigger=0,CODIGOBARRA=@pCodigoBarras,DESCRIPCION=@pDescripcion,IDUNIDAD=@pUd,EXENTO=@pExento,Pesable=@pBalanza,IDTIPO=@pMarca,IDRUBRO=@pRubro,Costo=@pCosto,TasaIva=@pAlicIva
		WHERE IDARTICULO=@pIdArticulo

		SET @SQL = 'UPDATE V_MA_ARTICULOS SET DESDETRIGGER = 0,PRECIO' + @clasePrecio + ' = ' + convert(varchar,convert(decimal(15,2),@pPrecio)) + ' WHERE IDARTICULO=''' +  @pIdArticulo + ''''

		IF @esRetail = 'SI' SET @SQL = @SQL + 'UPDATE V_MA_ARTICULOS SET DESDETRIGGER = 0,PRECIO' + @clasePrecioProv + ' = ' + convert(varchar,convert(decimal(15,2),@pCosto)) + ' WHERE IDARTICULO=''' +  @pIdArticulo + ''''
		EXEC(@SQL)
	END
	
SET @ErrorSave = @@ERROR
IF (@ErrorSave<>0) GOTO TratarError

COMMIT TRANSACTION

TratarError:
IF @@ERROR<>0 
	BEGIN
	ROLLBACK TRANSACTION
END
GO

/****** Object:  StoredProcedure [dbo].[sp_web_altaCliente]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO







CREATE PROCEDURE [dbo].[sp_web_altaCliente]
	@pCodigo					NVARCHAR(13) = null,
	@pNombre					nvarchar(50),
	@pEmail						nvarchar(250) = null,
	@pCalle	     				nvarchar(50) = null,
	@pNumero					nvarchar(6) = null,
	@pLocalidad                 nvarchar(50) = null,
	@pTel 						nvarchar(50) = null,
	@pContacto 					nvarchar(70) = null,
	@pCuit	 					nvarchar(13) = null,
	@pObs 						nvarchar(200) = null,
	@pVendedor					nvarchar(4) = null,
	@pIva						nvarchar(4) = null,
	@pCp						nvarchar(4) = null,
	@pTipoDoc					nvarchar(4) = null,
	@pCodigoCuenta				varchar(9) = NULL OUTPUT
AS

SET NOCOUNT ON
DECLARE @CUENTA NVARCHAR(9)

IF @pVendedor <> ''
	SET @pVendedor = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pVendedor)),4)

IF @pCodigo = ''
	BEGIN
		SET @CUENTA = (SELECT MAX(CODIGO) +1 FROM VT_CLIENTES with(nolock) WHERE CODIGO LIKE '11201%')
		IF @CUENTA = '' OR @CUENTA IS NULL SET @CUENTA = '112010001'
	END
ELSE
	SET @CUENTA = @pCodigo

IF @pIva = '' SET @pIva = '   1'
IF @pTipoDoc = '' SET @pTipoDoc = '   1'

SET @pIva = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pIva)),4)
SET @pTipoDoc = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pTipoDoc)),4)


SET NOCOUNT ON
BEGIN TRANSACTION
BEGIN
	
	IF @pCodigo = ''
		BEGIN
			INSERT INTO MA_CUENTAS([CODIGO],[DV],[DESCRIPCION],[TITULO],[AJUSTE],[INDICE],[BLOQUEO],[MANUAL],[MANUAL_HABER],[FechaHora_Grabacion],[FechaHora_Modificacion],[Libro_Iva_Compras],[Libro_Iva_Ventas],[Bienes],[Codigo_Deprec_Acumulada],[Codigo_Deprec_Ejercicio],[Dada_De_Baja],[TipoVista],[PideVencimiento],[CuentaPrincipal],[CajaYBanco],[CodigoOpcional],[MedioDePago],[Moneda],[NoPideDatosTarjeta],[Terceros],[CodTarjeta_ConcAuto],[usaCCostos],[CC_DIST]) 
			VALUES(@CUENTA,Null,@pNombre,0,0,'0',0,'',Null,Null,Null,0,1,0,Null,Null,0,'CL',1,'',0,'',Null,Null,0,0,Null,0,Null)

			INSERT INTO MA_CUENTASADIC([CODIGO],[CONTACTO],[CALLE],[NUMERO],[PISO],[DEPARTAMENTO],[CPOSTAL],
			[LOCALIDAD],[PROVINCIA],[PAIS],[TELEFONO],[FAX],[MAIL],[DOCUMENTO_TIPO],[NUMERO_DOCUMENTO],[IVA],
			[OBSERVACIONES],[Limite_Credito],[idCond_Cpra_Vta],[IDCategoria],[FechaHora_Grabacion],[FechaHora_Modificacion],
			[IdLista],[Clase],[IdVendedor],[IdMotivoVta],[IdMotivoCpra],[ExentoIvaServicios],[ExentoIvaArticulos],
			[ExentoIVAOtros],[Descuento],[RETIVA_IdRetencion],[RETIBR_IdRetencion],[RETGAN_IdRetencion],[LugarEntrega],
			[CALLE_FIS],[NUMERO_FIS],[PISO_FIS],[DEPARTAMENTO_FIS],[CPOSTAL_FIS],[LOCALIDAD_FIS],[PROVINCIA_FIS],
			[PAIS_FIS],[TELEFONO_FIS],[FAX_FIS],[CodigoImputacion],[Consignacion],[ZONA],[RETIVA_NROINS],[RETIBR_NROINS],
			[RETGAN_NROINS],[Clave],[IdVendedor1],[IdVendedor2],[IdVendedor3],[IdVendedor4],[IdVendedor5],[Limite_Credito1],
			[Limite_Credito2],[Limite_Credito3],[Limite_Credito4],[Limite_Credito5],[DatosPago],[WEB],[FCC_Sin_OC],[Dto1],
			[Dto2],[Dto3],[OCCambiaCosto],[idCond_Cpra_Vta_Vdor1],[idCond_Cpra_Vta_Vdor2],[idCond_Cpra_Vta_Vdor3],[idCond_Cpra_Vta_Vdor4],
			[idCond_Cpra_Vta_Vdor5],[EmiteSobresPorOP],[ProveedorLocal],[ProveedorCompartido],[idDepositoEntregaOC],[FhVtoExento],
			[RETIBR_IdRetencionOnLine],[SIAP_IVA_REG_RET_PERC],[IdListaRMTRF],[Clasificacion],[RETSUSS_IdRetencion]) 
			VALUES
			(@CUENTA,@pContacto,@pCalle,@pNumero,Null,Null,@pCp,@pLocalidad,'   1','   1',@pTel,Null,@pEmail,@pTipoDoc,@pCuit,
			@pIva,@pObs,0,'   1',Null,GETDATE(),Null,Null,'1',@pVendedor,'   1',Null,0,0,0,0,Null,Null,Null,Null,
			Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,'',0,Null,Null,Null,Null,Null,Null,Null,Null,Null,
			Null,0,0,0,0,0,Null,Null,0,0,0,0,0,Null,Null,Null,Null,Null,0,0,0,Null,Null,Null,Null,Null,Null,Null)
		END
	ELSE
		--UPDATE
		BEGIN
			UPDATE MA_CUENTAS SET DESCRIPCION=@pNombre WHERE CODIGO=@CUENTA

			UPDATE MA_CUENTASADIC SET CONTACTO=@pContacto, CALLE = @pCalle,NUMERO=@pNumero,CPOSTAL=@pCp,LOCALIDAD=@pLocalidad,TELEFONO=@pTel,
			MAIL=@pEmail, DOCUMENTO_TIPO=@pTipoDoc,IVA=@pIva,NUMERO_DOCUMENTO=@pCuit,OBSERVACIONES=@pObs,IdVendedor=@pVendedor
			WHERE CODIGO = @CUENTA
		END
	IF @@ERROR <> 0 OR @@ROWCOUNT <> 1
					BEGIN
		ROLLBACK TRANSACTION

		SET @pCodigoCuenta = NULL
		RETURN
	END
	COMMIT TRANSACTION
	SET @pCodigoCuenta = @CUENTA

END


GO

/****** Object:  StoredProcedure [dbo].[sp_web_AltaTabla]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[sp_web_AltaTabla]
	@pTabla							nvarchar(25) = null,
	@pCodigo						 nvarchar(4) = null,
	@pDescripcion	     			nvarchar(50) = null,
	@pCodigoRespuesta				 nvarchar(4) = NULL OUTPUT,
	@pResultado						int = null OUTPUT
AS

DECLARE @campoCodigo NVARCHAR(15)
DECLARE @campoDescripcion NVARCHAR(15)
DECLARE @SQL NVARCHAR(MAX)

IF @pTabla = 'V_TA_UNIDAD'
	BEGIN
		SET @campoCodigo = 'idunidad'
		SET @campoDescripcion = 'descripcion'

		IF @pCodigo = ''
			SELECT @pCodigo=isnull(MAX(IDUNIDAD),0) + 1 FROM V_TA_Unidad WHERE ltrim(IdUnidad) like '[0-9]%' and ltrim(IdUnidad) NOT LIKE '%[a-z]%'
	END

IF @pTabla = 'V_TA_RUBROS'
	BEGIN
		SET @campoCodigo = 'idrubro'
		SET @campoDescripcion = 'descripcion'

		IF @pCodigo = ''
			SELECT @pCodigo=isnull(MAX(IdRubro),0) + 1 FROM V_TA_Rubros WHERE ltrim(IdRubro) like '[0-9]%' and ltrim(IdRubro) NOT LIKE '%[a-z]%'
	END

IF @pTabla = 'V_TA_TipoArticulo'
	BEGIN
		SET @campoCodigo = 'idtipo'
		SET @campoDescripcion = 'descripcion'
	
		IF @pCodigo = ''
			SELECT @pCodigo=isnull(MAX(IdTipo),0) + 1 FROM V_TA_TipoArticulo WHERE ltrim(IdTipo) like '[0-9]%' and ltrim(IdTipo) NOT LIKE '%[a-z]%'
	END

IF @pCodigo = '' SET @pCodigo = '1'
SET @pCodigo = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pCodigo)),4)


SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY
	--SET @SQL = 'asd'
	SET @SQL ='INSERT INTO ' + @pTabla + ' ('+@campoCodigo+','+@campoDescripcion+') values ('''+@pCodigo+''','''+@pDescripcion+''')'
	EXEC(@SQL)
	

	IF @@ERROR <> 0 OR @@ROWCOUNT <> 1
		BEGIN
			ROLLBACK TRANSACTION
			SET @pResultado = 21
			SET @pCodigoRespuesta = NULL
			RETURN
		END
	ELSE
		BEGIN
			COMMIT TRANSACTION
			SET @pResultado = 11
			SET @pCodigoRespuesta = @pCodigo

		END
END TRY
BEGIN CATCH
	ROLLBACK TRANSACTION
	SET @pResultado = 21
	SET @pCodigoRespuesta = NULL
END CATCH
	

GO

/****** Object:  StoredProcedure [dbo].[sp_web_AltaTarea]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO











CREATE PROCEDURE [dbo].[sp_web_AltaTarea]
	@pCliente						 nvarchar(15) = NULL,
	@pMotivo						 nvarchar(4) = NULL,
	@pDetalle						 ntext = NULL,
	@Usuario                         nvarchar(50) = null,
	@eMail                           nvarchar(50) = null,
	@Prioridad						 int ,
	@pTitulo						 nvarchar(150) = null,
	@pIdCpte						 NVARCHAR(13) = NULL OUTPUT
AS
DECLARE @Tc NVARCHAR(4)
DECLARE @IdComprobante NVARCHAR(13)
DECLARE @nombre NVARCHAR(50)
DECLARE @domicilio NVARCHAR(50)
DECLARE @calle NVARCHAR(50)
DECLARE @numero NVARCHAR(50)
DECLARE @piso NVARCHAR(50)
DECLARE @departamento NVARCHAR(50)
DECLARE @telefono NVARCHAR(100)
DECLARE @localidad NVARCHAR(50)
DECLARE @idProvincia NVARCHAR(4)
DECLARE @codigoPostal NVARCHAR(10)
DECLARE @documentoTipo NVARCHAR(4)
DECLARE @documentoNumero NVARCHAR(13)
DECLARE @condicionIva NVARCHAR(50)
DECLARE @idCondCpraVta NVARCHAR(4)
DECLARE @comentarios NVARCHAR(100)
DECLARE @clasePrecio int
DECLARE @idlista NVARCHAR(4)
DECLARE @FechaHoraGrabacion DATETIME
DECLARE @pFecha DATETIME
DECLARE @pDescTarea nvarchar(250)
DECLARE @ErrorSave INT
DECLARE @ErrorMensaje as nvarchar(250)
SET NOCOUNT ON

SET @Tc = 'OT'

SELECT @nombre =  RAZON_SOCIAL    ,
	@calle = ISNULL(CALLE,'.'),
	@numero = ISNULL(NUMERO,'.'),
	@piso = ISNULL(PISO,''),
	@departamento = ISNULL(DEPARTAMENTO,''),
	@telefono = TELEFONO,
	@localidad = LOCALIDAD,
	@idProvincia = PROVINCIA,
	@codigoPostal = CPOSTAL,
	@documentoTipo = DOCUMENTO_TIPO,
	@documentoNumero = NUMERO_DOCUMENTO,
	@condicionIva = IVA,
	@idCondCpraVta = IDCOND_CPRA_VTA,
	@clasePrecio = CLASE,
	@comentarios = OBSERVACIONES,
	@idlista = IdLista
FROM VT_CLIENTES
WHERE CODIGO = @pCliente

if @nombre = '' or @nombre is null  
	BEGIN
	SET @ErrorMensaje = 'NO EXISTE EL CLIENTE ' + @pCliente
	SET @pIdCpte = 'ERROR'
	RAISERROR (@ErrorMensaje, 16, 1)
	RETURN 0
END

SET @domicilio = @calle + ' ' + @numero
IF (@piso <> '') SET @domicilio= @domicilio+ ' ' + LTRIM(RTRIM(@piso)) + ' Piso '
IF (@departamento <> '') SET @domicilio= @domicilio+ ' Dpto: ' +  LTRIM(RTRIM(@departamento))
IF (@condicionIva=NULL) SET @condicionIva = '   1'

SET @idComprobante = dbo.FN_OBTIENE_PROXIMO_NUMERO_CPTE (@Tc,'9999','X')

IF (@clasePrecio IS NULL) OR (@clasePrecio = NULL)
	SET @clasePrecio = 1

SET @FechaHoraGrabacion  = GETDATE()
SET @pFecha = CONVERT(VARCHAR,@FechaHoraGrabacion,103)
SET @pDescTarea = (SELECT Descripcion
from v_ta_tareas
where IdTarea=@pMotivo)
if @pTitulo is null set @pTitulo =  @pDescTarea

SET DATEFORMAT YMD



SET NOCOUNT ON
BEGIN TRANSACTION

IF NOT EXISTS (SELECT IDTECNICO
FROM V_TA_Tecnicos
WHERE IdTecnico='9999')
		INSERT INTO V_TA_Tecnicos
	(IdTecnico,Nombre,Cargo)
VALUES('9999', 'Tecnico Cliente', '.')

INSERT INTO V_MV_CPTE
	(TC,IDCOMPROBANTE,IDCOMPLEMENTO,
	FECHA,FECHAESTFIN,CUENTA,
	NOMBRE,DOMICILIO,TELEFONO,
	LOCALIDAD,IDPROVINCIA,CODIGOPOSTAL,
	DOCUMENTOTIPO,DOCUMENTONUMERO,CONDICIONIVA,
	IDCOND_CPRA_VTA,COMENTARIOS,IMPORTE,IMPORTE_S_IVA,
	MONEDA,IDTECNICO ,CLASEPRECIO,IdLista,FechaHora_Grabacion, SOLICITANTE,Usuario,Unegocio,UNEGOCIO_DESTINO, FINALIZADA,ANULADA,APROBADO,
	ExentoIVAServicios,ExentoIVAArticulos,ExentoIVAOtros,Complementario,Impreso)
VALUES
	(
		@Tc, @IdComprobante, 0,
		@pFecha, @pFecha, @pCliente,
		@Nombre, @Domicilio, @Telefono,
		@Localidad, @idProvincia, @codigoPostal,
		@documentoTipo, @documentoNumero, @condicionIva,
		@idCondCpraVta, @comentarios, 0, 0,
		'   1', '9999', @clasePrecio, @idlista, @FechaHoraGrabacion, @eMail, @Usuario, '   1', '   1', 0, 0, 0, 0, 0, 0, 0, 0)

SET @ErrorSave = @@ERROR
IF (@ErrorSave<>0) GOTO TratarError

INSERT INTO V_MV_CpteTareas
	(
	TC,IDCOMPROBANTE,IDCOMPLEMENTO,IDTAREA,DESCRIPCION,
	HORAS,DescripcionAdicional,FechaEstInicio,IdTecnico,
	Prioridad,Usuario,SECUENCIA,FHEntrega,VALORHORA,VALORHORA_S_IVA,EXENTO)
VALUES
	(@Tc, @IdComprobante, 0, @pMotivo, @pTitulo, 0, @pDetalle,
		@FechaHoraGrabacion, '9999', @Prioridad, @Usuario, 1, @FechaHoraGrabacion, 0, 0, 0)

SET @ErrorSave = @@ERROR
IF (@ErrorSave<>0) GOTO TratarError



DECLARE @idDIario INT 

SET @idDIario = (SELECT MAX(IDDIARIO) +1 FROM V_MV_Diarios)
INSERT INTO V_MV_Diarios
	(IDDiario,TC,IDCOMPROBANTE,IDCOMPLEMENTO,IDTAREA,DESCRIPCION,IdTecnico,FECHA,FECHAINICIO,FECHAFIN,MINUTOS,OBSERVACIONES,
	MATRICULA,CUENTA,AUTORIZADOPOR,NUMEROAUTORIZACION,Prioridad,Usuario,IdTecnico2,FHPresentacion,FHEmision,NroExp,FHEntrega,KM,HS)
VALUES
	(@idDIario,@Tc, @IdComprobante, 0, dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pMotivo)),4), @pTitulo,'9999', @FechaHoraGrabacion,@FechaHoraGrabacion,Null,0,
		@pDetalle,'', @pCliente,Null,NUll,2, @USUARIO,'',Null,Null,Null,Null,0,0)

SET @ErrorSave = @@ERROR
IF (@ErrorSave<>0) GOTO TratarError

UPDATE V_TA_Cpte SET X_ULTIMO_NRO=SUBSTRING(@IdComprobante,5,8)+1 WHERE CODIGO=@Tc and X_SUC_DEFAULT = SUBSTRING(@IdComprobante,1,4)


SET @ErrorSave = @@ERROR
IF (@ErrorSave<>0) GOTO TratarError

COMMIT TRANSACTION

SET @pIdCpte = @IdComprobante

TratarError:
IF @@ERROR<>0 
	BEGIN
	SET @pIdCpte = ''
	ROLLBACK TRANSACTION
END
GO










CREATE PROCEDURE [dbo].[sp_web_CalificarRespuesta]
	@pIdComprobante			nvarchar(13) = null,
	@pCalificacion			Int,
	@pObservaciones			ntext = NULL
AS
DECLARE @FechaHoraGrabacion DATETIME
DECLARE @ErrorSave INT
DECLARE @ErrorMensaje as nvarchar(250)
SET NOCOUNT ON
SET @FechaHoraGrabacion  = GETDATE()
BEGIN TRANSACTION
BEGIN
	UPDATE V_MV_CPTE SET Devoluciones = @pCalificacion, OBSERVACIONES = @pObservaciones where TC = 'OT' and IDCOMPROBANTE = @pIdComprobante
	IF @@ERROR <> 0 OR @@ROWCOUNT <> 1
			BEGIN
		ROLLBACK TRANSACTION
		RAISERROR ('Error al actualizar V_MV_CPTE', 16, 1)
		RETURN @ERRORSAVE
	END

	COMMIT TRANSACTION
	SELECT devoluciones, observaciones
	FROM V_MV_CPTE
	WHERE TC = 'OT' and IDCOMPROBANTE = @pIdComprobante
END

GO

/****** Object:  StoredProcedure [dbo].[sp_web_CpteInsumos]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO









CREATE PROCEDURE [dbo].[sp_web_CpteInsumos]
	@pIdCpte						 INT = null,
	@pIdArticulo					 NVARCHAR(25),
	@pCantidad						 FLOAT,
	@pImporteUnitario				 MONEY,
	@pPorcDescuento                  VARCHAR(10),
	@pResultado 					 SMALLINT = NULL OUTPUT,
	@pMensaje 						 VARCHAR(255) = NULL OUTPUT,
	@pIdVMVCpteInsumosRES			 INT = NULL OUTPUT
AS
SET NOCOUNT ON
DECLARE @pPorcDescuentoNumero FLOAT
DECLARE @tc NVARCHAR(4)
DECLARE @idComprobante NVARCHAR(13)
DECLARE @idComplemento INT
DECLARE @tmpConfigIVA NVARCHAR(2)
DECLARE @cfgMaestroArticuloCostoConIva NVARCHAR(2)
DECLARE @idlista NVARCHAR(4)
DECLARE @descripcion NVARCHAR(50)
DECLARE @idUnidad NVARCHAR(4)
DECLARE @importe MONEY
DECLARE @importeCiva MONEY
DECLARE @idMoneda NVARCHAR(4)
DECLARE @total MONEY
DECLARE @exento BIT
DECLARE @clasePrecio NVARCHAR(4)
DECLARE @alicIva FLOAT
DECLARE @porcDto FLOAT
DECLARE @importeDto MONEY
DECLARE @importeSinDto MONEY
DECLARE @unidadBase NVARCHAR(4)
DECLARE @cantKG FLOAT
DECLARE @pedidosPreparados NVARCHAR(2)
DECLARE @tmpConfig NVARCHAR(50)
DECLARE @condicionIva NVARCHAR(4)
DECLARE @err INT
DECLARE @IdCliente NVARCHAR(15)
DECLARE @PorcentajeDescuento FLOAT
DECLARE @Costo FLOAT
DECLARE @totalInsumo MONEY
DECLARE @cotiz FLOAT
DECLARE @Presentacion NVARCHAR(50)

IF @pPorcDescuento = 'NaN' SET @pPorcDescuento = '0'
SET @pPorcDescuentoNumero = CAST(@pPorcDescuento as float)
--a-29-02-2024 El precio lo grabo sin descuento, el dto va en un campo aparte
IF @pImporteUnitario is null SET @pImporteUnitario = 0
 set @importeSinDto = @pImporteUnitario 
if @pPorcDescuentoNumero > 0
begin

   set @pImporteUnitario =(@pImporteUnitario / (1-(@pPorcDescuentoNumero/100)) )

   set @importeDto = (@pImporteUnitario  - @importeSinDto ) * @pCantidad
end
 
SELECT @tc = TC, @idComprobante = IDCOMPROBANTE,
	@idComplemento = IDCOMPLEMENTO,
	@clasePrecio = CLASEPRECIO,
	@condicionIva = CONDICIONIVA,
	@IdCliente = CUENTA,
	@idlista = IdLista
FROM V_MV_CPTE
WHERE ID = @pIdCpte

SELECT @pedidosPreparados = VALOR FROM TA_CONFIGURACION WHERE CLAVE='V_SoloPedidosPreparados'

SET @pIdArticulo = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pIdArticulo)),25)

SELECT @descripcion = DESCRIPCION, @unidadBase = IDUNIDAD, @idUnidad = UD_TTE, @alicIva = TASAIVA, @exento = EXENTO, @idMoneda = MONEDA, @costo = Costo, @Presentacion = Presentacion 
FROM V_MA_ARTICULOS
WHERE LTRIM(IDARTICULO) = LTRIM(@pIdArticulo)

IF ((@alicIva = NULL) OR (@alicIva IS NULL) OR (@alicIva = 0))
	BEGIN
		SET @tmpConfig = dbo.FN_OBTIENE_VALOR_CONFIGURACION('PIVA','21')
		SET @alicIva = CAST(@tmpConfig AS FLOAT )
	END
	
IF (@condicionIva = NULL) OR (@condicionIva IS NULL) SET @condicionIva = '   1'
IF (@exento = NULL) OR (@exento IS NULL) SET @exento = 0

SET @tmpConfigIVA = dbo.FN_OBTIENE_VALOR_CONFIGURACION('MaestroArticuloConIVA','NO')
SET @cfgMaestroArticuloCostoConIva =  dbo.FN_OBTIENE_VALOR_CONFIGURACION('MaestroArticuloCostoConIVA','NO')

IF @cfgMaestroArticuloCostoConIva = 'SI' AND (@exento = 0 or @exento ='0' OR @exento is null)
	SET @Costo = dbo.FN_PRECIO_SIN_IVA(@Costo,@alicIva)

IF rtrim(ltrim(@idlista)) <>''
	BEGIN
		--SET @pImporteUnitario = dbo.FN_PRECIO_LISTA(@pIdArticulo,@idlista,@clasePrecio)
		--SET @importe = @pImporteUnitario
		IF @tmpConfigIVA = 'SI' 
			IF @exento = 0
				BEGIN
					SET @pImporteUnitario =  dbo.FN_PRECIO_SIN_IVA(@pImporteUnitario,@alicIva)
					SET @importe = @pImporteUnitario
				END
            else
		        BEGIN
					SET @importe = @pImporteUnitario
				END
		ELSE
			BEGIN
			    SET @importe = @pImporteUnitario
				 
			END
	END
ELSE
	BEGIN
	IF @tmpConfigIVA = 'SI' 
		IF @exento=0
			BEGIN
				SET @pImporteUnitario = dbo.FN_PRECIO_SIN_IVA(@pImporteUnitario,@alicIva)
				SET @importe =  dbo.FN_PRECIO_CON_IVA(@pImporteUnitario,@alicIva)--@pImporteUnitario
			END
		ELSE 
			BEGIN
				SET @importe = @pImporteUnitario
				SET @pImporteUnitario =  dbo.FN_PRECIO_SIN_IVA(@pImporteUnitario,@alicIva)
			END
	ELSE
		BEGIN
			IF @clasePrecio = 2
				SET @tmpConfigIVA =  dbo.FN_OBTIENE_VALOR_CONFIGURACION('Clase2ConIVA','NO')
			
			if @tmpConfigIVA = 'SI'
				if @exento=0
					BEGIN
						SET @pImporteUnitario =  dbo.FN_PRECIO_SIN_IVA(@pImporteUnitario,@alicIva)
						SET @importe = dbo.FN_PRECIO_CON_IVA(@pImporteUnitario,@alicIva)
					END
				ELSE
					BEGIN
						SET @importe = @pImporteUnitario
						SET @pImporteUnitario =  dbo.FN_PRECIO_SIN_IVA(@pImporteUnitario,@alicIva)
					END
			ELSE
					BEGIN
						SET @importe = @pImporteUnitario
					END
		END
	END

IF @pImporteUnitario is null SET @pImporteUnitario = 1
 
SET @total = (@importe * @pCantidad) - @importeDto --a-29-02-2024 le resto el dto


if @pCantidad=0 SET @pCantidad=1

DECLARE @coeficiente FLOAT
DECLARE @cantidadUD FLOAT

SELECT @coeficiente=ISNULL(COEFICIENTE,1) FROM S_TA_EQUIV
WHERE IDUNIDAD=@idUnidad AND IDUNIDAD_EQUIV=@unidadBase AND LTRIM(IDARTICULO)= LTRIM(@pIdArticulo)

SET @Costo = @Costo * @coeficiente
--a-29-02-2024
if ltrim(@idMoneda) <> '1' 
   begin
   --obtiene cotizacion y multiplica el costo
	if ltrim(@idMoneda) = '2' SET @cotiz = ISNULL((SELECT TOP 1 ISNULL(MONEDA2,1) FROM TA_COTIZACION ORDER BY FECHA_HORA DESC),1) --ISNULL((SELECT ISNULL(MONEDA2,'1') FROM TA_COTIZACION WHERE FECHA_HORA = CONVERT(date,GETDATE())),'1')
	if ltrim(@idMoneda) = '3' SET @cotiz = ISNULL((SELECT TOP 1 ISNULL(MONEDA3,1) FROM TA_COTIZACION ORDER BY FECHA_HORA DESC),1) -- ISNULL((SELECT ISNULL(MONEDA3,'1') FROM TA_COTIZACION WHERE FECHA_HORA = CONVERT(date,GETDATE())),'1')
	if ltrim(@idMoneda) = '4' SET @cotiz = ISNULL((SELECT TOP 1 ISNULL(MONEDA4,1) FROM TA_COTIZACION ORDER BY FECHA_HORA DESC),1) --ISNULL((SELECT ISNULL(MONEDA4,'1') FROM TA_COTIZACION WHERE FECHA_HORA = CONVERT(date,GETDATE())),'1')
	if ltrim(@idMoneda) = '5' SET @cotiz = ISNULL((SELECT TOP 1 ISNULL(MONEDA5,1) FROM TA_COTIZACION ORDER BY FECHA_HORA DESC),1) --ISNULL((SELECT ISNULL(MONEDA5,'1') FROM TA_COTIZACION WHERE FECHA_HORA = CONVERT(date,GETDATE())),'1')
	
	SET @Costo = @Costo * @cotiz 
   end

SET @cantKG = @pCantidad * @coeficiente
SET @cantidadUD = @cantKG / @pCantidad

IF @tc = 'NP' 
	SET @totalInsumo = @total --@pImporteUnitario * @pCantidad --SI ES NP ES EL TOTAL SIN IVA
ELSE
	SET @totalInsumo = @total

SET DATEFORMAT YMD
SET NOCOUNT ON
BEGIN TRANSACTION
BEGIN TRY
	INSERT INTO V_MV_CPTEINSUMOS
	(TC,IDCOMPROBANTE,IDCOMPLEMENTO,CLASEPRECIO,
	IDARTICULO,DESCRIPCION,IDUNIDAD,ALICIVA,EXENTO,
	CANTIDADUD,CANTIDAD,
	IMPORTE_S_IVA,
	IMPORTE,
	PORCDTO,
	IMPORTEDTO,
	TOTAL,
	TOTALFINAL,
	COSTO,
	IdLista,IDUNIDADBASE,EQUIV_UDBASE,CANT_BL,CANT_KG, PRESENTACION )
	VALUES
	(
		@tc, @idComprobante, 0, @clasePrecio,
		@pIdArticulo, @descripcion, @idUnidad, @alicIva, @exento,
		@cantidadUD, @pCantidad,
		@pImporteUnitario ,
		@importe ,
		@pPorcDescuento,
		@importeDto,
		@totalInsumo,
		@total,
		@Costo,
		@idlista, @unidadBase, @pCantidad, 1, @cantKG, @Presentacion 
				)
		IF @@error <> 0 
			BEGIN
				ROLLBACK TRANSACTION
				SET @pIdVMVCpteInsumosRES = NULL
				SET @pResultado = 21
				SET @pMensaje = 'No pudo darse de alta EL PEDIDO correctamente'
				RETURN
			END
		ELSE
			BEGIN
				COMMIT TRANSACTION
	
				DECLARE @IMPORTE_C_IVA FLOAT,@IMPORTE_IVA FLOAT,@NETO_GRAVADO FLOAT

				SET @tmpConfigIVA = dbo.FN_OBTIENE_VALOR_CONFIGURACION('MaestroArticuloConIVA','NO')
				IF @tmpConfigIVA = 'SI' 
					IF @exento=1
						BEGIN
							SET @NETO_GRAVADO = dbo.FN_PRECIO_SIN_IVA(@importe, @alicIva) *@pCantidad
							SET @IMPORTE_IVA = 0
						END
					ELSE 
						BEGIN
							SET @NETO_GRAVADO = @pImporteUnitario * @pCantidad
							SET @IMPORTE_IVA = (@importe * @pCantidad) - @NETO_GRAVADO
						END
				ELSE
					BEGIN
						IF @clasePrecio = 2
							SET @tmpConfigIVA =  dbo.FN_OBTIENE_VALOR_CONFIGURACION('Clase2ConIVA','NO')
			
						if @tmpConfigIVA = 'SI'
							if @exento=1
								BEGIN
									SET @NETO_GRAVADO = dbo.FN_PRECIO_SIN_IVA(@importe, @alicIva) *@pCantidad
									SET @IMPORTE_IVA = 0
								END
							ELSE
								BEGIN
									SET @NETO_GRAVADO = @pImporteUnitario *@pCantidad
									SET @IMPORTE_IVA = (@importe * @pCantidad) - @NETO_GRAVADO 
								END
						ELSE
							SET @NETO_GRAVADO = @importe *@pCantidad
					END
				

				--SET @NETO_GRAVADO = @importe*@pCantidad
				IF @TC = 'FP' OR @tc = 'NP'
					SET @IMPORTE_C_IVA = @NETO_GRAVADO + @IMPORTE_IVA
				ELSE
					BEGIN
						SET @IMPORTE_C_IVA = @NETO_GRAVADO * 1.21 
						SET @IMPORTE_IVA = @IMPORTE_C_IVA - @NETO_GRAVADO
					END

				UPDATE V_MV_Cpte SET 
				IMPORTE=isnull(IMPORTE,0)+ @IMPORTE_C_IVA, 
				IMPORTE_S_IVA=isnull(IMPORTE_S_IVA,0)+(@pImporteUnitario*@pCantidad),
				ImporteInsumos=isnull(ImporteInsumos,0)+(@totalInsumo),
				ImporteIva=isnull(ImporteIva,0)+@IMPORTE_IVA,
				NetoGravado = isnull(NetoGravado,0)+@NETO_GRAVADO,
				NetoNoGravado = 0
				WHERE ID=@pIdCpte

				SET @pResultado = 11
				SET @pMensaje = 'El Pedido se ha dado de alta con exito'
				SET @pIdVMVCpteInsumosRES = @@IDENTITY
				
			END
END TRY
BEGIN CATCH
	ROLLBACK TRANSACTION
	ROLLBACK TRANSACTION
	SET @pIdVMVCpteInsumosRES = NULL
	SET @pResultado = ERROR_NUMBER()
	SET @pMensaje =  ERROR_MESSAGE()  --'No pudo darse de alta EL PEDIDO correctamente'
END CATCH

















GO

/****** Object:  StoredProcedure [dbo].[sp_web_CreaAplicacion]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[sp_web_CreaAplicacion]
	@pIdCobranza					 int,
	@pTCFactura						varchar(4),
	@pIdFactura						varchar(13),
	@pImporteAplicar				real,
	@pResultado 					 smallint = NULL OUTPUT,
	@pMensaje 						 varchar(255) = NULL OUTPUT
AS

DECLARE @TCFactura NVARCHAR(4)
DECLARE @SucFactura NVARCHAR(4)
DECLARE @NumFactura NVARCHAR(8)
DECLARE @LetFactura NVARCHAR(1)
DECLARE @ImporteFactura REAL
DECLARE @Cliente NVARCHAR(13)
DECLARE @unegocio NVARCHAR(4)
DECLARE @TcCobranza NVARCHAR(4)
DECLARE @SucCobranza NVARCHAR(4)
DECLARE @NumCobranza NVARCHAR(8)
DECLARE @LetCobranza NVARCHAR(1)

SET NOCOUNT ON

SELECT 
	@Cliente = CUENTA,
	@TcCobranza = TC,
	@SucCobranza = SUCURSAL,
	@NumCobranza = NUMERO,
	@LetCobranza = LETRA,
	@unegocio = UNEGOCIO
FROM V_MV_CPTE WHERE ID = @pIdCobranza

IF (@unegocio IS NULL) OR (@unegocio='')
	BEGIN
		SELECT @unegocio = VALOR FROM TA_CONFIGURACION WHERE CLAVE ='UNEGOCIO'
		SET @unegocio=dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@unegocio)),4)
	END

IF (@unegocio IS NULL) OR (@unegocio='') SET @unegocio='   1'

BEGIN TRANSACTION

INSERT INTO MV_APLICACION
(CUENTA,TC,SUCURSAL,NUMERO,LETRA,IDCOMPROBANTE,TCO_ORIGEN,SUCURSAL_ORIGEN,NUMERO_ORIGEN,LETRA_ORIGEN,
IDComprobante_Origen,IDCOMPLEMENTO_ORIGEN,IMPORTE,Transmision,Recepcion,UNegocio,Secuencia)
VALUES
(@Cliente,@TcCobranza,@SucCobranza,@NumCobranza,@LetCobranza,@SucCobranza+@NumCobranza+@LetCobranza,
@pTCFactura,SUBSTRING(@pIdFactura,1,4),substring(@pIdFactura,5,8),SUBSTRING(@pIdFactura,13,1),@pIdFactura,0,@pImporteAplicar,0,0,@unegocio,0)


IF @@ERROR <> 0 OR @@ROWCOUNT <> 1
	BEGIN
		ROLLBACK TRANSACTION
		SET @pResultado = 21
		SET @pMensaje = 'No pudo crearse la aplicacion'
		RETURN
	END
ELSE
	BEGIN
		COMMIT TRANSACTION
		SET @pResultado = 11
		SET @pMensaje = 'Aplicacion creada correctamente'
	END

GO

/****** Object:  StoredProcedure [dbo].[sp_web_CreaAplicacionCobranzaFactura]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[sp_web_CreaAplicacionCobranzaFactura]
	@pIdCobranza					 int,
	@pIdFactura						 int,
	@pResultado 					 smallint = NULL OUTPUT,
	@pMensaje 						 varchar(255) = NULL OUTPUT
AS

DECLARE @TCFactura NVARCHAR(4)
DECLARE @SucFactura NVARCHAR(4)
DECLARE @NumFactura NVARCHAR(8)
DECLARE @LetFactura NVARCHAR(1)
DECLARE @ImporteFactura REAL
DECLARE @Cliente NVARCHAR(13)
DECLARE @unegocio NVARCHAR(4)
DECLARE @TcCobranza NVARCHAR(4)
DECLARE @SucCobranza NVARCHAR(4)
DECLARE @NumCobranza NVARCHAR(8)
DECLARE @LetCobranza NVARCHAR(1)

SET NOCOUNT ON

SELECT 
	@TCFactura = TC,
	@Cliente = Cuenta,
	@SucFactura = SUCURSAL,
	@NumFactura = NUMERO,
	@LetFactura = LETRA,
	@unegocio = UNEGOCIO,
	@ImporteFactura = IMPORTE
FROM V_MV_CPTE WHERE ID = @pIdFactura

SELECT 
	@TcCobranza = TC,
	@SucCobranza = SUCURSAL,
	@NumCobranza = NUMERO,
	@LetCobranza = LETRA
FROM V_MV_CPTE WHERE ID = @pIdCobranza

IF (@unegocio IS NULL) OR (@unegocio='')
	BEGIN
		SELECT @unegocio = VALOR FROM TA_CONFIGURACION WHERE CLAVE ='UNEGOCIO'
		SET @unegocio=dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@unegocio)),4)
	END

IF (@unegocio IS NULL) OR (@unegocio='') SET @unegocio='   1'

BEGIN TRANSACTION

BEGIN TRY
	INSERT INTO MV_APLICACION
	(CUENTA,TC,SUCURSAL,NUMERO,LETRA,IDCOMPROBANTE,TCO_ORIGEN,SUCURSAL_ORIGEN,NUMERO_ORIGEN,LETRA_ORIGEN,
	IDComprobante_Origen,IDCOMPLEMENTO_ORIGEN,IMPORTE,Transmision,Recepcion,UNegocio,Secuencia)
	VALUES
	(@Cliente,@TcCobranza,@SucCobranza,@NumCobranza,@LetCobranza,@SucCobranza+@NumCobranza+@LetCobranza,
	@TCFactura,@SucFactura,@NumFactura,@LetFactura,@SucFactura+@NumFactura+@LetFactura,0,@ImporteFactura,0,0,@unegocio,0)


	IF @@ERROR <> 0 OR @@ROWCOUNT <> 1
		BEGIN
			ROLLBACK TRANSACTION
			SET @pResultado = 21
			SET @pMensaje = 'No pudo crearse la aplicacion'
			RETURN
		END
	ELSE
		BEGIN
			COMMIT TRANSACTION

			SET @pResultado = 11
			SET @pMensaje = 'Aplicacion creada correctamente'
		END
END TRY
BEGIN CATCH
	ROLLBACK TRANSACTION
	SET @pResultado = ERROR_NUMBER()
	SET @pMensaje = ERROR_MESSAGE()
END CATCH
	

GO

/****** Object:  StoredProcedure [dbo].[sp_web_AplicacionCobranzaAutomatica]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[sp_web_AplicacionCobranzaAutomatica]
	@Tc 							 nvarchar(4) = null,
	@pCliente						 nvarchar(15) = null,
	@idWeb							 varchar(100),
	@pResultado 					 smallint = NULL OUTPUT,
	@pMensaje 						 varchar(255) = NULL OUTPUT
AS
DECLARE @IdComprobante NVARCHAR(13)
DECLARE @nombre NVARCHAR(50)
DECLARE @domicilio NVARCHAR(50)
DECLARE @calle NVARCHAR(50)
DECLARE @numero NVARCHAR(50)
DECLARE @piso NVARCHAR(50)
DECLARE @departamento NVARCHAR(50)
DECLARE @telefono NVARCHAR(100)
DECLARE @localidad NVARCHAR(50)
DECLARE @idProvincia NVARCHAR(4)
DECLARE @codigoPostal NVARCHAR(10)
DECLARE @documentoTipo NVARCHAR(4)
DECLARE @documentoNumero NVARCHAR(13)
DECLARE @condicionIva NVARCHAR(50)
DECLARE @idCondCpraVta NVARCHAR(4)
DECLARE @comentarios NVARCHAR(100)
DECLARE @clasePrecio int
DECLARE @idlista NVARCHAR(4)
DECLARE @FechaHoraGrabacion DATETIME
DECLARE @unegocio NVARCHAR(4)
DECLARE @USUARIO AS NVARCHAR(50)

DECLARE @Importe REAL
DECLARE @TCAplicar  NVARCHAR(4)
DECLARE @IdComprobanteAplicar NVARCHAR(13)

DECLARE @IDCobranza INT
DECLARE @IDFactura INT

SET NOCOUNT ON

SELECT @Importe=IMPORTE,@IDCobranza = ID FROM V_MV_CPTE WHERE OBSERVACIONES LIKE '%' + @idWeb + '%' AND CUENTA=@pCliente AND TC=@Tc

IF @IDCobranza > 0
	BEGIN
		IF @Tc = 'CB' OR @Tc='CBCT'
			SELECT TOP 1 @TCAplicar=TC, @IdComprobanteAplicar = IDCOMPROBANTE FROM VE_CPTES_IMPAGOS WHERE CUENTA=@pCliente AND SALDO=@Importe AND (TC='FC' OR TC='TK' OR TC='TKFC') ORDER BY FECHA DESC
		ELSE
			SELECT TOP 1 @TCAplicar=TC, @IdComprobanteAplicar = IDCOMPROBANTE FROM VE_CPTES_IMPAGOS WHERE CUENTA=@pCliente AND SALDO=@Importe AND TC='FP' ORDER BY FECHA DESC
	END
ELSE
	BEGIN
		SET @pResultado= 13
		SET @pMensaje = 'No se encontro la cobranza'
	END

IF @IdComprobanteAplicar <> ''
	SELECT @IDFactura = ID FROM V_MV_Cpte WHERE TC=@TCAplicar AND IDCOMPROBANTE=@IdComprobanteAplicar AND CUENTA=@pCliente
ELSE
	BEGIN
		SET @pResultado= 13
		SET @pMensaje = 'No se encontro la factura'
	END
IF @IDFactura > 0
	EXEC sp_web_CreaAplicacionCobranzaFactura @IDCobranza,@IDFactura,@pResultado,@pMensaje



GO

/****** Object:  StoredProcedure [dbo].[sp_web_CalificarRespuesta]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/****** Object:  StoredProcedure [dbo].[sp_web_CreaAsientoIngresoEgreso]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[sp_web_CreaAsientoIngresoEgreso]
	@pTipo							 varchar(1) = null,
	@pImporte						 real=0,
	@pDetalle					     varchar(100) = null,
	@pCuentaImputacion				 varchar(15) = null,
	@pResultado 					 smallint = NULL OUTPUT,
	@pMensaje 						 varchar(255) = NULL OUTPUT
AS

DECLARE @FechaHoraGrabacion DATETIME
DECLARE @unegocio NVARCHAR(4)
DECLARE @USUARIO AS NVARCHAR(50)
DECLARE @Tc AS NVARCHAR(4)
DECLARE @IdComprobante AS NVARCHAR(4)
DECLARE @pCliente as NVARCHAR(13)
DECLARE @pVendedor AS NVARCHAR(4)
DECLARE @pFecha AS DATETIME
DECLARE @secuencia as int
DECLARE @SucCpte NVARCHAR(4)
DECLARE @NumCpte NVARCHAR(8)
DECLARE @LetCpte NVARCHAR(1)
DECLARE @NroAsiento INT
DECLARE @Periodo NVARCHAR(6)
DECLARE @CuentaMP NVARCHAR(15)
DECLARE @Mes_operativo INT
DECLARE @NUMERO NVARCHAR(8)
DECLARE @nvoNumero NVARCHAR(8)
DECLARE @SUCURSAL NVARCHAR(4)
DECLARE @LETRA NVARCHAR(1)


SET NOCOUNT ON

SET @USUARIO = SYSTEM_USER
SET @Tc = 'CJA'
SET @SUCURSAL = '0001'
SET @LETRA = 'X'

IF (@unegocio IS NULL) OR (@unegocio='')
	BEGIN
		SELECT @unegocio = VALOR FROM TA_CONFIGURACION WHERE CLAVE ='UNEGOCIO'
		SET @unegocio=dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@unegocio)),4)
	END

IF (@unegocio IS NULL) OR (@unegocio='') SET @unegocio='   1'

SET @FechaHoraGrabacion  = GETDATE()
SET @pFecha = CONVERT(VARCHAR,@FechaHoraGrabacion,103)

SET @CuentaMP = (SELECT VALOR FROM TA_CONFIGURACION WHERE CLAVE='CUENTA_CAJA')
--Efectivo
IF @CuentaMP = '' SET @CuentaMP	= '111010001'

SELECT @NUMERO = MAX(NUMERO) + 1 FROM MV_ASIENTOS WHERE TC='CJA' AND SUCURSAL='0001' AND LETRA='X'
IF @NUMERO = '0' OR @NUMERO IS NULL SET @NUMERO = '00000001'

SET @nvoNumero = dbo.FN_FMT_LEERCODIGO(CAST (@NUMERO as NVARCHAR(8)),8)
SET @nvoNumero = REPLACE(@nvoNumero,' ','0')
SET @NUMERO = @nvoNumero
SET @Mes_operativo = month(@pFecha)

SET @Periodo = (SELECT top 1 periodo FROM MV_EJERCICIOS WHERE [FECHA DESDE]<=@pFecha and [FECHA HASTA]>=@pFecha)
IF (@Periodo is null) SET @Periodo = '0'

SET @NroAsiento = (SELECT MAX([NUMERO ASIENTO])+1
FROM MV_ASIENTOS
WHERE MES_OPERATIVO=@Mes_operativo AND RTRIM(LTRIM(TIPO_REG))='CB' AND RTRIM(LTRIM(PERIODO))= @Periodo)
IF @NroAsiento is null or @NroAsiento = '' SET @NroAsiento = 1

IF @pDetalle = ''
	SET @pDetalle = 'Movimiento de caja'

SET NOCOUNT ON

BEGIN TRANSACTION;
	IF @pTipo = 'I' --INGRES
		BEGIN
			--ALTER TABLE MV_ASIENTOS DISABLE TRIGGER ALL
			INSERT INTO MV_ASIENTOS
			(CUENTA,SECUENCIA,MES_OPERATIVO,[NUMERO ASIENTO], FECHA, DETALLE,TC,SUCURSAL,
			NUMERO,LETRA,[DEBE-HABER],IMPORTE,MONEDA,COTIZACION,PERIODO,CABIMPORTE,TIPO_REG,CONTABILIZADO,
			FECHAHORA_GRABACION,FechaSubdiario, USUARIO_LOGEADO, IDCAJAS)
			VALUES
			(@CuentaMP, 1, @Mes_operativo, @NroAsiento, @pFecha, @pDetalle, @Tc, @SUCURSAL, 
			@NUMERO, @LETRA, 'D', @pImporte, '   1', 1, @Periodo, @pImporte,
			'CJA', 0, @pFecha, @FechaHoraGrabacion, @USUARIO, '   1')

			INSERT INTO MV_ASIENTOS
			(CUENTA,SECUENCIA,MES_OPERATIVO,[NUMERO ASIENTO], FECHA, DETALLE,TC,SUCURSAL,
			NUMERO,LETRA,[DEBE-HABER],IMPORTE,MONEDA,COTIZACION,PERIODO,CABIMPORTE,TIPO_REG,CONTABILIZADO,
			FECHAHORA_GRABACION,FechaSubdiario, USUARIO_LOGEADO, IDCAJAS)
			VALUES
			(@pCuentaImputacion, 2, @Mes_operativo, @NroAsiento, @pFecha, @pDetalle, @Tc, @SUCURSAL, 
			@NUMERO, @LETRA, 'H', @pImporte, '   1', 1, @Periodo, @pImporte,
			'CJA', 0, @pFecha, @FechaHoraGrabacion, @USUARIO, '   1')
			--ALTER TABLE MV_ASIENTOS ENABLE TRIGGER ALL
		END
	ELSE
		BEGIN
			--ALTER TABLE MV_ASIENTOS DISABLE TRIGGER ALL
			INSERT INTO MV_ASIENTOS
			(CUENTA,SECUENCIA,MES_OPERATIVO,[NUMERO ASIENTO], FECHA, DETALLE,TC,SUCURSAL,
			NUMERO,LETRA,[DEBE-HABER],IMPORTE,MONEDA,COTIZACION,PERIODO,CABIMPORTE,TIPO_REG,CONTABILIZADO,
			FECHAHORA_GRABACION,FechaSubdiario, USUARIO_LOGEADO, IDCAJAS)
			VALUES
			(@pCuentaImputacion, 1, @Mes_operativo, @NroAsiento, @pFecha, @pDetalle, @Tc, @SUCURSAL, 
			@NUMERO, @LETRA, 'D', @pImporte, '   1', 1, @Periodo, @pImporte,
			'CJA', 0, @pFecha, @FechaHoraGrabacion, @USUARIO, '   1')

			INSERT INTO MV_ASIENTOS
			(CUENTA,SECUENCIA,MES_OPERATIVO,[NUMERO ASIENTO], FECHA, DETALLE,TC,SUCURSAL,
			NUMERO,LETRA,[DEBE-HABER],IMPORTE,MONEDA,COTIZACION,PERIODO,CABIMPORTE,TIPO_REG,CONTABILIZADO,
			FECHAHORA_GRABACION,FechaSubdiario, USUARIO_LOGEADO, IDCAJAS)
			VALUES
			(@CuentaMP, 2, @Mes_operativo, @NroAsiento, @pFecha, @pDetalle, @Tc, @SUCURSAL, 
			@NUMERO, @LETRA, 'H', @pImporte, '   1', 1, @Periodo, @pImporte,
			'CJA', 0, @pFecha, @FechaHoraGrabacion, @USUARIO, '   1')
			--ALTER TABLE MV_ASIENTOS ENABLE TRIGGER ALL
		END
	
	IF @@ERROR <> 0 OR @@ROWCOUNT <> 1
		BEGIN
			ROLLBACK TRANSACTION
			SET @pResultado = 21
			SET @pMensaje = ERROR_MESSAGE() --'No pudo darse de alta el registro'
			RETURN
		END
	ELSE
		BEGIN
			COMMIT TRANSACTION
			SET @pResultado = 11
			SET @pMensaje = 'El registro se ha dado de alta con exito'
		END


	


GO

/****** Object:  StoredProcedure [dbo].[sp_web_CreaCobPorFactura]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO











CREATE PROCEDURE [dbo].[sp_web_CreaCobPorFactura]
	@pIdCpte						 int,
	@pResultado 					 smallint = NULL OUTPUT,
	@pMensaje 						 varchar(255) = NULL OUTPUT,
	@pIdComprobanteRES				 int = NULL OUTPUT
AS
--DECLARE @Tc NVARCHAR(4)

DECLARE @IdComprobanteCobranza NVARCHAR(13)
DECLARE @nombre NVARCHAR(50)
DECLARE @domicilio NVARCHAR(50)
DECLARE @calle NVARCHAR(50)
DECLARE @numero NVARCHAR(50)
DECLARE @piso NVARCHAR(50)
DECLARE @departamento NVARCHAR(50)
DECLARE @telefono NVARCHAR(100)
DECLARE @localidad NVARCHAR(50)
DECLARE @idProvincia NVARCHAR(4)
DECLARE @codigoPostal NVARCHAR(10)
DECLARE @documentoTipo NVARCHAR(4)
DECLARE @documentoNumero NVARCHAR(15)
DECLARE @condicionIva NVARCHAR(50)
DECLARE @idCondCpraVta NVARCHAR(4)
DECLARE @comentarios NVARCHAR(100)
DECLARE @idLista NVARCHAR(4)
DECLARE @unegocio NVARCHAR(4)
DECLARE @clasePrecio int

DECLARE @TCFactura NVARCHAR(4)
DECLARE @SucFactura NVARCHAR(4)
DECLARE @NumeroFactura NVARCHAR(8)
DECLARE @LetraFactura NVARCHAR(1)
DECLARE @ImporteFactura real

DECLARE @TcCobranza NVARCHAR(4)
DECLARE @pCliente nvarchar(15) = null
DECLARE @pVendedor nvarchar(4) = null
DECLARE @pFecha	datetime = null
DECLARE @pObservaciones	NVARCHAR(250) = null

SET NOCOUNT ON

SELECT 
	@TCFactura = TC,
	@pCliente = Cuenta,
	@pVendedor = IdVendedor,
	@unegocio = UNEGOCIO,
	@SucFactura = SUCURSAL,
	@NumeroFactura = NUMERO,
	@LetraFactura = LETRA,
	@ImporteFactura = IMPORTE
FROM V_MV_CPTE
WHERE ID = @pIdCpte

IF @TCFactura = 'FP'
	SET @TcCobranza = 'CBFP'
ELSE
	SET @TcCobranza = 'CBCT'

SET @pFecha = CONVERT(VARCHAR,GETDATE(),103)

IF @pCliente = ''
	SET @pCliente = (SELECT VALOR FROM TA_CONFIGURACION WHERE CLAVE='CUENTACONSUMIDORFINAL')

SELECT @nombre = isnull(RAZON_SOCIAL,''),
	@calle = ISNULL(CALLE,'.'),
	@numero = ISNULL(NUMERO,'.'),
	@piso = ISNULL(PISO,''),
	@departamento = ISNULL(DEPARTAMENTO,''),
	@telefono = TELEFONO,
	@localidad = LOCALIDAD,
	@idProvincia = PROVINCIA,
	@codigoPostal = CPOSTAL,
	@documentoTipo = DOCUMENTO_TIPO,
	@documentoNumero = NUMERO_DOCUMENTO,
	@condicionIva = IVA,
	@idCondCpraVta = IDCOND_CPRA_VTA,
	@clasePrecio = CLASE,
	@idLista = IDLISTA
FROM VT_CLIENTES
WHERE CODIGO = @pCliente

SET @domicilio = @calle + ' ' + @numero
IF (@piso <> '') SET @domicilio= @domicilio+ ' ' + LTRIM(RTRIM(@piso)) + ' Piso '
IF (@departamento <> '') SET @domicilio= @domicilio+ ' Dpto: ' +  LTRIM(RTRIM(@departamento))
IF (@condicionIva=NULL) SET @condicionIva = '   1'

SET @IdComprobanteCobranza = dbo.FN_OBTIENE_PROXIMO_NUMERO_CPTE (@TcCobranza,'9999','X')

IF (@clasePrecio IS NULL) OR (@clasePrecio = NULL) SET @clasePrecio = 1
SET @pVendedor = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pVendedor)),4)
SET @idLista = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@idLista)),4)

SET DATEFORMAT YMD
SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY
	INSERT INTO V_MV_CPTE
	(TC,IDCOMPROBANTE,IDCOMPLEMENTO,
	FECHA,FECHAESTFIN,FECHAESTINICIO,CUENTA,
	NOMBRE,DOMICILIO,TELEFONO,
	LOCALIDAD,IDPROVINCIA,CODIGOPOSTAL,
	DOCUMENTOTIPO,DOCUMENTONUMERO,CONDICIONIVA,
	IDCOND_CPRA_VTA,COMENTARIOS,IMPORTE,IMPORTE_S_IVA,
	MONEDA,IDVENDEDOR,CLASEPRECIO,UNEGOCIO_DESTINO,IdLista,IDMOTIVOCPRAVTA,IDDEPOSITO,AlicIva,ImporteIva,NEtoGravado,NetoNoGravado,Unegocio,
	FechaHora_Grabacion)
	VALUES
	(
		@TcCobranza, @IdComprobanteCobranza, 0,
		@pFecha, @pFecha, @pFecha,@pCliente,
		@Nombre, @Domicilio, isnull(@Telefono,''),
		@Localidad, @idProvincia, ltrim(@codigoPostal),
		@documentoTipo, ltrim(@documentoNumero), @condicionIva,
		@idCondCpraVta, @pObservaciones, @ImporteFactura, 0,
		'   1', @pVendedor, @clasePrecio, '   1', @idLista,'   1','   1',21,0,0,0,'   1', GETDATE())

	

	IF @@ERROR <> 0 OR @@ROWCOUNT <> 1
		BEGIN
			ROLLBACK TRANSACTION
			SET @pIdComprobanteRES = NULL
			SET @pResultado = 21
			SET @pMensaje = 'No pudo crearse la cobranza'
			RETURN
		END
	ELSE
		BEGIN
			COMMIT TRANSACTION

			SET @pResultado = 11
			SET @pMensaje = 'Cobranza creada correctamente'
			SET @pIdComprobanteRES = @@IDENTITY
		END
END TRY
BEGIN CATCH
	ROLLBACK TRANSACTION
	SET @pIdComprobanteRES = NULL
	SET @pResultado = ERROR_NUMBER()
	SET @pMensaje = ERROR_MESSAGE()
END CATCH
	

GO

/****** Object:  StoredProcedure [dbo].[sp_web_CreaCobranza]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[sp_web_CreaCobranza]

	@Tc 							 nvarchar(4) = null,
	@pCliente						 nvarchar(15) = null,
	@pVendedor						 nvarchar(4) = null,
	@pFecha	     					 datetime = null,
	@pImporte						 real=0,
	@pObs							 varchar(250),
	@idWeb							 varchar(100),
	@pResultado 					 smallint = NULL OUTPUT,
	@pMensaje 						 varchar(255) = NULL OUTPUT,
	@pIdComprobanteRES				 int = NULL OUTPUT
AS
DECLARE @IdComprobante NVARCHAR(13)
DECLARE @nombre NVARCHAR(50)
DECLARE @domicilio NVARCHAR(50)
DECLARE @calle NVARCHAR(50)
DECLARE @numero NVARCHAR(50)
DECLARE @piso NVARCHAR(50)
DECLARE @departamento NVARCHAR(50)
DECLARE @telefono NVARCHAR(100)
DECLARE @localidad NVARCHAR(50)
DECLARE @idProvincia NVARCHAR(4)
DECLARE @codigoPostal NVARCHAR(10)
DECLARE @documentoTipo NVARCHAR(4)
DECLARE @documentoNumero NVARCHAR(13)
DECLARE @condicionIva NVARCHAR(50)
DECLARE @idCondCpraVta NVARCHAR(4)
DECLARE @comentarios NVARCHAR(100)
DECLARE @clasePrecio int
DECLARE @idlista NVARCHAR(4)
DECLARE @FechaHoraGrabacion DATETIME
DECLARE @unegocio NVARCHAR(4)
DECLARE @USUARIO AS NVARCHAR(50)

SET NOCOUNT ON
IF @Tc = '' SET @Tc = 'CB'

SELECT @nombre = ISNULL(RAZON_SOCIAL,''),
	@calle = ISNULL(CALLE,'.'),
	@numero = ISNULL(NUMERO,'.'),
	@piso = ISNULL(PISO,''),
	@departamento = ISNULL(DEPARTAMENTO,''),
	@telefono = TELEFONO,
	@localidad = LOCALIDAD,
	@idProvincia = PROVINCIA,
	@codigoPostal = CPOSTAL,
	@documentoTipo = DOCUMENTO_TIPO,
	@documentoNumero = NUMERO_DOCUMENTO,
	@condicionIva = IVA,
	@idCondCpraVta = IDCOND_CPRA_VTA,
	@clasePrecio = CLASE,
	@comentarios = OBSERVACIONES,
	@idlista= IdLista
FROM VT_CLIENTES
WHERE CODIGO = @pCliente

SET @domicilio = @calle + ' ' + @numero
IF (@piso <> '') SET @domicilio= @domicilio+ ' ' + LTRIM(RTRIM(@piso)) + ' Piso '
IF (@departamento <> '') SET @domicilio= @domicilio+ ' Dpto: ' +  LTRIM(RTRIM(@departamento))
IF (@condicionIva=NULL) SET @condicionIva = '   1'
SET @idComprobante = dbo.FN_OBTIENE_PROXIMO_NUMERO_CPTE (@tc,'9999','X')
IF (@clasePrecio IS NULL) OR (@clasePrecio = NULL)
	SET @clasePrecio = 1

IF @pObs = ''
	SET @pObs = 'Cob. ' + @nombre

SET @USUARIO = SYSTEM_USER
SET @pVendedor = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pVendedor)),4)

IF @pVendedor <> ''
	SELECT @unegocio = isnull(UNegocio,''), @USUARIO=isnull(NOMBRE,SYSTEM_USER) FROM TA_USUARIOS WHERE ltrim(idvendedor)=ltrim(@pVendedor)

IF @unegocio IS Null or @unegocio = ''
	BEGIN
		SELECT @unegocio = VALOR FROM TA_CONFIGURACION WHERE CLAVE ='UNEGOCIO'
		IF (@unegocio IS NULL) OR (@unegocio='') SET @unegocio='   1'
	END
SET @unegocio=dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@unegocio)),4)

SET @FechaHoraGrabacion  = @pFecha
SET @pFecha = CONVERT(VARCHAR,@pFecha,103)

DECLARE @pIdReparto INT
SET @pIdReparto=0


SET NOCOUNT ON
BEGIN TRANSACTION
BEGIN
	INSERT INTO V_MV_CPTE
		( TC,IDCOMPROBANTE,IDCOMPLEMENTO,
		FECHA,FECHAESTFIN,CUENTA,
		NOMBRE,DOMICILIO,TELEFONO,
		LOCALIDAD,IDPROVINCIA,CODIGOPOSTAL,
		DOCUMENTOTIPO,DOCUMENTONUMERO,CONDICIONIVA,
		IDCOND_CPRA_VTA,COMENTARIOS,IMPORTE,IMPORTE_S_IVA,
		MONEDA,IDVENDEDOR,CLASEPRECIO,IdLista,FechaHora_Grabacion,IdReparto,UNEGOCIO,UNEGOCIO_DESTINO,Usuario,
		SUCURSAL,NUMERO,LETRA,OBSERVACIONES)
	VALUES
		(
			@Tc, @IdComprobante, 0,
			@pFecha, @pFecha, @pCliente,
			@Nombre, @Domicilio, @Telefono,
			@Localidad, @idProvincia, @codigoPostal,
			@documentoTipo, @documentoNumero, @condicionIva,
			@idCondCpraVta, @pObs, @pImporte, 0,
			'   1', @pVendedor, @clasePrecio, @idlista, @FechaHoraGrabacion, @pIdReparto, @unegocio, @unegocio, @USUARIO,
			SUBSTRING(@IdComprobante,1,4), SUBSTRING(@IdComprobante,5,8), RIGHT(@IdComprobante,1), 'Cobranza Web Nro: ' + @idWeb)

	IF @@ERROR <> 0 OR @@ROWCOUNT <> 1
					BEGIN
		ROLLBACK TRANSACTION
		SET @pIdComprobanteRES = NULL
		SET @pResultado = 21
		SET @pMensaje = 'No pudo crearse la cobranza'
		RETURN
	END
	COMMIT TRANSACTION
	SET @pResultado = 11
	SET @pMensaje = 'Cobranza creada correctamente'
	SET @pIdComprobanteRES = @@IDENTITY
END



GO

/****** Object:  StoredProcedure [dbo].[sp_web_creaLineaAsiento]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[sp_web_creaLineaAsiento]
	@pIdCobranza					 int = null,
	@pImporte						 real=0,
	@pCuentaMp					     varchar(100),
	@pPrimero						 int,
	@pChequeNro						 varchar(50) = null,
	@pResultado 					 smallint = NULL OUTPUT,
	@pMensaje 						 varchar(255) = NULL OUTPUT
AS

DECLARE @FechaHoraGrabacion DATETIME
DECLARE @unegocio NVARCHAR(4)
DECLARE @USUARIO AS NVARCHAR(50)
DECLARE @Tc AS NVARCHAR(4)
DECLARE @IdComprobante AS NVARCHAR(13)
DECLARE @pCliente as NVARCHAR(13)
DECLARE @pVendedor AS NVARCHAR(4)
DECLARE @pFecha AS DATETIME
DECLARE @secuencia as int
DECLARE @SucCpte NVARCHAR(4)
DECLARE @NumCpte NVARCHAR(8)
DECLARE @LetCpte NVARCHAR(1)
DECLARE @TotalCpte REAL
DECLARE @idCaja NVARCHAR(4)
SET NOCOUNT ON

SELECT 
	@Tc = TC,
	@pCliente = Cuenta,
	@pVendedor = IdVendedor,
	@unegocio = UNEGOCIO,
	@IdComprobante = IDCOMPROBANTE,
	@SucCpte = SUCURSAL,
	@NumCpte = NUMERO,
	@LetCpte = LETRA,
	@TotalCpte = isnull(IMPORTE,0),
	@pFecha = FECHA
FROM V_MV_CPTE
WHERE ID = @pIdCobranza

SELECT @idCaja=isnull(idCaja,'1'), @USUARIO=NOMBRE FROM TA_USUARIOS WHERE ltrim(idvendedor) = ltrim(@pVendedor)

IF @idCaja IS NULL OR @idCaja = '' SET @idCaja = '1'
IF @USUARIO IS NULL SET @USUARIO = SYSTEM_USER

SET @pVendedor = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pVendedor)),4)
SET @idCaja = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@idCaja)),4)

IF (@unegocio IS NULL) OR (@unegocio='')
	BEGIN
		SELECT @unegocio = VALOR FROM TA_CONFIGURACION WHERE CLAVE ='UNEGOCIO'
		SET @unegocio=dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@unegocio)),4)
	END

IF (@unegocio IS NULL) OR (@unegocio='') SET @unegocio='   1'

SET @FechaHoraGrabacion  = GETDATE()
SET @pFecha = CONVERT(VARCHAR,@FechaHoraGrabacion,103)

DECLARE @pIdReparto INT
SET @pIdReparto=0

DECLARE @NroAsiento INT
DECLARE @Periodo NVARCHAR(6)
DECLARE @CuentaMP NVARCHAR(15)
DECLARE @Mes_operativo INT
DECLARE @DEBEHABER NVARCHAR(1)

SET @CuentaMP = @pCuentaMp
IF @CuentaMP = '' SET @CuentaMP = (SELECT VALOR FROM TA_CONFIGURACION WHERE CLAVE='CUENTA_CAJA')
--Efectivo
IF @CuentaMP = '' SET @CuentaMP	= '111010001'

SET @secuencia = 1

DECLARE @SQL NVARCHAR(MAX)
IF @pPrimero = 1
	BEGIN
		--SET @idComprobante = dbo.FN_OBTIENE_PROXIMO_NUMERO_CPTE (@tc,'9999','X')
		SET @secuencia = 1
		SET @Mes_operativo = month(@pFecha)

		SET @Periodo = (SELECT top 1 periodo FROM MV_EJERCICIOS WHERE [FECHA DESDE]<=@pFecha and [FECHA HASTA]>=@pFecha)
		IF (@Periodo is null) SET @Periodo = '0'
		SET @DEBEHABER = 'H'

		SET @CuentaMP = @pCliente
		SET @pImporte = @TotalCpte

		SET @NroAsiento = (SELECT MAX([NUMERO ASIENTO])+1
		FROM MV_ASIENTOS
		WHERE MES_OPERATIVO=@Mes_operativo AND RTRIM(LTRIM(TIPO_REG))='CB' AND RTRIM(LTRIM(PERIODO))= @Periodo)
		IF @NroAsiento is null or @NroAsiento = '' SET @NroAsiento = 1
	END
ELSE
	BEGIN
		SET @DEBEHABER = 'D'
		SELECT TOP 1 @secuencia=SECUENCIA+1, @Mes_operativo=MES_OPERATIVO,@Periodo=PERIODO,@NroAsiento=[NUMERO ASIENTO] FROM MV_ASIENTOS
		WHERE TC=@Tc and SUCURSAL=SUBSTRING(@IdComprobante,1,4) AND NUMERO= SUBSTRING(@IdComprobante,5,8) AND LETRA=RIGHT(@IdComprobante,1)
		ORDER BY SECUENCIA DESC
	END
SET NOCOUNT ON

BEGIN TRANSACTION;

	INSERT INTO MV_ASIENTOS
	(CUENTA,SECUENCIA,MES_OPERATIVO,[NUMERO ASIENTO], FECHA, DETALLE,TC,SUCURSAL,
	NUMERO,LETRA,[DEBE-HABER],IMPORTE,MONEDA,COTIZACION,PERIODO,CABIMPORTE,TIPO_REG,CONTABILIZADO,
	FECHAHORA_GRABACION,FechaSubdiario, USUARIO_LOGEADO, IDCAJAS,NroComprobanteBancario,UNEGOCIO)
	VALUES
	(@CuentaMP, @secuencia, @Mes_operativo, @NroAsiento, @pFecha, 'Cobranza Web', @Tc, SUBSTRING(@IdComprobante,1,4), 
	SUBSTRING(@IdComprobante,5,8), RIGHT(@IdComprobante,1), @DEBEHABER, @pImporte, '   1', 1, @Periodo, @TotalCpte,
	'CB', 0, @pFecha, @FechaHoraGrabacion, @USUARIO, @idCaja,@pChequeNro,@unegocio)

	IF @@ERROR <> 0 OR @@ROWCOUNT <> 1
		BEGIN
			ROLLBACK TRANSACTION
			SET @pResultado = 21
			SET @pMensaje = 'No pudo darse de alta el registro'
			RETURN
		END
	
	COMMIT TRANSACTION
	SET @pResultado = 11
	SET @pMensaje = 'El registro se ha dado de alta con exito'
		


	


GO

/****** Object:  StoredProcedure [dbo].[sp_web_getAcumuladoVentasCaja]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO










CREATE PROCEDURE [dbo].[sp_web_getAcumuladoVentasCaja]
	@fecha nvarchar(25),
	@idcaja nvarchar(4)
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @WHERE NVARCHAR(250)
	DECLARE @rs NVARCHAR(MAX)


	SET @WHERE = ''

	IF @idcaja != ''
		SET @WHERE = ' AND LTRIM(idcajas) = ''' + @idcaja + ''''

	if @fecha != ''
		SET @WHERE = @WHERE + ' AND fecha = ''' + @fecha + ''''


	SET @rs = '
	SELECT * FROM (SELECT ''01 ACUMULADO VENTAS'' AS nombre,
    isnull(convert(varchar,convert(decimal(15,2),SUM(LIVA_TOTAL))),0) AS importe_venta_total,
    isnull(convert(varchar,convert(decimal(15,2),SUM(LIVA_IMPIVA + LIVA_IMPIVA2 +LIVA_IMPIVA3+LIVA_IMPIVA4))),0) AS total_iva,
    count(tc) as cantidad_cptes FROM libroivaventas
    WHERE TC<>''NC'' ' + @WHERE + '
    Union
    SELECT ''02 ACUM NOTA DE CREDITO'',
    isnull(convert(varchar,convert(decimal(15,2),SUM(LIVA_TOTAL))),0),
    isnull(convert(varchar,convert(decimal(15,2),SUM(
        LIVA_IMPIVA + LIVA_IMPIVA2 +LIVA_IMPIVA3+LIVA_IMPIVA4))),0),
    count(tc) FROM libroivaventas
    WHERE TC=''NC'' ' + @WHERE + '
    Union
    SELECT ''03 ACUM PROFORMAS'',
    isnull(convert(varchar,convert(decimal(15,2),SUM(IMPORTE))),0),
    isnull(convert(varchar,convert(decimal(15,2),SUM(
        LIVA_IMPIVA + LIVA_IMPIVA2 +LIVA_IMPIVA3+LIVA_IMPIVA4))),0),
    count(tc) FROM MV_ASIENTOS
    WHERE (TC=''FP'') AND SECUENCIA = 1 ' + @WHERE + '
    Union
    SELECT ''04 ACUM NC PROFORMA'',
    isnull(convert(varchar,convert(decimal(15,2),SUM(IMPORTE)*-1 )),0),
    isnull(convert(varchar,convert(decimal(15,2),SUM(
        LIVA_IMPIVA + LIVA_IMPIVA2 +LIVA_IMPIVA3+LIVA_IMPIVA4)*-1)),0),
    count(tc) FROM MV_ASIENTOS
    WHERE (TC=''NCFP'') AND SECUENCIA = 1 ' + @WHERE + '
    ) AS A ORDER BY NOMBRE
	'

	EXEC(@rs)

END








GO

/****** Object:  StoredProcedure [dbo].[sp_web_getArticulosPrecios]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO










CREATE PROCEDURE [dbo].[sp_web_getArticulosPrecios]
	@idCliente nvarchar(9) = '',
	@searchText nvarchar(MAX) = '',
	@idFamily nvarchar(100) = '',
	@idArticulo nvarchar(25) = ''
AS

BEGIN

	SET NOCOUNT ON;

	DECLARE @idLista NVARCHAR(4)
	DECLARE @clasePrecio NVARCHAR(4)
	DECLARE @claseDefault NVARCHAR(4)
	DECLARE @rs NVARCHAR(MAX)
	DECLARE @wh NVARCHAR(MAX)
	DECLARE @cotiz NVARCHAR(20)
	DECLARE @cotiz2 NVARCHAR(20)
	DECLARE @cotiz3 NVARCHAR(20)
	DECLARE @cotiz4 NVARCHAR(20)
	DECLARE @cotiz5 NVARCHAR(20)
	DECLARE @coeficiente FLOAT
	DECLARE @idDeposito NVARCHAR(4)
	DECLARE @listasConIVA NVARCHAR(2)

	DECLARE @ocultaPrecios NVARCHAR(2) = ''
	DECLARE @muestraSinStock NVARCHAR(2) = ''

	SET @ocultaPrecios = 'NO'
	SET @muestraSinStock = 'NO'

	SELECT @listasConIVA = VALOR FROM TA_CONFIGURACION WHERE CLAVE='FijaListasCONIVA'

	SET @cotiz = ISNULL((SELECT TOP 1 ISNULL(MONEDA1,'1') FROM TA_COTIZACION ORDER BY FECHA_HORA DESC),'1')-- WHERE FECHA_HORA = CONVERT(date,GETDATE())),'1')
	SET @cotiz2 = ISNULL((SELECT TOP 1 ISNULL(MONEDA2,'1') FROM TA_COTIZACION ORDER BY FECHA_HORA DESC),'1') --ISNULL((SELECT ISNULL(MONEDA2,'1') FROM TA_COTIZACION WHERE FECHA_HORA = CONVERT(date,GETDATE())),'1')
	SET @cotiz3 = ISNULL((SELECT TOP 1 ISNULL(MONEDA3,'1') FROM TA_COTIZACION ORDER BY FECHA_HORA DESC),'1') -- ISNULL((SELECT ISNULL(MONEDA3,'1') FROM TA_COTIZACION WHERE FECHA_HORA = CONVERT(date,GETDATE())),'1')
	SET @cotiz4 = ISNULL((SELECT TOP 1 ISNULL(MONEDA4,'1') FROM TA_COTIZACION ORDER BY FECHA_HORA DESC),'1') --ISNULL((SELECT ISNULL(MONEDA4,'1') FROM TA_COTIZACION WHERE FECHA_HORA = CONVERT(date,GETDATE())),'1')
	SET @cotiz5 = ISNULL((SELECT TOP 1 ISNULL(MONEDA5,'1') FROM TA_COTIZACION ORDER BY FECHA_HORA DESC),'1') --ISNULL((SELECT ISNULL(MONEDA5,'1') FROM TA_COTIZACION WHERE FECHA_HORA = CONVERT(date,GETDATE())),'1')

	SET @claseDefault = (SELECT VALOR
	FROM TA_CONFIGURACION
	WHERE CLAVE='ClaseDePrecioDefault')

	SET @muestraSinStock = isnull((SELECT VALOR
	FROM TA_CONFIGURACION
	WHERE CLAVE='Web_Muestra_sin_Stock'),'NO')
	
	SET @idDeposito = (SELECT VALOR FROM TA_CONFIGURACION WHERE CLAVE ='DepositoDefault')
	
	IF @idCliente <>''
		BEGIN
		--SET @idLista = (SELECT isnull(ltrim(idlista),'')
		--from Vt_Clientes
		--WHERE CODIGO=@idCliente)
		SELECT @idLista = ISNULL(ltrim(idlista),''), @clasePrecio = ISNULL(clase,@claseDefault)
		FROM Vt_Clientes WHERE CODIGO = @idCliente
		--SET @clasePrecio = (SELECT isnull(clase,@claseDefault)
		--from Vt_Clientes
		--WHERE CODIGO=@idCliente)
	END
	ELSE
		BEGIN
			SET @idLista = ''
			SET @clasePrecio = @claseDefault
		END
	
	SET @wh = ''
	if @clasePrecio = '' or @clasePrecio is null or @clasePrecio = 0
		SET @clasePrecio = @claseDefault
	
	IF @idArticulo <> ''
		SET @wh = ' WHERE (ltrim(codigo)= ''' + LTRIM(@idArticulo) + ''' OR ltrim(codigobarra)= ''' + LTRIM(@idArticulo) + ''') '
	ELSE
		BEGIN
			IF @searchText <> ''
				SET @wh = ' WHERE ' + @searchText

			IF @idFamily <> ''
				BEGIN
					IF @wh = ''
						SET @wh = ' WHERE idfamilia like ''' + @idFamily + '%'''
					ELSE 
						SET @wh =  @wh + ' AND (idfamilia like ''' + @idFamily + '%'')'
				END
				
		END
	
	IF @idLista <> '' 
	
		SET @rs = '
		SELECT TOP 200 codigo,descripcion,idfamilia,rutaimagen,nombre_familia,cant_of,dto_of,cant_of2,dto_of2, ''' + @muestraSinStock + ''' as mostrarsinstock,exento,
		CASE WHEN ''' + @ocultaPrecios + ''' = ''SI'' THEN ''0'' ELSE convert(varchar,convert(decimal(15,2),precio * coeficiente)) END as precio,presentacion,puntopedido as stk_minimo,puntomaximo as stk_maximo,
		''' + @ocultaPrecios + ''' as oculta_precio,stock, procedencia as cant_caja,tasaiva,idunidad,idrubro,idtipo,codigobarra
		 FROM (
		SELECT codigo,descripcion,idfamilia,rutaimagen,nombre_familia,cant_of,dto_of,cant_of2,dto_of2,coeficiente,isnull(presentacion,'''') as presentacion,puntopedido,puntomaximo,idunidad,idrubro,idtipo,codigobarra,
		CASE moneda 
		WHEN ''1'' THEN precio
		WHEN ''2'' THEN precio * ' + @cotiz2 + '
		WHEN ''3'' THEN precio * ' + @cotiz3 + '
		WHEN ''4'' THEN precio * ' + @cotiz4 + '
		WHEN ''5'' THEN precio * ' + @cotiz5 + '
		ELSE precio END as precio,convert(varchar,convert(decimal(15,2),stock)) as stock, procedencia,exento,tasaiva
		FROM (
		SELECT LTRIM(a.idarticulo) as codigo, b.descripcion, b.procedencia,
		b.idfamilia,b.rutaimagen,isnull(c.descripcion,''Sin Familia'') as nombre_familia,
		convert(varchar,convert(decimal(15,2),isnull(a.cantidadof2,0))) as cant_of,
		convert(varchar,convert(decimal(15,2),isnull(a.precio9,0))) as dto_of,
		convert(varchar,convert(decimal(15,2),isnull(a.cantidadof3,0))) as cant_of2,
		convert(varchar,convert(decimal(15,2),isnull(a.precio10,0))) as dto_of2,
		ltrim(b.moneda) as moneda,
		isnull(d.coeficiente,1) as coeficiente,
		b.puntomaximo, b.puntopedido,
		b.presentacion,b.exento,
		b.tasaiva,ltrim(b.idrubro) as idrubro,ltrim(b.idunidad) as idunidad,
		ltrim(b.idtipo) as idtipo,ltrim(b.codigobarra) as codigobarra,
		CASE WHEN a.ConIva = 1 
		THEN a.precio' + @clasePrecio + ' 
		ELSE CASE WHEN ''' + @listasConIVA + ''' = ''SI'' THEN a.precio' + @clasePrecio + ' * 1.21 ELSE a.precio' + @clasePrecio + ' END END as precio,
		(SELECT ISNULL(SUM(CANTIDADUD),0) FROM V_MV_STOCK WITH(NOLOCK) 
		WHERE IDArticulo=a.IdArticulo AND Anulado=0 AND ltrim(IdDeposito)=''' + ltrim(@idDeposito) + ''') as stock
		FROM V_MA_Precios a 
		LEFT JOIN V_MA_ARTICULOS B ON a.IDARTICULO = b.IDARTICULO
		LEFT JOIN V_TA_FAMILIAS c ON b.idfamilia = c.idfamilia
		LEFT JOIN S_TA_EQUIV d ON d.IDUNIDAD = b.UD_TTE and b.IDARTICULO = d.IDARTICULO
		and d.IDUNIDAD_EQUIV = b.IDUNIDAD
		WHERE (b.suspendido=0 or b.suspendido is null) AND (b.suspendidov=0 or b.suspendidov is null) and ltrim(a.idlista)=''' + @idLista + '''
		) as z ' + @wh + ') as x'
	ELSE
		SET @rs = '
		SELECT TOP 200 codigo,descripcion,idfamilia,rutaimagen,nombre_familia,cant_of,dto_of,cant_of2,dto_of2,presentacion, '''  + @muestraSinStock + ''' as mostrarsinstock,puntopedido as stk_minimo,puntomaximo as stk_maximo,
		CASE WHEN ''' + @ocultaPrecios + ''' = ''SI'' THEN ''0'' ELSE convert(varchar,convert(decimal(15,2),precio * coeficiente)) END as precio,procedencia as cant_caja,
		''' + @ocultaPrecios + ''' as oculta_precio,stock,exento,tasaiva, convert(varchar,convert(decimal(15,2),costo)) as costo,idunidad,idrubro,idtipo,codigobarra
		FROM (
		SELECT codigo,descripcion,idfamilia,rutaimagen,nombre_familia,0 as cant_of,0 as dto_of,0 as cant_of2,0 as dto_of2,coeficiente,presentacion,procedencia,puntopedido,puntomaximo,costo,idunidad,idrubro,idtipo,codigobarra,
		CASE moneda 
		WHEN ''1'' THEN precio
		WHEN ''2'' THEN precio * ' + @cotiz2 + '
		WHEN ''3'' THEN precio * ' + @cotiz3 + '
		WHEN ''4'' THEN precio * ' + @cotiz4 + '
		WHEN ''5'' THEN precio * ' + @cotiz5 + '
		ELSE precio END as precio,convert(varchar,convert(decimal(15,2),stock)) as stock,exento,tasaiva
		FROM (
		SELECT ltrim(b.idarticulo) as codigo, b.descripcion, b.rutaimagen, b.procedencia,isnull(c.descripcion,''Sin Familia'') as nombre_familia,ltrim(c.idfamilia) as idfamilia,b.puntomaximo, b.puntopedido
		, b.precio' + @clasePrecio + ' as precio,b.costo,isnull(d.coeficiente,1) as coeficiente,isnull(b.presentacion,'''') as presentacion,b.exento,b.tasaiva,ltrim(b.idrubro) as idrubro,ltrim(b.idunidad) as idunidad,
		ltrim(b.idtipo) as idtipo,ltrim(b.codigobarra) as codigobarra,
		ltrim(b.moneda) as moneda,(SELECT ISNULL(SUM(CANTIDADUD),0) FROM V_MV_STOCK WITH(NOLOCK) 
		WHERE IDArticulo=b.IdArticulo AND Anulado=0 AND ltrim(IdDeposito)=''' + ltrim(@idDeposito) + ''') as stock from v_ma_articulos b
		LEFT JOIN V_TA_FAMILIAS c on b.idfamilia = c.idfamilia
		LEFT JOIN S_TA_EQUIV d ON d.IDUNIDAD = b.UD_TTE and b.IDARTICULO = d.IDARTICULO
		and d.IDUNIDAD_EQUIV = b.IDUNIDAD
		WHERE (b.suspendido=0 or b.suspendido is null) AND (b.suspendidov=0 or b.suspendidov is null)
		) as z ' + @wh + ' ) as x'
		
	EXEC(@rs)
END







GO

/****** Object:  StoredProcedure [dbo].[sp_web_getChoferes]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO












CREATE PROCEDURE [dbo].[sp_web_getChoferes]
	@chofer nvarchar(15) = ''
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @WHERE NVARCHAR(250)
	DECLARE @rs NVARCHAR(MAX)
	DECLARE @BASETTE NVARCHAR(250)

	SET @BASETTE = (SELECT VALOR
	FROM TA_CONFIGURACION
	WHERE CLAVE='SAT_BASEDEDATOS')

	IF @chofer <> ''
		SET @rs = '
		USE ' + @BASETTE + '
		SELECT ltrim(nro_documento) as codigo,ltrim(isnull(nombres,'''')) as nombre ,ltrim(isnull(apellido,'''')) as apellido,isnull(ltrim(nro_documento),'''') as clave 
		FROM MA_Choferes where ltrim(nro_documento)=''' + ltrim(@chofer) + ''''
	ELSE
		SET @rs = '
		USE ' + @BASETTE + '
		SELECT ltrim(nro_documento) as codigo,ltrim(isnull(nombres,'''')) as nombre ,ltrim(isnull(apellido,'''')) as apellido,isnull(ltrim(nro_documento),'''') as clave 
		FROM MA_Choferes'


	EXEC(@rs)

END







GO

/****** Object:  StoredProcedure [dbo].[sp_web_getClientesTransporte]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO












CREATE PROCEDURE [dbo].[sp_web_getClientesTransporte]
	@viaje nvarchar(13) = ''
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @WHERE NVARCHAR(250)
	DECLARE @rs NVARCHAR(MAX)
	DECLARE @BASETTE NVARCHAR(250)

	SET @BASETTE = (SELECT VALOR
	FROM TA_CONFIGURACION
	WHERE CLAVE='SAT_BASEDEDATOS')

	IF @viaje <> ''
		SET @rs = '
		USE ' + @BASETTE + '
		SELECT a.CODIGO_CLIENTE as codigo,isnull(b.razon_social,'''') as razon_social FROM MV_VIAJES a 
		LEFT JOIN MA_Clientes b ON a.CODIGO_CLIENTE = b.codigo
		WHERE a.NRO_COMPROBANTE=''' + @viaje + ''''
	ELSE
		SET @rs = '
		USE ' + @BASETTE + '
		SELECT codigo,razon_social FROM 
		MA_Clientes where inactivo=0'


	EXEC(@rs)

END







GO

/****** Object:  StoredProcedure [dbo].[sp_web_getComprobantes]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO













CREATE PROCEDURE [dbo].[sp_web_getComprobantes]
	@tc nvarchar(4),
	@vendedor nvarchar(4) = null,
	@fechaDesde nvarchar(10),
	@fechaHasta nvarchar(10),
	@cliente nvarchar(15) = null,
	@soloTc BIT = 0
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @rs NVARCHAR(MAX)
	DECLARE @whereTc NVARCHAR(250)
	DECLARE @whereVendedor NVARCHAR(250)
	DECLARE @where NVARCHAR(250)

	SET @where =  ' (FECHA>=''' + @fechaDesde + ''' AND FECHA<=''' + @fechaHasta + ''') '

	IF (@tc = 'CB' or @tc = 'CBFP' or @tc = 'CBCT') AND @soloTc = 0
		SET @where = @where + ' AND (TC=''CB'' OR TC=''CBFP'' OR TC=''CBCT'')  '
	ELSE
		BEGIN
		IF @tc <> ''
				SET @where = @where +  ' AND TC=''' + @tc + ''' '
	END

	IF @vendedor <>''
		SET @where = @where + ' AND ltrim(idvendedor)=''' + ltrim(@vendedor) + '''  '

	IF @cliente <>''
		SET @where = @where + ' AND cuenta=''' + @cliente + '''  '


	SET @rs = '
	SELECT tc,idcomprobante,nombre,cuenta,
	CONVERT(VARCHAR,CONVERT(DECIMAL(15,2),isnull(importe,0))) as importe,
	CONVERT(NVARCHAR(10),fecha,103) as fecha
	FROM V_MV_CPTE WHERE ' + @where + ' ORDER BY FECHA'

	EXEC(@rs)

END







GO

/****** Object:  StoredProcedure [dbo].[sp_web_getComprobantesCanceladosCaja]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO











CREATE PROCEDURE [dbo].[sp_web_getComprobantesCanceladosCaja]
	@fecha nvarchar(25),
	@idcaja nvarchar(4)
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @WHERE NVARCHAR(250)
	DECLARE @rs NVARCHAR(MAX)


	SET @WHERE = ''

	if @fecha != ''
		SET @WHERE =  ' CONVERT(NVARCHAR(10),dbo.V_MV_CpteAcciones.FECHAHORA,103) = ''' + @fecha + ''''

	IF @idcaja != ''
		SET @WHERE = @WHERE + ' AND LTRIM(dbo.MV_ASIENTOS.IdCajas) = ''' + @idcaja + ''''


	SET @rs = '
	SELECT dbo.V_MV_CpteAcciones.tc, dbo.V_MV_CpteAcciones.idcomprobante, 
	convert(NVARCHAR(18),dbo.V_MV_CpteAcciones.FECHAHORA,103) + '' '' + convert(NVARCHAR(18),dbo.V_MV_CpteAcciones.FECHAHORA,108) as fechahora, 
	dbo.V_MV_CpteAcciones.usuario, dbo.V_MV_CpteAcciones.pc ,dbo.V_MV_CpteAcciones.SYSTEMUSER AS detalle
    FROM dbo.V_MV_CpteAcciones LEFT OUTER JOIN dbo.MV_ASIENTOS ON dbo.V_MV_CpteAcciones.TC = dbo.MV_ASIENTOS.TC
    WHERE (dbo.V_MV_CpteAcciones.TIPO_ACCION = N''IN'') AND (dbo.MV_ASIENTOS.SUCURSAL + dbo.MV_ASIENTOS.NUMERO + dbo.MV_ASIENTOS.LETRA = dbo.V_MV_CpteAcciones.IDCOMPROBANTE)
    GROUP BY dbo.V_MV_CpteAcciones.TC, dbo.V_MV_CpteAcciones.IDCOMPROBANTE, dbo.V_MV_CpteAcciones.FECHAHORA, dbo.V_MV_CpteAcciones.USUARIO, dbo.V_MV_CpteAcciones.Pc ,
    dbo.MV_ASIENTOS.IdCajas, dbo.V_MV_CpteAcciones.SYSTEMUSER
    HAVING ' + @WHERE



	EXEC(@rs)

END







GO

/****** Object:  StoredProcedure [dbo].[sp_web_getComprobantesCtaCte]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO











CREATE PROCEDURE [dbo].[sp_web_getComprobantesCtaCte]
	@fecha nvarchar(25),
	@idcaja nvarchar(4),
	@tc nvarchar(4)
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @WHERE NVARCHAR(250)
	DECLARE @rs NVARCHAR(MAX)


	SET @WHERE = ''

	IF @idcaja != ''
		SET @WHERE = ' AND LTRIM(a.idcajas) = ''' + @idcaja + ''''

	if @fecha != ''
		SET @WHERE = @WHERE + ' AND a.fecha = ''' + @fecha + ''''

	if @tc = 'CB'
		SET @WHERE = @WHERE + ' AND (a.TC=''CB'' OR a.TC=''CBFP'') '
	else
		SET @WHERE = @WHERE + ' AND (a.TC=''TK'' OR a.TC=''TKFC'' OR a.TC=''FP'' OR a.TC=''FC'') '

	if @tc = 'CB'
		SET @rs = '
		SELECT CONVERT(NVARCHAR(10),a.fecha,103) as fecha, a.tc, a.SUCURSAL + a.NUMERO + a.LETRA AS idcomprobante, a.cuenta, b.DESCRIPCION AS nombre, convert(varchar,convert(decimal(15,2),a.importe)) as importe
		FROM MV_ASIENTOS a INNER JOIN MA_CUENTAS b ON a.CUENTA = b.CODIGO
		LEFT JOIN MV_APLICACION c ON a.tc=c.tc and a.sucursal=c.sucursal and a.numero = c.numero and a.letra = c.letra
		WHERE a.SECUENCIA = 1 AND (c.tco_origen IS NULL OR c.tco_origen = '''') ' + @WHERE
	else
		SET @rs = '
		SELECT CONVERT(NVARCHAR(10),a.fecha,103) as fecha, a.tc, a.SUCURSAL + a.NUMERO + a.LETRA AS idcomprobante, a.cuenta, b.DESCRIPCION AS nombre, convert(varchar,convert(decimal(15,2),a.importe)) as importe
		FROM MV_ASIENTOS a INNER JOIN MA_CUENTAS b ON a.CUENTA = b.CODIGO
		LEFT JOIN MV_APLICACION c ON a.tc=c.tco_origen and a.sucursal=c.sucursal_origen and a.numero = c.numero_origen and a.letra = c.letra_origen
		WHERE a.SECUENCIA = 1 AND (c.tc IS NULL OR c.tc = '''') ' + @WHERE


	EXEC(@rs)

END







GO

/****** Object:  StoredProcedure [dbo].[sp_web_getCuentaCorriente]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO












CREATE PROCEDURE [dbo].[sp_web_getCuentaCorriente]
	@cuenta nvarchar(9),
	@fechaD nvarchar(10),
	@fechaH nvarchar(10),
	@ocultaSaldoCero nvarchar(1),
	@idvendedor nvarchar(4) = ''

AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @WHERE NVARCHAR(250)
	DECLARE @rs NVARCHAR(MAX)

	CREATE TABLE #temp
	(
		[fechaorden] [nvarchar] (50) COLLATE  Latin1_General_CI_AI ,
		[fecha] [nvarchar] (10) COLLATE  Latin1_General_CI_AI ,
		[comprobante] [nvarchar] (50) COLLATE  Latin1_General_CI_AI NOT NULL,
		[detalle] [nvarchar] (100) COLLATE  Latin1_General_CI_AI NOT NULL,
		[importe] [nvarchar] (50) COLLATE  Latin1_General_CI_AI NOT NULL,
		[saldo] [nvarchar] (50) COLLATE  Latin1_General_CI_AI NOT NULL,
		[estado] [nvarchar] (50) COLLATE  Latin1_General_CI_AI NOT NULL,
	)

	SET @WHERE = ''


	IF @cuenta <> ''
		SET @WHERE = ' AND a.Cuenta =''' + @cuenta + ''''

	IF @fechaD != '' AND @fechaH != ''
		SET @WHERE = @WHERE + ' AND (a.Fecha >= ''' + @fechaD + ''' AND a.FECHA<= ''' + @fechaH + ''')'
	ELSE
		BEGIN
		IF @fechaD != ''
				SET @WHERE = @WHERE + ' AND a.Fecha >= ''' + @fechaD + ''''

		IF @fechaH != ''
				SET @WHERE = @WHERE + ' AND a.Fecha <= ''' + @fechaH + ''''
	END

	IF @ocultaSaldoCero = '1'
		SET @WHERE = @WHERE + ' AND saldo <> 0 '

	IF @idvendedor <> ''
		SET @WHERE = @WHERE + ' AND ltrim(c.idvendedor) = ''' + @idvendedor + ''''

	SET @rs = '
	DECLARE CRS CURSOR FOR
	SELECT fechaorden,fecha,comprobante,detalle,importe,saldo,estado,tc,sucursal,numero,letra FROM (
	SELECT a.fecha as fechaorden, CONVERT(NVARCHAR(10),a.fecha,103) as fecha,a.tc + '' - '' + a.sucursal + a.numero + a.letra as comprobante,a.detalle,
    a.importe,isnull(b.anulada,0) as anulada,a.tc,a.sucursal,a.numero,a.letra,
    convert(varchar,convert(decimal(15,2),a.saldo)) as saldo,
    case when saldo <> 0 then ''Pendiente'' else ''Pagado'' end as estado
     FROM VE_CPTES_SALDOS_TODOS a LEFT OUTER JOIN V_MV_CPTE  b
    ON a.TC=b.TC AND a.SUCURSAL = b.SUCURSAL AND a.NUMERO=b.NUMERO AND a.LETRA=b.LETRA 
    LEFT JOIN MA_CUENTASADIC c ON c.codigo = b.cuenta
    WHERE a.tc<>'''' ' + @WHERE + ' 
	) as d WHERE anulada=0 ORDER BY fechaorden ASC
	'

	exec sp_executesql  @rs

	DECLARE @fechaOrden NVARCHAR(20),@fecha NVARCHAR(10),@comprobante NVARCHAR(50),@detalle NVARCHAR(100),@importe MONEY,@saldo NVARCHAR(50),@estado NVARCHAR(50)
	DECLARE @tc NVARCHAR(4),@sucursal NVARCHAR(4),@numero NVARCHAR(8),@letra NVARCHAR(1)
	DECLARE @saldoTemp MONEY
	SET @saldoTemp = 0

	OPEN CRS
	FETCH NEXT FROM CRS INTO @fechaOrden ,@fecha,@comprobante,@detalle,@importe, @saldo,@estado,@tc,@sucursal,@numero,@letra
	WHILE @@FETCH_STATUS = 0
	BEGIN
		
		--SET @saldoTemp = @saldoTemp + @importe

		SELECT @saldoTemp = ISNULL(SALDO,0) FROM VE_CPTES_SALDOS_TODOS WHERE TC=@tc AND SUCURSAL=@sucursal AND NUMERO=@numero AND LETRA=@letra
		IF @saldoTemp IS NULL SET @saldoTemp = 0

		INSERT INTO #temp
			(fechaorden,fecha,comprobante,detalle,importe,saldo,estado)
		VALUES
			(@fechaOrden ,@fecha,@comprobante,@detalle,convert(varchar,convert(decimal(15,2),@importe)), convert(varchar,convert(decimal(15,2),@saldoTemp)),'')
		
	FETCH NEXT FROM CRS INTO @fechaOrden ,@fecha,@comprobante,@detalle,@importe, @saldo,@estado,@tc,@sucursal,@numero,@letra
	END
	CLOSE CRS
	DEALLOCATE CRS


	SELECT * FROM #temp

END






GO

/****** Object:  StoredProcedure [dbo].[sp_web_getDatosEmpresa]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO














CREATE PROCEDURE [dbo].[sp_web_getDatosEmpresa]
AS
BEGIN

	SET NOCOUNT ON;

	CREATE TABLE #temp
	(
		[calle] [nvarchar] (100) COLLATE  Latin1_General_CI_AI ,
		[localidad] [nvarchar] (50) COLLATE  Latin1_General_CI_AI NOT NULL,
		[provincia] [nvarchar] (50) COLLATE  Latin1_General_CI_AI NOT NULL,
		[telefono] [nvarchar] (100) COLLATE  Latin1_General_CI_AI NOT NULL,
		[cuit] [nvarchar] (20) COLLATE  Latin1_General_CI_AI NOT NULL,
		[nro_iibb][nvarchar] (50) COLLATE  Latin1_General_CI_AI NOT NULL,
		[inicio_actividades] [nvarchar] (50) COLLATE  Latin1_General_CI_AI NOT NULL,
		[nombre] [nvarchar] (100) COLLATE  Latin1_General_CI_AI NOT NULL
	)

	DECLARE @nombre NVARCHAR(100)
	DECLARE @calle NVARCHAR(100)
	DECLARE @localidad NVARCHAR(50)
	DECLARE @provincia NVARCHAR(50)
	DECLARE @telefono NVARCHAR(100)
	DECLARE @cuit NVARCHAR(20)
	DECLARE @nro_iibb NVARCHAR(50)
	DECLARE @inicio_actividades NVARCHAR(50)

	SET @calle = (select VALOR AS calle
	from TA_CONFIGURACION
	where CLAVE='CALLE')
	SET @localidad = (select VALOR AS calle
	from TA_CONFIGURACION
	where CLAVE='LOCALIDAD')
	SET @provincia = (select VALOR AS calle
	from TA_CONFIGURACION
	where CLAVE='PROVINCIA')
	SET @telefono = (select VALOR AS calle
	from TA_CONFIGURACION
	where CLAVE='TELEFONO')
	SET @cuit = (select VALOR AS calle
	from TA_CONFIGURACION
	where CLAVE='CUIT')
	SET @nro_iibb = (select VALOR AS calle
	from TA_CONFIGURACION
	where CLAVE='NROINGRESOSBRUTOS')
	SET @inicio_actividades = (select VALOR AS calle
	from TA_CONFIGURACION
	where CLAVE='INICIOACTIVIDADES')
	SET @nombre = (select VALOR AS calle
	from TA_CONFIGURACION
	where CLAVE='NOMBRE')

	INSERT INTO #temp
		(nombre,calle,localidad,provincia,telefono,cuit,nro_iibb,inicio_actividades)
	VALUES
		(ISNULL(@nombre,''), ISNULL(@calle,'') , isnull(@localidad,''), isnull(@provincia,''), isnull(@telefono,0), isnull(@cuit,0), isnull(@nro_iibb,0), isnull(@inicio_actividades,0))

	SELECT *
	FROM #temp

END







GO

/****** Object:  StoredProcedure [dbo].[sp_web_getDestinatariosTransporte]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO












CREATE PROCEDURE [dbo].[sp_web_getDestinatariosTransporte]
	@cliente nvarchar(6) = ''
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @WHERE NVARCHAR(250)
	DECLARE @rs NVARCHAR(MAX)
	DECLARE @BASETTE NVARCHAR(250)

	SET @BASETTE = (SELECT VALOR
	FROM TA_CONFIGURACION
	WHERE CLAVE='SAT_BASEDEDATOS')

	SET @rs = '
	USE ' + @BASETTE + '
	SELECT ltrim(codigo) as codigo,isnull(nombre,'''') as nombre,isnull(domicilio,'''') as domicilio,isnull(localidad,'''') as localidad 
	FROM MA_Destinatarios WHERE cliente=''' + @cliente + ''''


	EXEC(@rs)

END







GO

/****** Object:  StoredProcedure [dbo].[sp_web_getDetalleDiarioCaja]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO











CREATE PROCEDURE [dbo].[sp_web_getDetalleDiarioCaja]
	@fecha datetime,
	@idcaja nvarchar(4),
	@esMensual BIT = 0
AS
BEGIN

	SET NOCOUNT ON;

	CREATE TABLE #temp
	(
		[fecha] [nvarchar] (50) COLLATE  Latin1_General_CI_AI ,
		[rubro] [nvarchar] (50) COLLATE  Latin1_General_CI_AI NOT NULL,
		[descripcion] [nvarchar] (100) COLLATE  Latin1_General_CI_AI NOT NULL,
		[importe] [money],
		[efectivo] [money],
		[tarjeta] [money],
		[saldo] [money],
		[debito] [money],
		[nombre] [nvarchar] (50) COLLATE  Latin1_General_CI_AI NOT NULL,
		[formapago] [nvarchar] (50) COLLATE  Latin1_General_CI_AI NOT NULL,
		[factura] [nvarchar] (50) COLLATE  Latin1_General_CI_AI NOT NULL
	)

	DECLARE @fhDesde DATE
	DECLARE @fhHasta DATE

	IF @esMensual = 1
		BEGIN
		SET @fhDesde = (SELECT CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(@fecha)-1),@fecha),103))
		SET @fhHasta = (SELECT CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,@fecha))),DATEADD(mm,1,@fecha)),103))
	END
	ELSE
		BEGIN
		SET @fhDesde = @fecha
		SET @fhHasta = @fecha
	END

	DECLARE @desrubro NVARCHAR(30)
	DECLARE @descripcion NVARCHAR(150)
	DECLARE @valorfinal MONEY
	DECLARE @efectivo MONEY
	DECLARE @tarjeta MONEY
	DECLARE @debito MONEY
	DECLARE @saldo MONEY
	DECLARE @nombre NVARCHAR(150)
	DECLARE @formapago NVARCHAR(100)
	DECLARE @tc NVARCHAR(4)
	DECLARE @idcomprobante NVARCHAR(13)
	DECLARE @cuenta NVARCHAR(9)

	IF @idcaja <>''
		DECLARE CRS CURSOR FOR
		SELECT CONVERT(NVARCHAR(10),Fecha,103) as fecha, DescRubro as rubro, descripcion, valorfinal, nombre, TC, IDCOMPROBANTE, cuenta
	FROM (
		SELECT A.TC, A.IDCOMPROBANTE, A.SUCURSAL, A.NUMERO, A.LETRA, A.Fecha, A.IDArticulo, A.IDVENDEDOR, A.Consumo, A.UNEGOCIO, A.ValorCosto, A.ValorVenta, A.cuenta,
			A.ArtMoneda, A.ArtCotizacion, A.NOMBRE, A.IVARI, A.DtoItem, A.Usuario, A.ValorVenta * (1 + A.IVARI / 100) * - 1 AS VALORFINAL,
			dbo.V_TA_Rubros.Descripcion AS DescRubro, dbo.V_TA_Rubros.IdRubro, dbo.V_MA_ARTICULOS.DESCRIPCION, dbo.MV_ASIENTOS.IdCajas
		FROM dbo.MV_ASIENTOS RIGHT OUTER JOIN
			(SELECT dbo.V_MV_Stock.TC, dbo.V_MV_Stock.IDCOMPROBANTE, dbo.V_MV_Cpte.SUCURSAL, dbo.V_MV_Cpte.NUMERO, dbo.V_MV_Cpte.LETRA,
				ISNULL(dbo.V_MV_Cpte.FECHA, dbo.V_MV_Stock.FECHA) AS Fecha, dbo.V_MV_Stock.IDArticulo, dbo.V_MV_Stock.IDVENDEDOR,
				SUM(dbo.V_MV_Stock.CantidadUD) AS Consumo, dbo.V_MV_Stock.UNEGOCIO, SUM(dbo.V_MV_Stock.Costo * dbo.V_MV_Stock.Cantidad) AS ValorCosto,
				SUM(dbo.V_MV_Stock.IMPORTE_S_IVA * dbo.V_MV_Stock.Cantidad) - SUM(dbo.V_MV_Stock.IMPORTE_S_IVA * ISNULL(dbo.V_MV_Cpte.PorcDescuento1,
		0) / 100 * dbo.V_MV_Stock.Cantidad) - SUM(dbo.V_MV_Stock.IMPORTE_S_IVA * ISNULL(dbo.V_MV_Cpte.PorcDescuento2, 0)
		/ 100 * dbo.V_MV_Stock.Cantidad) - SUM(dbo.V_MV_Stock.IMPORTE_S_IVA * ISNULL(dbo.V_MV_Cpte.PorcDescuento3, 0)
		/ 100 * dbo.V_MV_Stock.Cantidad) - SUM(dbo.V_MV_Stock.IMPORTE_S_IVA * ISNULL(dbo.V_MV_Cpte.PorcDescuento4, 0)
		/ 100 * dbo.V_MV_Stock.Cantidad) - SUM(dbo.V_MV_Stock.IMPORTE_S_IVA * dbo.V_MV_Stock.DtoItem / 100 * dbo.V_MV_Stock.Cantidad) AS ValorVenta,
				dbo.V_MV_Stock.CuentaProveedor AS cuenta, dbo.V_MV_Stock.ArtMoneda, dbo.V_MV_Stock.ArtCotizacion, dbo.V_MV_Stock.IVARI,
				dbo.V_MV_Stock.DtoItem , dbo.V_MV_Cpte.Usuario, dbo.V_MV_Cpte.Nombre
			FROM dbo.V_MV_Stock LEFT OUTER JOIN
				dbo.V_MV_Cpte ON dbo.V_MV_Stock.TC = dbo.V_MV_Cpte.TC AND dbo.V_MV_Stock.IDCOMPROBANTE = dbo.V_MV_Cpte.IDCOMPROBANTE
			WHERE (dbo.V_MV_Stock.Anulado = 0) AND (dbo.V_MV_Cpte.TC = 'FC' OR dbo.V_MV_Cpte.TC = 'FP' OR dbo.V_MV_Cpte.TC = 'TK' OR
				dbo.V_MV_Cpte.TC = 'TKFC' OR dbo.V_MV_Cpte.TC = 'NC' OR dbo.V_MV_Cpte.TC = 'NCFP') AND (dbo.V_MV_Cpte.FECHA >= @fhDesde and dbo.V_MV_CPTE.FECHA <= @fhHasta)
			GROUP BY dbo.V_MV_Stock.TC, dbo.V_MV_Stock.IDCOMPROBANTE, dbo.V_MV_Cpte.FECHA, dbo.V_MV_Stock.FECHA, dbo.V_MV_Stock.IDArticulo,
		dbo.V_MV_Stock.IDVENDEDOR, dbo.V_MV_Stock.CuentaProveedor, dbo.V_MV_Stock.ArtMoneda, dbo.V_MV_Stock.DtoItem,
		dbo.V_MV_Stock.ArtCotizacion, dbo.V_MV_Stock.IVARI, dbo.V_MV_Stock.UNEGOCIO, dbo.V_MV_Cpte.Usuario, dbo.V_MV_Cpte.NOMBRE,
		dbo.V_MV_Cpte.SUCURSAL, dbo.V_MV_Cpte.NUMERO, dbo.V_MV_Cpte.LETRA) AS A ON dbo.MV_ASIENTOS.CUENTA = A.cuenta AND
				dbo.MV_ASIENTOS.TC = A.TC AND dbo.MV_ASIENTOS.SUCURSAL = A.SUCURSAL AND dbo.MV_ASIENTOS.NUMERO = A.NUMERO AND
				dbo.MV_ASIENTOS.LETRA = A.LETRA LEFT OUTER JOIN
			dbo.V_TA_Rubros LEFT OUTER JOIN
			dbo.V_MA_ARTICULOS ON dbo.V_TA_Rubros.IdRubro = dbo.V_MA_ARTICULOS.IDRUBRO ON A.IDArticulo = dbo.V_MA_ARTICULOS.IDARTICULO
		WHERE  ltrim(IDCAJAS) =  @idcaja ) AS A
	ORDER BY Fecha,idcomprobante
	ELSE
		DECLARE CRS CURSOR FOR
		SELECT CONVERT(NVARCHAR(10),Fecha,103) as fecha, DescRubro as rubro, descripcion, valorfinal, nombre, TC, IDCOMPROBANTE, cuenta
	FROM (
		SELECT A.TC, A.IDCOMPROBANTE, A.SUCURSAL, A.NUMERO, A.LETRA, A.Fecha, A.IDArticulo, A.IDVENDEDOR, A.Consumo, A.UNEGOCIO, A.ValorCosto, A.ValorVenta, A.cuenta,
			A.ArtMoneda, A.ArtCotizacion, A.NOMBRE, A.IVARI, A.DtoItem, A.Usuario, A.ValorVenta * (1 + A.IVARI / 100) * - 1 AS VALORFINAL,
			dbo.V_TA_Rubros.Descripcion AS DescRubro, dbo.V_TA_Rubros.IdRubro, dbo.V_MA_ARTICULOS.DESCRIPCION, dbo.MV_ASIENTOS.IdCajas
		FROM dbo.MV_ASIENTOS RIGHT OUTER JOIN
			(SELECT dbo.V_MV_Stock.TC, dbo.V_MV_Stock.IDCOMPROBANTE, dbo.V_MV_Cpte.SUCURSAL, dbo.V_MV_Cpte.NUMERO, dbo.V_MV_Cpte.LETRA,
				ISNULL(dbo.V_MV_Cpte.FECHA, dbo.V_MV_Stock.FECHA) AS Fecha, dbo.V_MV_Stock.IDArticulo, dbo.V_MV_Stock.IDVENDEDOR,
				SUM(dbo.V_MV_Stock.CantidadUD) AS Consumo, dbo.V_MV_Stock.UNEGOCIO, SUM(dbo.V_MV_Stock.Costo * dbo.V_MV_Stock.Cantidad) AS ValorCosto,
				SUM(dbo.V_MV_Stock.IMPORTE_S_IVA * dbo.V_MV_Stock.Cantidad) - SUM(dbo.V_MV_Stock.IMPORTE_S_IVA * ISNULL(dbo.V_MV_Cpte.PorcDescuento1,
		0) / 100 * dbo.V_MV_Stock.Cantidad) - SUM(dbo.V_MV_Stock.IMPORTE_S_IVA * ISNULL(dbo.V_MV_Cpte.PorcDescuento2, 0)
		/ 100 * dbo.V_MV_Stock.Cantidad) - SUM(dbo.V_MV_Stock.IMPORTE_S_IVA * ISNULL(dbo.V_MV_Cpte.PorcDescuento3, 0)
		/ 100 * dbo.V_MV_Stock.Cantidad) - SUM(dbo.V_MV_Stock.IMPORTE_S_IVA * ISNULL(dbo.V_MV_Cpte.PorcDescuento4, 0)
		/ 100 * dbo.V_MV_Stock.Cantidad) - SUM(dbo.V_MV_Stock.IMPORTE_S_IVA * dbo.V_MV_Stock.DtoItem / 100 * dbo.V_MV_Stock.Cantidad) AS ValorVenta,
				dbo.V_MV_Stock.CuentaProveedor AS cuenta, dbo.V_MV_Stock.ArtMoneda, dbo.V_MV_Stock.ArtCotizacion, dbo.V_MV_Stock.IVARI,
				dbo.V_MV_Stock.DtoItem , dbo.V_MV_Cpte.Usuario, dbo.V_MV_Cpte.Nombre
			FROM dbo.V_MV_Stock LEFT OUTER JOIN
				dbo.V_MV_Cpte ON dbo.V_MV_Stock.TC = dbo.V_MV_Cpte.TC AND dbo.V_MV_Stock.IDCOMPROBANTE = dbo.V_MV_Cpte.IDCOMPROBANTE
			WHERE (dbo.V_MV_Stock.Anulado = 0) AND (dbo.V_MV_Cpte.TC = 'FC' OR dbo.V_MV_Cpte.TC = 'FP' OR dbo.V_MV_Cpte.TC = 'TK' OR
				dbo.V_MV_Cpte.TC = 'TKFC' OR dbo.V_MV_Cpte.TC = 'NC' OR dbo.V_MV_Cpte.TC = 'NCFP') AND (dbo.V_MV_Cpte.FECHA >= @fhDesde and dbo.V_MV_CPTE.FECHA <= @fhHasta)
			GROUP BY dbo.V_MV_Stock.TC, dbo.V_MV_Stock.IDCOMPROBANTE, dbo.V_MV_Cpte.FECHA, dbo.V_MV_Stock.FECHA, dbo.V_MV_Stock.IDArticulo,
		dbo.V_MV_Stock.IDVENDEDOR, dbo.V_MV_Stock.CuentaProveedor, dbo.V_MV_Stock.ArtMoneda, dbo.V_MV_Stock.DtoItem,
		dbo.V_MV_Stock.ArtCotizacion, dbo.V_MV_Stock.IVARI, dbo.V_MV_Stock.UNEGOCIO, dbo.V_MV_Cpte.Usuario, dbo.V_MV_Cpte.NOMBRE,
		dbo.V_MV_Cpte.SUCURSAL, dbo.V_MV_Cpte.NUMERO, dbo.V_MV_Cpte.LETRA) AS A ON dbo.MV_ASIENTOS.CUENTA = A.cuenta AND
				dbo.MV_ASIENTOS.TC = A.TC AND dbo.MV_ASIENTOS.SUCURSAL = A.SUCURSAL AND dbo.MV_ASIENTOS.NUMERO = A.NUMERO AND
				dbo.MV_ASIENTOS.LETRA = A.LETRA LEFT OUTER JOIN
			dbo.V_TA_Rubros LEFT OUTER JOIN
			dbo.V_MA_ARTICULOS ON dbo.V_TA_Rubros.IdRubro = dbo.V_MA_ARTICULOS.IDRUBRO ON A.IDArticulo = dbo.V_MA_ARTICULOS.IDARTICULO
		) AS A
	ORDER BY Fecha,idcomprobante

	DECLARE @aTc NVARCHAR(4)
	DECLARE @aSuc NVARCHAR(4)
	DECLARE @aNum NVARCHAR(8)
	DECLARE @aLet NVARCHAR(1)
	DECLARE @medioDePago NVARCHAR(4)
	DECLARE @tcApp NVARCHAR(4)
	DECLARE @importeApp MONEY
	DECLARE @sumaEF MONEY
	DECLARE @sumaVenta MONEY
	DECLARE @sumaDeb MONEY
	DECLARE @sumaDebitos MONEY
	DECLARE @nombreApp NVARCHAR(150)
	DECLARE @sumaTJ MONEY
	DECLARE @sumaCreditos MONEY
	DECLARE @saldoCpte MONEY
	DECLARE @saldoTmp MONEY
	DECLARE @fechaTmp NVARCHAR(20)
	DECLARE @cpteAnterior NVARCHAR(13)

	OPEN CRS
	FETCH NEXT FROM CRS INTO @fechaTmp ,@desrubro,@descripcion,@valorfinal,@nombre, @tc,@idcomprobante,@cuenta
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @sumaEF = 0
		SET @sumaDeb = 0
		SET @sumaTJ = 0
		SET @aTc = ''
		SET @aNum = ''
		SET @aLet = ''
		SET @aSuc = ''

		IF @tc = 'NC' or @tc='NCFP'
			BEGIN
			SELECT @aTc = TCO_ORIGEN, @aSuc = SUCURSAL_ORIGEN, @aNum = NUMERO_ORIGEN, @aLet = LETRA_ORIGEN
			FROM MV_APLICACION
			WHERE TC=@tc AND SUCURSAL=SUBSTRING(@idcomprobante,1,4) AND NUMERO=SUBSTRING(@idcomprobante,5,8) AND LETRA = SUBSTRING(@idcomprobante,13,1) AND importe > 0

			IF @aTc <>'' AND @aNum <> ''
					BEGIN
				SELECT @aTc = TC, @aSuc = SUCURSAL, @aNum = NUMERO, @aLet = LETRA
				FROM MV_APLICACION
				WHERE TCO_ORIGEN=@aTc AND SUCURSAL_ORIGEN=@aSuc AND NUMERO_ORIGEN=@aNum AND LETRA_ORIGEN = @aLet
			END
				ELSE
					SELECT @aTc = TCORIGEN, @aSuc = SUBSTRING(ComprobanteOrigen,1,4), @aNum = SUBSTRING(ComprobanteOrigen,5,8), @aLet = SUBSTRING(ComprobanteOrigen,13,1)
			FROM V_MV_CPTE
			WHERE TC=@tc AND IDCOMPROBANTE=@idcomprobante
			IF @aTc <>'' AND @aNum <> ''
						BEGIN
				SELECT @aTc = TC, @aSuc = SUCURSAL, @aNum = NUMERO, @aLet = LETRA
				FROM MV_APLICACION
				WHERE TCO_ORIGEN=@aTc AND SUCURSAL_ORIGEN=@aSuc AND NUMERO_ORIGEN=@aNum AND LETRA_ORIGEN = @aLet and IMPORTE > 0
			END
		END
		ELSE
			SELECT @aTc = TC, @aSuc = SUCURSAL, @aNum = NUMERO, @aLet = LETRA
		FROM MV_APLICACION
		WHERE TCO_ORIGEN=@tc AND SUCURSAL_ORIGEN=SUBSTRING(@idcomprobante,1,4)
			AND NUMERO_ORIGEN=SUBSTRING(@idcomprobante,5,8) AND LETRA_ORIGEN = SUBSTRING(@idcomprobante,13,1) AND IMPORTE <> 0

		BEGIN

			IF @aTc <> '' AND @aSuc <> '' AND @aNum <> '' AND @aLet <> ''
				SELECT @tcApp = v_cobranzasporusuario.TC, @medioDePago = isnull(v_cobranzasporusuario.MedioDePago, ''), @nombreApp = MA_CUENTAS.DESCRIPCION,
				@importeApp = (sum(Importe * CASE WHEN v_cobranzasporusuario.[debe-haber] = 'D' THEN 1 ELSE -1 END))
			FROM v_cobranzasporusuario LEFT JOIN MA_CUENTAS ON v_cobranzasporusuario.CUENTA = MA_CUENTAS.CODIGO
			WHERE TC=@aTc AND SUCURSAL=@aSuc AND LETRA=@aLet AND NUMERO=@aNum
			GROUP BY v_cobranzasporusuario.TC,v_cobranzasporusuario.SUCURSAL,v_cobranzasporusuario.NUMERO,v_cobranzasporusuario.LETRA,
				v_cobranzasporusuario.MedioDePago,v_cobranzasporusuario.cuenta,v_cobranzasporusuario.[debe-haber],MA_CUENTAS.DESCRIPCION
			ELSE
				BEGIN
				SET @medioDePago = ''
				SET @importeApp = 0
			END

			SET @medioDePago = ISNULL(@medioDePago, '')
			SET @importeApp = ISNULL(@importeApp,0)

			IF @medioDePago = 'EF'
				BEGIN
				IF @tc = 'NC' or @tc = 'NCFP'						
						SET @sumaEF = @importeApp * -1						
					ELSE						
						SET @sumaEF = @importeApp
			END
			ELSE IF @medioDePago = 'TJ'
				BEGIN
				IF CHARINDEX('Debito',@nombreApp,1) > 0 or CHARINDEX('D?bito',@nombreApp,1) > 0
						BEGIN
					IF @tc = 'NC' or @tc = 'NCFP'
								SET @sumaDeb = @importeApp * -1
							ELSE
								SET @sumaDeb =  @importeApp
				END
					ELSE
						BEGIN
					IF @tc = 'NC' or @tc = 'NCFP'
								SET @sumaTJ = @importeApp * -1
							ELSE
								SET @sumaTJ = @importeApp
				END
			END



			SELECT @saldoCpte = isnull(SUM(SALDO),0)
			FROM VE_CPTES_SALDOS
			WHERE TC=@tc AND SUCURSAL+NUMERO+LETRA=@idcomprobante AND CUENTA=@cuenta
			SET @saldoCpte = ISNULL(@saldoCpte,0)
			IF @saldoCpte > 0
				BEGIN
				SELECT @saldoTmp = isnull(importe,0)
				FROM V_MV_CPTE
				WHERE TCORIGEN=@tc AND COMPROBANTEORIGEN=@idcomprobante AND (TC='NC' OR TC='NCFP') AND IMPORTE>0
				SET @saldoCpte = @saldoCpte - isnull(@saldoTmp,0)

				IF @saldoCpte < 0 SET @saldoCpte = 0
			END

			IF @medioDePago = '' AND @saldoCpte = 0
				SET @sumaEF = @valorfinal

			BEGIN
				SET @sumaEF = ISNULL(@sumaEF,0)
				SET @sumaTJ = isnull(@sumaTJ,0)
				SET @sumaDeb = ISNULL(@sumaDeb,0)

				SET @formapago = 'Cta Cte'
				IF (@sumaEF > 0 AND @sumaTJ > 0) OR (@sumaEF >0 AND @sumaDeb>0) OR (@sumaTJ>0 AND @sumaDeb > 0)
					SET @formapago = 'Varios'
				IF @sumaEf > 0 AND @sumaTJ = 0 AND @sumaDeb = 0
					SET @formapago = 'Efectivo'
				IF @sumaEF = 0 AND @sumaTJ > 0 AND @sumaDeb = 0
					SET @formapago = 'Tarjeta'
				IF @sumaEF = 0 AND @sumaTJ = 0 AND @sumaDeb > 0
					SET @formapago = 'D?bito'
			END

		END

		BEGIN
			IF isnull(@cpteAnterior,'') = @idcomprobante
				BEGIN
				SET @sumaDeb = 0
				SET @sumaTJ = 0
				SET @sumaEF = 0
			END
		END
		SET @cpteAnterior = @idcomprobante

		INSERT INTO #temp
			(fecha,rubro,descripcion,importe,efectivo,tarjeta,saldo,debito,nombre,formapago,factura)
		VALUES
			(@fechaTmp , isnull(@desrubro,''), isnull(@descripcion,''), isnull(@valorfinal,0), @sumaEF, @sumaTJ, isnull(@saldoCpte,0), @sumaDeb, @nombre, @formapago, @tc + '-' + @idcomprobante)
		FETCH NEXT FROM CRS INTO @fechaTmp,@desrubro,@descripcion,@valorfinal,@nombre, @tc,@idcomprobante,@cuenta
	END
	CLOSE CRS
	DEALLOCATE CRS

	SELECT
		fecha,
		rubro,
		descripcion,
		convert(varchar,convert(decimal(15,2),importe)) as importe,
		convert(varchar,convert(decimal(15,2),efectivo)) as efectivo,
		convert(varchar,convert(decimal(15,2),tarjeta)) as tarjeta,
		convert(varchar,convert(decimal(15,2),debito)) as debito,
		convert(varchar,convert(decimal(15,2),saldo)) as saldo,
		nombre, formapago, factura
	FROM #temp




END





GO

/****** Object:  StoredProcedure [dbo].[sp_web_getDetalleEfectivoCaja]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO












CREATE PROCEDURE [dbo].[sp_web_getDetalleEfectivoCaja]
	@fecha datetime,
	@idcaja nvarchar(4),
	@initial BIT = 0
AS
BEGIN

	SET NOCOUNT ON;

	CREATE TABLE #temp
	(
		[nombre] [nvarchar] (50) COLLATE  Latin1_General_CI_AI NOT NULL,
		[importe] [money]
	)


	DECLARE @nombre NVARCHAR(50)
	DECLARE @cuentaEfectivo NVARCHAR(9)
	DECLARE @efectivoCobrado MONEY
	DECLARE @ingresos MONEY
	DECLARE @egresos MONEY
	DECLARE @transferencias MONEY
	DECLARE @fondoFijo MONEY
	DECLARE @inicial MONEY
	DECLARE @billetesRendidos MONEY
	DECLARE @medioDePagoContado NVARCHAR(10)
	DECLARE @resultado MONEY


	SET @medioDePagoContado = (SELECT VALOR
	FROM TA_CONFIGURACION
	WHERE CLAVE='MedioDePagoContado')
	SET @cuentaEfectivo = (SELECT CODIGO
	FROM MA_CUENTAS
	WHERE CodigoOpcional=@medioDePagoContado)

	IF @idcaja = ''
		SET @fondoFijo = isnull((Select cambioInicial
	from V_Mv_CierreCaja
	where FechaOperativa = @fecha),0)
	ELSE
		SET @fondoFijo = isnull((Select cambioInicial
	from V_Mv_CierreCaja
	where FechaOperativa = @fecha and ltrim(idCaja) = @idcaja),0)

	IF @initial = 1
		BEGIN
		IF @idcaja = ''
				SET @inicial = ISNULL((select sum(saldo) as importe
		from vt_consolidado_caja
		where cuenta = @cuentaEfectivo
			and fecha < @fecha),0)
			ELSE
				SET @inicial = ISNULL((select sum(saldo) as importe
		from vt_consolidado_caja
		where cuenta = @cuentaEfectivo
			and fecha < @fecha and ltrim(idcajas) = @idcaja),0)
	END
	ELSE
		SET @fondoFijo = 0

	INSERT INTO #temp
		(nombre,importe)
	VALUES
		('Fondo Fijo Inicial', isnull(@inicial + @fondoFijo,0))


	IF @idcaja = ''
		SET @efectivoCobrado = isnull((SELECT sum(Importe * case when [debe-haber] = 'D' then 1 else -1 end) as importe
	from mv_asientos
	where cuenta = @cuentaEfectivo and tc in ('CB','CBCT','CBFP') and fecha = @fecha and cotizacion = 1 and moneda = '   1'),0)
	ELSE
		SET @efectivoCobrado = isnull((SELECT sum(Importe * case when [debe-haber] = 'D' then 1 else -1 end) as importe
	from mv_asientos
	where cuenta = @cuentaEfectivo and tc in ('CB','CBCT','CBFP') and fecha = @fecha and ltrim(idcajas) = @idcaja and cotizacion = 1 and moneda = '   1'),0)

	INSERT INTO #temp
		(nombre,importe)
	VALUES
		('Total Efectivo Cobrado', @efectivoCobrado)


	IF @idcaja = ''
		SET @ingresos = ISNULL((SELECT sum(importe) as importe
	FROM MV_ASIENTOS
	where CUENTA = @cuentaEfectivo AND [DEBE-HABER] = 'D' and fecha = @fecha and not tc in('CB','CBCT','CBFP','TK ','TKFC','FC')
		and cotizacion = 1 and moneda = '   1'
	group by Cuenta),0)
	ELSE
		SET @ingresos = ISNULL((SELECT sum(importe) as importe
	FROM MV_ASIENTOS
	where CUENTA = @cuentaEfectivo AND [DEBE-HABER] = 'D' and fecha = @fecha and ltrim(idcajas) = @idcaja and not tc in('CB','CBCT','CBFP','TK ','TKFC','FC')
		and cotizacion = 1 and moneda = '   1'
	group by Cuenta),0)

	INSERT INTO #temp
		(nombre,importe)
	VALUES
		('Total Ingresos', @ingresos)


	IF @idcaja = ''
		SET @transferencias = ISNULL((Select sum(egreso) as importe
	from vt_transferenciascaja
	where cuenta = @cuentaEfectivo
		and fecha = @fecha and cotizacion = 1 and moneda = '   1'),0)
	ELSE
		SET @transferencias = ISNULL((Select sum(egreso) as importe
	from vt_transferenciascaja
	where cuenta = @cuentaEfectivo
		and fecha = @fecha and ltrim(origen) = @idcaja and cotizacion = 1 and moneda = '   1'),0)

	IF @idcaja = ''
		SET @egresos = ISNULL((SELECT sum(importe) as importe
	FROM MV_ASIENTOS
	where CUENTA = @cuentaEfectivo AND [DEBE-HABER] = 'H'
		and not tc in('CB','CBCT','CBFP','TK ','TKFC','FC') and fecha = @fecha and cotizacion = 1 and moneda = '   1'
	group by Cuenta),0)
	ELSE
		SET @egresos = ISNULL((SELECT sum(importe) as importe
	FROM MV_ASIENTOS
	where CUENTA = @cuentaEfectivo AND [DEBE-HABER] = 'H'
		and not tc in('CB','CBCT','CBFP','TK ','TKFC','FC') and fecha = @fecha and ltrim(idcajas) = @idcaja and cotizacion = 1 and moneda = '   1'
	group by Cuenta),0)

	INSERT INTO #temp
		(nombre,importe)
	VALUES
		('Total Egresos', @egresos - @transferencias)

	INSERT INTO #temp
		(nombre,importe)
	VALUES
		('Total Transferencias', @transferencias)


	IF @idcaja = ''
		SET @billetesRendidos = ISNULL((Select SUM(TotalEfectivoInformado) as importe
	from V_Mv_CierreCaja
	where FechaOperativa = @fecha),0)
	ELSE
		SET @billetesRendidos = ISNULL((Select SUM(TotalEfectivoInformado) as importe
	from V_Mv_CierreCaja
	where FechaOperativa = @fecha and ltrim(IdCaja)=@idcaja),0)

	INSERT INTO #temp
		(nombre,importe)
	VALUES
		('Total Billetes Rendidos', @billetesRendidos)


	SET @resultado = isnull(@billetesRendidos + @transferencias + @egresos,0)
	SET @resultado = isnull(@resultado - @ingresos - @efectivoCobrado - @inicial - @fondoFijo,0)


	if @resultado < 0
		INSERT INTO #temp
		(nombre,importe)
	VALUES
		('Diferencia (SOBRANTE DE CAJA)', @resultado *-1)
	ELSE
		INSERT INTO #temp
		(nombre,importe)
	VALUES
		('Diferencia (FALTANTE DE CAJA)', @resultado)


	SELECT
		nombre,
		convert(varchar,convert(decimal(15,2),importe)) as importe
	FROM #temp




END





GO

/****** Object:  StoredProcedure [dbo].[sp_web_getDetallePorProductoCaja]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO











CREATE PROCEDURE [dbo].[sp_web_getDetallePorProductoCaja]
	@fecha nvarchar(25)
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @rs NVARCHAR(MAX)


	SET @rs = '
	SELECT articulo,cantidad,valorventa,aliciva,valorventa_civa FROM (
	SELECT ltrim(IdArticulo) + '' - '' + descripcion as articulo,
    convert(varchar,convert(decimal(15,2),SUM(Consumo) *-1)) as cantidad,
    convert(varchar,convert(decimal(15,2),SUM(ValorVenta) *-1)) as valorventa,
    idrubro,descrubro,IvaRI as aliciva,
    convert(varchar,convert(decimal(15,2),((SUM(ValorVenta)*-1 * isnull(IVARI,21)) / 100) + SUM(VALORVENTA)*-1)) as ValorVenta_civa FROM (
    SELECT dbo.VT_RankingConsumo.*, dbo.VT_MA_Articulos.DescRubro, dbo.VT_MA_Articulos.IDRUBRO, dbo.VT_MA_Articulos.DESCRIPCION
    FROM dbo.VT_RankingConsumo LEFT OUTER JOIN dbo.VT_MA_Articulos ON dbo.VT_RankingConsumo.IdArticulo = dbo.VT_MA_Articulos.IDARTICULO
    Where fecha=''' + @fecha + '''
    ) AS A GROUP BY IdRubro,DescRubro,IdArticulo,DESCRIPCION,IvaRI --ORDER BY idrubro,idarticulo,ValorVenta
    ) AS b ORDER BY ValorVenta
   '

	EXEC(@rs)

END







GO

/****** Object:  StoredProcedure [dbo].[sp_web_getDetallePorRubroCaja]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO












CREATE PROCEDURE [dbo].[sp_web_getDetallePorRubroCaja]
	@fecha nvarchar(25)
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @rs NVARCHAR(MAX)


	SET @rs = '
	SELECT ltrim(idrubro) + '' - '' + descrubro as rubro,cantidad,valorventa,aliciva,valorventa_civa FROM (
    SELECT ISNULL(IdRubro,'''') as idrubro,isnull(DescRubro,'''') as descrubro,convert(varchar,convert(decimal(15,2),SUM(CONSUMO)*-1)) as cantidad,
    convert(varchar,convert(decimal(15,2),SUM(ValorVenta)*-1)) as valorventa,convert(varchar,convert(decimal(15,2),IVARI)) as aliciva,
    convert(varchar,convert(decimal(15,2),((SUM(ValorVenta)*-1 * isnull(IVARI,21)) / 100) + SUM(VALORVENTA)*-1)) as ValorVenta_civa
    FROM ( SELECT dbo.VT_RankingConsumo.*, dbo.VT_MA_Articulos.DescRubro, dbo.VT_MA_Articulos.IDRUBRO
    FROM dbo.VT_RankingConsumo LEFT OUTER JOIN dbo.VT_MA_Articulos ON dbo.VT_RankingConsumo.IdArticulo = dbo.VT_MA_Articulos.IDARTICULO
    Where Fecha = ''' + @fecha + ''') AS a GROUP BY ISNULL(IdRubro,'''') ,DescRubro,IVARI
    ) AS b ORDER BY ValorVenta'

	EXEC(@rs)

END







GO

/****** Object:  StoredProcedure [dbo].[sp_web_getDetalleVentasPorCpteCaja]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO












CREATE PROCEDURE [dbo].[sp_web_getDetalleVentasPorCpteCaja]
	@fecha nvarchar(25),
	@idcaja nvarchar(4),
	@cobranzas BIT
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @WHERE NVARCHAR(MAX)
	DECLARE @rs NVARCHAR(MAX)


	SET @WHERE = ''

	if @fecha != ''
		SET @WHERE = @WHERE + ' AND dbo.MV_ASIENTOS.FECHA = ''' + @fecha + ''''

	IF @idcaja != ''
		SET @WHERE = @WHERE + ' AND LTRIM(idcajas) = ''' + @idcaja + ''''

	IF @cobranzas = 1
		SET @WHERE = @WHERE + ' AND (dbo.MV_ASIENTOS.TC = ''CBCT'' OR dbo.MV_ASIENTOS.TC = ''CB'' OR  dbo.MV_ASIENTOS.TC = ''CBFP'') '
	ELSE
		SET @WHERE = @WHERE  + ' AND (dbo.MV_ASIENTOS.TC = ''TK'' OR dbo.MV_ASIENTOS.TC = ''TKFC'' OR  dbo.MV_ASIENTOS.TC = ''FP'' OR dbo.MV_ASIENTOS.TC = ''FC'' OR dbo.MV_ASIENTOS.TC = ''CBCT'' OR dbo.MV_ASIENTOS.TC = ''CB'' OR  dbo.MV_ASIENTOS.TC = ''CBFP'' or dbo.MV_ASIENTOS.TC = ''NC'' or dbo.MV_ASIENTOS.TC = ''NCFP'') '

	SET @rs = '
	SELECT CONVERT(NVARCHAR(10),FECHA,103) as fecha,tc,idcomprobante,cuenta,isnull(nombre,'''') as nombre,
    convert(varchar,convert(decimal(15,2),case when DH=''H'' then IMPORTE * -1 else IMPORTE end)) as importe,
    isnull(ltrim(idvendedor) + '' - '' + nvendedor,'''') as vendedor,ltrim(unegocio) + '' - '' + nunegocio as unegocio,usuario,
    isnull(convert(NVARCHAR(18),FechaHora_grabacion,103) + '' '' + convert(NVARCHAR(18),FechaHora_grabacion,108),'''') as fechahora FROM(
    SELECT dbo.MV_ASIENTOS.[DEBE-HABER] AS DH, dbo.MV_ASIENTOS.FECHA,V_TA_VENDEDORES.Nombre as nvendedor,V_TA_UnidadNegocio.Descripcion as nunegocio, dbo.MV_ASIENTOS.TC, dbo.MV_ASIENTOS.SUCURSAL + dbo.MV_ASIENTOS.NUMERO + dbo.MV_ASIENTOS.LETRA AS IDCOMPROBANTE,
    dbo.MV_ASIENTOS.UNEGOCIO, dbo.MV_ASIENTOS.IdVendedor, dbo.MV_ASIENTOS.USUARIO_LOGEADO AS Usuario, dbo.MV_ASIENTOS.CUENTA,
    dbo.MA_CUENTAS.DESCRIPCION AS NOMBRE, dbo.MV_ASIENTOS.IMPORTE, dbo.V_MV_Cpte.ANULADA, v_mv_cpte.FechaHora_grabacion
    FROM dbo.MV_ASIENTOS INNER JOIN  dbo.MA_CUENTAS ON dbo.MV_ASIENTOS.CUENTA = dbo.MA_CUENTAS.CODIGO LEFT OUTER JOIN  dbo.V_MV_Cpte
    ON dbo.MV_ASIENTOS.TC = dbo.V_MV_Cpte.TC AND dbo.MV_ASIENTOS.SUCURSAL = dbo.V_MV_Cpte.SUCURSAL AND  dbo.MV_ASIENTOS.NUMERO = dbo.V_MV_Cpte.NUMERO
    AND dbo.MV_ASIENTOS.LETRA = dbo.V_MV_Cpte.LETRA AND  dbo.MV_ASIENTOS.Cuenta = dbo.V_MV_Cpte.Cuenta
    LEFT JOIN V_TA_VENDEDORES on V_TA_VENDEDORES.IdVendedor = MV_ASIENTOS.IdVendedor
    LEFT JOIN V_TA_UnidadNegocio on V_TA_UnidadNegocio.Codigo = MV_ASIENTOS.UNEGOCIO
    WHERE (dbo.MV_ASIENTOS.SECUENCIA = 1) ' + @WHERE + '
    ) AS A ORDER BY FechaHora_Grabacion'


	EXEC(@rs)

END







GO

/****** Object:  StoredProcedure [dbo].[sp_web_getEstadosRemitosTransporte]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO












CREATE PROCEDURE [dbo].[sp_web_getEstadosRemitosTransporte]
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @WHERE NVARCHAR(250)
	DECLARE @rs NVARCHAR(MAX)
	DECLARE @BASETTE NVARCHAR(250)

	SET @BASETTE = (SELECT VALOR
	FROM TA_CONFIGURACION
	WHERE CLAVE='SAT_BASEDEDATOS')

	SET @rs = '
	USE ' + @BASETTE + '
	select ltrim(codigo) as codigo,descripcion,color from ta_estados order by CODIGO
	'

	EXEC(@rs)

END







GO

/****** Object:  StoredProcedure [dbo].[sp_web_getFamiliasArticulos]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO











CREATE PROCEDURE [dbo].[sp_web_getFamiliasArticulos]
	@idCliente nvarchar(9) = ''
AS

BEGIN

	SET NOCOUNT ON;

	DECLARE @idLista NVARCHAR(4)
	DECLARE @padre NVARCHAR(15)
	DECLARE @codigoAnterior NVARCHAR(15)
	DECLARE @codigo NVARCHAR(15)
	DECLARE @descripcion NVARCHAR(100)
	DECLARE @nCodigo NVARCHAR(15)
	DECLARE @nDescripcion NVARCHAR(100)

	CREATE TABLE #temp
	(
		[codigo] [nvarchar] (15) COLLATE  Latin1_General_CI_AI NOT NULL,
		[descripcion] [nvarchar] (100) COLLATE  Latin1_General_CI_AI NOT NULL,
	)

	IF @idCliente <>''
		SET @idLista = (SELECT isnull(idlista,'')
	from Vt_Clientes
	WHERE CODIGO=@idCliente)
	ELSE
		SET @idLista = ''


	IF @idLista <> ''
		DECLARE CRS CURSOR FOR
		SELECT codigo, descripcion
	FROM (
		SELECT c.descripcion, ltrim(c.idfamilia) as codigo
		FROM V_MA_Precios a
			LEFT JOIN V_MA_ARTICULOS B ON a.IDARTICULO = b.IDARTICULO
			LEFT JOIN V_TA_FAMILIAS c ON b.idfamilia = c.idfamilia
		WHERE b.suspendidov<>1 and (b.suspendido=0 or b.suspendido is null) and c.idfamilia<>'' and ltrim(a.idlista)=ltrim(@idlista)
		) as z
	GROUP BY codigo,descripcion
	ORDER BY codigo
	ELSE
		DECLARE CRS CURSOR FOR
		SELECT codigo, descripcion
	FROM (
		SELECT c.descripcion, ltrim(c.idfamilia) as codigo
		from v_ma_articulos b
			LEFT JOIN V_TA_FAMILIAS c on b.idfamilia = c.idfamilia
		WHERE b.suspendidov <> 1 and c.idfamilia<>''
		) as z
	GROUP BY codigo,descripcion
	ORDER BY codigo

	OPEN CRS
	FETCH NEXT FROM CRS INTO @codigo,@descripcion
	WHILE @@FETCH_STATUS = 0
		BEGIN
		IF LEN(@codigo) <= 2
			BEGIN
			INSERT INTO #temp
				(codigo, descripcion)
			VALUES
				(@codigo, @descripcion)
			SET @codigoAnterior = ''
		END
		ELSE
			BEGIN
			SET @padre = SUBSTRING(@codigo,1,2)
			IF @padre <> @codigoAnterior
					INSERT INTO #temp
				(codigo, descripcion)
			SELECT ltrim(idfamilia), ltrim(descripcion)
			from V_TA_FAMILIAS
			WHERE IdFamilia like @padre + '%'
			order by IdFamilia
			SET @codigoAnterior = @padre
		END

		FETCH NEXT FROM CRS INTO @codigo,@descripcion
	END
	CLOSE CRS
	DEALLOCATE CRS

	SELECT codigo, descripcion
	FROM #temp
	GROUP BY codigo,descripcion
	ORDER BY codigo
END






GO

/****** Object:  StoredProcedure [dbo].[sp_web_getFichaStockArticulo]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO












CREATE PROCEDURE [dbo].[sp_web_getFichaStockArticulo]
	@iddeposito nvarchar(4),
	@idarticulo nvarchar(25),
	@fecha NVARCHAR(10)
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @WHERE NVARCHAR(250)
	DECLARE @rs NVARCHAR(MAX)

	SET @WHERE = ''
	IF @iddeposito != ''
		SET @WHERE = ' AND LTRIM(iddeposito) = ''' + @iddeposito + ''''

	if @idarticulo != ''
		SET @WHERE = @WHERE + ' AND LTRIM(idarticulo) = ''' + @idarticulo + ''''

	if @fecha != ''
		SET @WHERE = @WHERE + ' AND fecha >= ''' + @fecha + ''''


	SET @rs = '
	SELECT fecha as fechaorden,CONVERT(NVARCHAR(10),Fecha,103) as fecha,tc,idcomprobante,case when Cantidad<0 then ABS(cantidad) else 0 end as salidas,
	case when Cantidad>0 then ABS(cantidad) else 0 end as entradas,idunidad,convert(varchar,convert(decimal(15,2),precioventa)) as importe, isnull(ltrim(nrolote),'''') as nrolote,isnull(ltrim(nroserie),'''') as nroserie,
	cuentaproveedor,isnull(MA_CUENTAS.DESCRIPCION,'''') as nombre,isnull(unegocio,'''') as unegocio,iddeposito,isnull(v_ta_motivostock.Descripcion,'''') as motivostock,
	CASE WHEN iddeposito_destino <>'''' THEN CASE WHEN Cantidad > 0 THEN ''Org. '' + IDDEPOSITO_DESTINO ELSE ''Dest. '' + IDDEPOSITO_DESTINO END ELSE '''' END as deposito_origen_destino,
	isnull(TC_Origen + '' '' + idcomprobante_origen,'''') as cpte_origen,convert(varchar,convert(decimal(15,2), isnull(cant_bl,0))) as cant_bl
	FROM V_MV_STOCK LEFT JOIN MA_CUENTAS ON V_MV_Stock.CuentaProveedor = MA_CUENTAS.CODIGO
	LEFT JOIN v_ta_motivostock ON V_MV_STOCK.IdMotivoStock = v_ta_motivostock.IdMotivoStock
	WHERE (Anulado=0 or Anulado is null) ' + @WHERE + '
	ORDER BY fechaorden DESC'


	EXEC(@rs)

END






GO

/****** Object:  StoredProcedure [dbo].[sp_web_getIngresosEgresosCaja]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO











CREATE PROCEDURE [dbo].[sp_web_getIngresosEgresosCaja]
	@fecha datetime,
	@idcaja nvarchar(4),
	@tipo nvarchar(1)
AS
BEGIN

	SET NOCOUNT ON;

	CREATE TABLE #temp
	(
		[cuenta] [nvarchar] (9) COLLATE  Latin1_General_CI_AI,
		[descripcion] [nvarchar] (50) COLLATE  Latin1_General_CI_AI ,
		[detalle] [nvarchar] (150) COLLATE  Latin1_General_CI_AI ,
		[fecha] [nvarchar] (50) COLLATE  Latin1_General_CI_AI ,
		[tc] [nvarchar] (4) COLLATE  Latin1_General_CI_AI ,
		[idcomprobante] [nvarchar] (13) COLLATE  Latin1_General_CI_AI ,
		[importe] [money],
		[usuario] [nvarchar] (50) COLLATE  Latin1_General_CI_AI
	)


	DECLARE @nombre NVARCHAR(50)
	DECLARE @cuentaEfectivo NVARCHAR(9)
	DECLARE @efectivoCobrado MONEY
	DECLARE @ingresos MONEY
	DECLARE @egresos MONEY
	DECLARE @transferencias MONEY
	DECLARE @fondoFijo MONEY
	DECLARE @billetesRendidos MONEY
	DECLARE @medioDePagoContado NVARCHAR(10)

	SET @medioDePagoContado = (SELECT VALOR
	FROM TA_CONFIGURACION
	WHERE CLAVE='MedioDePagoContado')
	SET @cuentaEfectivo = (SELECT CODIGO
	FROM MA_CUENTAS
	WHERE CodigoOpcional=@medioDePagoContado)

	IF @tipo='E'
		BEGIN
		IF @idcaja = ''
			INSERT INTO #temp
		SELECT CUENTA, MA_CUENTAS.DESCRIPCION, DETALLE, convert(NVARCHAR(18),MV_ASIENTOS.FechaHora_Grabacion ,103) + ' ' + convert(NVARCHAR(18),MV_ASIENTOS.FechaHora_Grabacion ,108) as FECHA, TC, SUCURSAL+NUMERO+LETRA AS IDCOMPROBANTE, IMPORTE, USUARIO_LOGEADO
		FROM MV_ASIENTOS INNER JOIN MA_CUENTAS ON MV_ASIENTOS.CUENTA = MA_CUENTAS.CODIGO
		where CUENTA = @cuentaEfectivo AND [DEBE-HABER] = 'H' and (fecha = @fecha) and not tc in('CB','CBCT','CBFP','TK ','TKFC','FC','FP') AND ISNULL(Cpte_Origen,'')<>'TRANSF:'
		ELSE
			INSERT INTO #temp
		SELECT CUENTA, MA_CUENTAS.DESCRIPCION, DETALLE, convert(NVARCHAR(18),MV_ASIENTOS.FechaHora_Grabacion ,103) + ' ' + convert(NVARCHAR(18),MV_ASIENTOS.FechaHora_Grabacion ,108) as FECHA, TC, SUCURSAL+NUMERO+LETRA AS IDCOMPROBANTE, IMPORTE, USUARIO_LOGEADO
		FROM MV_ASIENTOS INNER JOIN MA_CUENTAS ON MV_ASIENTOS.CUENTA = MA_CUENTAS.CODIGO
		where CUENTA = @cuentaEfectivo AND [DEBE-HABER] = 'H' and (fecha = @fecha) and not tc in('CB','CBCT','CBFP','TK ','TKFC','FC','FP') AND ISNULL(Cpte_Origen,'')<>'TRANSF:' AND IDCAJAS= @idcaja
	END
	ELSE
		BEGIN
		IF @idcaja = ''
			INSERT INTO #temp
		SELECT CUENTA, MA_CUENTAS.DESCRIPCION, DETALLE, convert(NVARCHAR(18),MV_ASIENTOS.FechaHora_Grabacion ,103) + ' ' + convert(NVARCHAR(18),MV_ASIENTOS.FechaHora_Grabacion ,108) as FECHA, TC, SUCURSAL+NUMERO+LETRA AS IDCOMPROBANTE, IMPORTE, USUARIO_LOGEADO
		FROM MV_ASIENTOS INNER JOIN MA_CUENTAS ON MV_ASIENTOS.CUENTA = MA_CUENTAS.CODIGO
		where CUENTA = @cuentaEfectivo AND [DEBE-HABER] = 'D' and (fecha = @fecha) and not tc in('CB','CBCT','CBFP','TK ','TKFC','FC','FP')
		ELSE
			INSERT INTO #temp
		SELECT CUENTA, MA_CUENTAS.DESCRIPCION, DETALLE, convert(NVARCHAR(18),MV_ASIENTOS.FechaHora_Grabacion ,103) + ' ' + convert(NVARCHAR(18),MV_ASIENTOS.FechaHora_Grabacion ,108) as FECHA, TC, SUCURSAL+NUMERO+LETRA AS IDCOMPROBANTE, IMPORTE, USUARIO_LOGEADO
		FROM MV_ASIENTOS INNER JOIN MA_CUENTAS ON MV_ASIENTOS.CUENTA = MA_CUENTAS.CODIGO
		where CUENTA = @cuentaEfectivo AND [DEBE-HABER] = 'D' and (fecha = @fecha) and not tc in('CB','CBCT','CBFP','TK ','TKFC','FC','FP') AND IDCAJAS=@idcaja
	END


	SELECT
		cuenta, descripcion, detalle, fecha, tc, idcomprobante, usuario,
		convert(varchar,convert(decimal(15,2),importe)) as importe
	FROM #temp


END





GO

/****** Object:  StoredProcedure [dbo].[sp_web_getLibroIva]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO











CREATE PROCEDURE [dbo].[sp_web_getLibroIva]
	@tipo nvarchar(1) = 'V',
	@fechaDesde datetime,
	@fechaHasta datetime
AS
BEGIN

	SET NOCOUNT ON;

	IF @tipo = 'V'
		BEGIN
		SELECT CONVERT(NVARCHAR(10),fecha,103) as fecha,
			codigo, tc, sucursal, numero, letra, SUCURSAL+NUMERO+LETRA as idcomprobante, cuenta, razon_social, nro_cuit,
			convert(varchar,convert(decimal(15,2),NETO_NO_GRAVADO)) as neto_no_gravado,
			convert(varchar,convert(decimal(15,2),NETO_GRAVADO)) as neto_gravado,
			convert(varchar,convert(decimal(15,2),EXENTO)) as exento,
			convert(varchar,convert(decimal(15,2),IVA_RESP_INSC)) as ivari,
			convert(varchar,convert(decimal(15,2),IVA_MONOTRIBUTO)) as ivamono,
			convert(varchar,convert(decimal(15,2),IVA_CONS_FINAL)) as ivacf,
			convert(varchar,convert(decimal(15,2),PERC_IIBB)) as perc_iibb,
			convert(varchar,convert(decimal(15,2),PERC_IVA)) as perc_iva,
			convert(varchar,convert(decimal(15,2),IMPORTE_TOTAL)) as total,
			convert(varchar,convert(decimal(15,2),NETO_21)) as neto21,
			convert(varchar,convert(decimal(15,2),IVA_21)) as iva21,
			convert(varchar,convert(decimal(15,2),NETO_105)) as neto105,
			convert(varchar,convert(decimal(15,2),IVA_105)) as iva105,
			convert(varchar,convert(decimal(15,2),NETO_27)) as neto27,
			convert(varchar,convert(decimal(15,2),IVA_27)) as iva27,
			convert(varchar,convert(decimal(15,2),NETO_1735)) as neto1735,
			convert(varchar,convert(decimal(15,2),IVA_1735)) as iva1735,
			ltrim(unegocio) + ' - ' + descunegocio as unegocio, ltrim(CodProvincia) + ' - ' + DescProvincia as provincia
		FROM LibroIvaVentas_Contadores
		WHERE FECHA>=@fechaDesde and FECHA<=@fechaHasta
		ORDER BY FECHA
	END
	ELSE
		BEGIN
		SELECT CONVERT(NVARCHAR(10),fecha,103) as fecha,
			codigo, tc, sucursal, numero, letra, SUCURSAL+NUMERO+LETRA as idcomprobante, cuenta, razon_social, nro_cuit,
			convert(varchar,convert(decimal(15,2),NETO_NO_GRAVADO)) as neto_no_gravado,
			convert(varchar,convert(decimal(15,2),NETO_GRAVADO)) as neto_gravado,
			convert(varchar,convert(decimal(15,2),EXENTO)) as exento,
			convert(varchar,convert(decimal(15,2),IVA_RESP_INSC)) as ivari,
			convert(varchar,convert(decimal(15,2),IVA_MONOTRIBUTO)) as ivamono,
			convert(varchar,convert(decimal(15,2),IVA_CONS_FINAL)) as ivacf,
			convert(varchar,convert(decimal(15,2),PERC_IIBB)) as perc_iibb,
			convert(varchar,convert(decimal(15,2),PERC_IVA)) as perc_iva,
			convert(varchar,convert(decimal(15,2),IMPORTE_TOTAL)) as total,
			convert(varchar,convert(decimal(15,2),NETO_21)) as neto21,
			convert(varchar,convert(decimal(15,2),IVA_21)) as iva21,
			convert(varchar,convert(decimal(15,2),NETO_105)) as neto105,
			convert(varchar,convert(decimal(15,2),IVA_105)) as iva105,
			convert(varchar,convert(decimal(15,2),NETO_27)) as neto27,
			convert(varchar,convert(decimal(15,2),IVA_27)) as iva27,
			convert(varchar,convert(decimal(15,2),NETO_1735)) as neto1735,
			convert(varchar,convert(decimal(15,2),IVA_1735)) as iva1735,
			ltrim(unegocio) + ' - ' + descunegocio as unegocio, ltrim(CodProvincia) + ' - ' + DescProvincia as provincia
		FROM LibroIvaCompras_Contadores
		WHERE FECHA>=@fechaDesde and FECHA<=@fechaHasta
		ORDER BY FECHA
	END

END





GO

/****** Object:  StoredProcedure [dbo].[sp_web_getListaDePrecios]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO












CREATE PROCEDURE [dbo].[sp_web_getListaDePrecios]
	@idlista nvarchar(4),
	@fechad datetime,
	@fechah datetime,
	@idCliente NVARCHAR(13) = null
AS

BEGIN

	SET NOCOUNT ON;
	DECLARE @clasePrecio NVARCHAR(4)
	DECLARE @claseDefault NVARCHAR(4)

	SET @fechah = DATEADD(day,1,@fechah)

	SET @claseDefault = (SELECT VALOR
	FROM TA_CONFIGURACION
	WHERE CLAVE='ClaseDePrecioDefault')

	SET @clasePrecio = @claseDefault

	IF @idCliente <>''
		BEGIN
		SET @idLista = (SELECT isnull(ltrim(idlista),'')
		from Vt_Clientes
		WHERE CODIGO=@idCliente)
		SET @clasePrecio = (SELECT isnull(clase,@claseDefault)
		from Vt_Clientes
		WHERE CODIGO=@idCliente)
		END

	SELECT ltrim(IdArticulo) as idarticulo,descripcion, isnull(descadic,'') as descadic,
		convert(varchar,convert(decimal(15,2),isnull(precio_venta,0))) AS precio_venta,
		convert(varchar,convert(decimal(15,2),isnull(cant_of1,0))) as cant_of1,
		convert(varchar,convert(decimal(15,2),isnull(dto_of1,0))) as dto_of1,
		convert(varchar,convert(decimal(15,2),isnull(cant_of2,0))) as cant_of2,
		convert(varchar,convert(decimal(15,2),isnull(dto_of2,0))) as dto_of2,
		isnull(familia,'') as familia,
		ISNULL(CONVERT(NVARCHAR(10),ult_cambio,103),'') as ult_cambio,
		convert(varchar,convert(decimal(15,2),venta)) as venta,
		convert(varchar,convert(decimal(15,2),moneda)) as moneda,
		isnull(presentacion,'') as presentacion,
		convert(varchar,convert(decimal(15,2),Precio_Venta - ((isnull(dto_of1,0) * precio_venta) / 100)))  as preciovtadesc1,
		convert(varchar,convert(decimal(15,2),Precio_Venta - ((isnull(dto_of2,0) * precio_venta) / 100)))  as preciovtadesc2,
		convert(varchar,convert(decimal(15,2),tasaiva)) as iva
	FROM (SELECT IdArticulo, DESCRIPCION, DescAdic, CASE Moneda WHEN 1 THEN Venta WHEN 2 THEN Venta *
    (SELECT TOP 1
				moneda2
			FROM ta_cotizacion
			ORDER BY FECHA_HORA DESC) WHEN 3 THEN Venta *
    (SELECT TOP 1
				moneda3
			FROM ta_cotizacion
			ORDER BY FECHA_HORA DESC) WHEN 4 THEN Venta *
    (SELECT TOP 1
				moneda4
			FROM ta_cotizacion
			ORDER BY FECHA_HORA DESC) WHEN 5 THEN Venta *
    (SELECT TOP 1
				moneda5
			FROM ta_cotizacion
			ORDER BY FECHA_HORA DESC) END AS Precio_Venta,
			Cant_Of1, Dto_Of1, Cant_Of2, Dto_Of2, IdFamilia, Familia, CASE WHEN FhCotizacion > Ult_cambio THEN FhCotizacion ELSE Ult_cambio END as Ult_cambio, Venta, Moneda, Presentacion, TasaIVA
		FROM (SELECT a.IdArticulo, b.DESCRIPCION, b.Procedencia AS DescAdic, CASE WHEN @clasePrecio = 1 THEN a.Precio1 ELSE CASE WHEN @clasePrecio = 2 THEN a.Precio2 ELSE CASE WHEN @clasePrecio = 3 THEN a.Precio3 ELSE
		CASE WHEN @clasePrecio = 4 THEN a.Precio4 ELSE CASE WHEN @clasePrecio = 5 THEN a.PRECIO5 ELSE CASE WHEN @clasePrecio = 6 THEN a.precio6 ELSE a.precio7 END END END END END END
		AS Venta, b.Moneda, a.CantidadOf2 AS Cant_Of1, a.PRECIO9 AS Dto_Of1, a.CantidadOf3 AS Cant_Of2, a.PRECIO10 AS Dto_Of2, b.tasaiva , b.IdFamilia,
				(SELECT TOP (1)
					Descripcion
				FROM dbo.V_TA_FAMILIAS AS c
				WHERE (LEFT(LTRIM(b.IdFamilia), 3) = IdFamilia)) AS Familia, b.FhUltimoCosto AS Ult_cambio, b.Presentacion,CASE WHEN ltrim(b.moneda)='1' THEN b.FhUltimoCosto ELSE dbo.FN_OBTENER_ULTIMA_FECHA_COTIZACION(b.Moneda) END as FhCotizacion
			FROM dbo.V_MA_Precios AS a INNER JOIN
				dbo.V_MA_ARTICULOS AS b ON a.IdArticulo = b.IDARTICULO
			WHERE (ltrim(a.IdLista) = @idlista ) and b.SuspendidoV <>1 and b.Suspendido <>1) AS z) AS x
	WHERE  (ult_cambio>=@fechad and ult_cambio<=@fechah)
	ORDER BY  Familia, DESCRIPCION



END





GO

/****** Object:  StoredProcedure [dbo].[sp_web_getListaDePrecios_query]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[sp_web_getListaDePrecios_query]
	@idlista nvarchar(4),
	@fechad datetime,
	@fechah datetime,
	@idCliente NVARCHAR(13) = null,
	@query NVARCHAR(MAX) = null
AS

BEGIN

	SET NOCOUNT ON;
	DECLARE @clasePrecio NVARCHAR(4)
	DECLARE @tmpLista NVARCHAR(4)
	DECLARE @claseDefault NVARCHAR(4)
	DECLARE @sqlQuery NVARCHAR(MAX)

	SET @fechah = DATEADD(day,1,@fechah)

	SET @claseDefault = (SELECT VALOR
	FROM TA_CONFIGURACION
	WHERE CLAVE='ClaseDePrecioDefault')

	SET @clasePrecio = @claseDefault

	IF @idCliente <>''
		BEGIN
		SET @tmpLista = (SELECT isnull(ltrim(idlista),'')
		from Vt_Clientes
		WHERE CODIGO=@idCliente)
		SET @clasePrecio = (SELECT isnull(clase,@claseDefault)
		from Vt_Clientes
		WHERE CODIGO=@idCliente)
		END
	
	IF @tmpLista <> ''
		SET @idlista = @tmpLista
	
	if @clasePrecio = '' or @clasePrecio is null
		SET @clasePrecio = '1'

	if @query <>'' 
		set @query = ' AND ' + @query

	SET @sqlQuery = '
	SELECT ltrim(IdArticulo) as idarticulo, descripcion, isnull(descadic,'''') as descadic,
		convert(varchar,convert(decimal(15,2),isnull(precio_venta,0))) AS precio_venta,
		convert(varchar,convert(decimal(15,2),isnull(cant_of1,0))) as cant_of1,
		convert(varchar,convert(decimal(15,2),isnull(dto_of1,0))) as dto_of1,
		convert(varchar,convert(decimal(15,2),isnull(cant_of2,0))) as cant_of2,
		convert(varchar,convert(decimal(15,2),isnull(dto_of2,0))) as dto_of2,
		isnull(familia,'''') as familia,
		ISNULL(CONVERT(NVARCHAR(10),ult_cambio,103),'''') as ult_cambio,
		convert(varchar,convert(decimal(15,2),venta)) as venta,
		convert(varchar,convert(decimal(15,2),moneda)) as moneda,
		isnull(presentacion,'''') as presentacion,
		convert(varchar,convert(decimal(15,2),Precio_Venta - ((isnull(dto_of1,0) * precio_venta) / 100)))  as preciovtadesc1,
		convert(varchar,convert(decimal(15,2),Precio_Venta - ((isnull(dto_of2,0) * precio_venta) / 100)))  as preciovtadesc2,
		convert(varchar,convert(decimal(15,2),tasaiva)) as iva
	FROM (SELECT IdArticulo, DESCRIPCION, DescAdic, CASE Moneda WHEN 1 THEN Venta WHEN 2 THEN Venta *
    (SELECT TOP 1
				moneda2
			FROM ta_cotizacion
			ORDER BY FECHA_HORA DESC) WHEN 3 THEN Venta *
    (SELECT TOP 1
				moneda3
			FROM ta_cotizacion
			ORDER BY FECHA_HORA DESC) WHEN 4 THEN Venta *
    (SELECT TOP 1
				moneda4
			FROM ta_cotizacion
			ORDER BY FECHA_HORA DESC) WHEN 5 THEN Venta *
    (SELECT TOP 1
				moneda5
			FROM ta_cotizacion
			ORDER BY FECHA_HORA DESC) END AS Precio_Venta,
			Cant_Of1, Dto_Of1, Cant_Of2, Dto_Of2, IdFamilia, Familia, CASE WHEN FhCotizacion > Ult_cambio THEN FhCotizacion ELSE Ult_cambio END as Ult_cambio, Venta, Moneda, Presentacion, TasaIVA
		FROM (SELECT a.IdArticulo, b.DESCRIPCION, b.Procedencia AS DescAdic, CASE WHEN ''' + @clasePrecio + '''= 1 THEN a.Precio1 ELSE CASE WHEN''' +  @clasePrecio + '''= 2 THEN a.Precio2 ELSE CASE WHEN ''' + @clasePrecio + '''= 3 THEN a.Precio3 ELSE
		CASE WHEN ''' + @clasePrecio + '''= 4 THEN a.Precio4 ELSE CASE WHEN ''' + @clasePrecio + '''= 5 THEN a.PRECIO5 ELSE CASE WHEN ''' + @clasePrecio + '''= 6 THEN a.precio6 ELSE a.precio7 END END END END END END
		AS Venta, b.Moneda, a.CantidadOf2 AS Cant_Of1, a.PRECIO9 AS Dto_Of1, a.CantidadOf3 AS Cant_Of2, a.PRECIO10 AS Dto_Of2, b.tasaiva , b.IdFamilia,
				(SELECT TOP (1)
					Descripcion
				FROM dbo.V_TA_FAMILIAS AS c
				WHERE (LEFT(LTRIM(b.IdFamilia), 3) = IdFamilia)) AS Familia, b.FhUltimoCosto AS Ult_cambio, b.Presentacion,
				CASE WHEN ltrim(b.moneda)=''1'' THEN b.FhUltimoCosto ELSE dbo.FN_OBTENER_ULTIMA_FECHA_COTIZACION(b.Moneda) END as FhCotizacion
			FROM dbo.V_MA_Precios AS a INNER JOIN
				dbo.V_MA_ARTICULOS AS b ON a.IdArticulo = b.IDARTICULO
			WHERE (ltrim(a.IdLista) = ''' + @idlista + ''') and b.SuspendidoV <>1 and b.Suspendido <>1) AS z) AS x
	WHERE   (ult_cambio>=''' + CONVERT(NVARCHAR(10),@fechad,103) + ''' and ult_cambio<=''' +CONVERT(NVARCHAR(10),@fechah,103) + ''') ' + @query + '
	ORDER BY  Familia, DESCRIPCION'

	EXEC(@sqlQuery)


END


/****** Object:  StoredProcedure [dbo].[sp_web_Alta_Comprobante]    Script Date: 18/04/2023 11:39:14 ******/
SET ANSI_NULLS ON
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getPedidos]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO








CREATE PROCEDURE [dbo].[sp_web_getPedidos]
	@cuenta nvarchar(9),
	@fechaD nvarchar(10),
	@fechaH nvarchar(10),
	@idvendedor nvarchar(4) = ''

AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @WHERE NVARCHAR(250)
	DECLARE @rs NVARCHAR(MAX)

	SET @WHERE = ''


	IF @cuenta <> ''
		SET @WHERE = ' AND a.Cuenta =''' + @cuenta + ''''

	IF @fechaD != '' AND @fechaH != ''
		SET @WHERE = @WHERE + ' AND (a.Fecha >= ''' + @fechaD + ''' AND a.FECHA<= ''' + @fechaH + ''')'
	ELSE
		BEGIN
		IF @fechaD != ''
				SET @WHERE = @WHERE + ' AND a.Fecha >= ''' + @fechaD + ''''

		IF @fechaH != ''
				SET @WHERE = @WHERE + ' AND a.Fecha <= ''' + @fechaH + ''''
	END

	IF @idvendedor <> ''
		SET @WHERE = @WHERE + ' AND ltrim(a.idvendedor) = ''' + @idvendedor + ''''

	SET @rs = '
	SELECT a.fecha as fechaorden,isnull(ltrim(a.idvendedor),'''') + '' - '' + isnull(b.nombre,'''') as idvendedor,a.cuenta,a.idcomprobante,a.tc,
	CONVERT(NVARCHAR(10),a.fecha,103) as fecha,a.nombre,
	convert(varchar,convert(decimal(15,2),a.importe)) as importe,
	a.finalizada,a.anulada,a.aprobado,
	convert(varchar,convert(decimal(15,2),a.porcdescuento1)) as porcdescuento1,
	convert(varchar,convert(decimal(15,2),a.impdescuento1)) as impdescuento1,
	a.fechafinalizacion,a.fechapreparacion,a.fechahora_grabacion,
	isnull(convert(NVARCHAR(18),a.fechahora_grabacion,103) + '' '' + convert(NVARCHAR(18),a.fechahora_grabacion,108),CONVERT(NVARCHAR(10),a.fecha,103)) as fechagrabacion,
	CASE WHEN a.anulada = 1 THEN ''Anulada''
	ELSE CASE WHEN a.finalizada = 1 THEN ''Finalizada''
	ELSE CASE WHEN a.bloqueada = 1 THEN ''Bloqueada''
	ELSE CASE WHEN not a.fechapreparacion is null THEN ''Preparada''
	ELSE ''Pendiente'' END END END END as estado, isnull(c.lat,'''') as lat,isnull(c.long,'''') as long, 
	convert(NVARCHAR(18),c.fechahora,103) + '' '' + convert(NVARCHAR(18),c.fechahora,108) as fecha_ubicacion
	FROM V_MV_CPTE a 
	LEFT JOIN V_TA_VENDEDORES b ON a.idvendedor = b.idvendedor
	LEFT JOIN S_TA_UBICACIONES_VENDEDOR c on a.IDCOMPROBANTE = c.idcomprobante
	WHERE a.TC=''NP'' ' + @WHERE + '
	ORDER BY fechaorden DESC'

	EXEC(@rs)

END






GO

/****** Object:  StoredProcedure [dbo].[sp_web_getRemitosTransportePendientesChofer]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO












CREATE PROCEDURE [dbo].[sp_web_getRemitosTransportePendientesChofer]
	@chofer nvarchar(6)
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @WHERE NVARCHAR(250)
	DECLARE @rs NVARCHAR(MAX)
	DECLARE @BASETTE NVARCHAR(250)

	SET @BASETTE = (SELECT VALOR
	FROM TA_CONFIGURACION
	WHERE CLAVE='SAT_BASEDEDATOS')


	SET @rs = '
    USE ' + @BASETTE + '
    SELECT  b.id,a.NRO_COMPROBANTE as nro_viaje,CONVERT(NVARCHAR(10),a.FECHA_COMPROBANTE,103) as fecha_viaje, 
	CASE WHEN b.DOCUMENTO_SUCURSAL IS NULL THEN CONVERT(NVARCHAR(10),a.FECHA_COMPROBANTE,103) ELSE CONVERT(NVARCHAR(10),b.FECHA_PROCESO,103) END as fecha_remito,
    CASE WHEN b.DOCUMENTO_SUCURSAL IS NULL THEN '''' ELSE b.DOCUMENTO_SUCURSAL + b.NUMERO_DOCUMENTO  + b.DOCUMENTO_LETRA END as nro_remito, 
	isnull(codigo_estado,'''') as codigo_estado,isnull(c.Color,'''') as color_estado,isnull(c.DESCRIPCION,'''') as estado 
	FROM MV_RUTEOCAB b
	LEFT JOIN MV_VIAJES_EN_TRANSITO a ON a.NRO_COMPROBANTE = b.NRO_VIAJE
	LEFT JOIN TA_ESTADOS c ON b.CODIGO_ESTADO = c.CODIGO
    WHERE LTRIM(a.CHOFER)=''' + @chofer + '''
    ORDER BY c.codigo'

	EXEC(@rs)

END







GO

/****** Object:  StoredProcedure [dbo].[sp_web_getSaldoConsolidadoCaja]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO











CREATE PROCEDURE [dbo].[sp_web_getSaldoConsolidadoCaja]
	@fecha datetime,
	@idcaja nvarchar(4),
	@csaldoInicial BIT = 0
AS
BEGIN

	SET NOCOUNT ON;

	CREATE TABLE #temp
	(
		[cuenta] [nvarchar] (15) COLLATE  Latin1_General_CI_AI NOT NULL,
		[descripcion] [nvarchar] (150) COLLATE  Latin1_General_CI_AI NOT NULL,
		[cobranzas] [MONEY],
		[ingresos] [MONEY],
		[egresos] [MONEY],
		[transferencias] [MONEY],
		[saldo] [MONEY],
		[saldoant] [MONEY],
		[moneda] [nvarchar] (4),
		[cotizacion] [money],
		[idcajas] [nvarchar] (4),
		[saldomoneda] [money]
	)

	DECLARE @cobranzas MONEY
	DECLARE @ingresos MONEY
	DECLARE @egresos MONEY
	DECLARE @transferencias MONEY
	DECLARE @saldoant MONEY
	DECLARE @fondoFijo MONEY
	DECLARE @saldo MONEY
	DECLARE @moneda NVARCHAR(4)
	DECLARE @cotizacion MONEY
	DECLARE @saldomoneda MONEY
	DECLARE @cuenta NVARCHAR(9)
	DECLARE @descripcion NVARCHAR(150)

	DECLARE @cuentaEfectivo NVARCHAR(9)
	DECLARE @medioDePagoContado NVARCHAR(10)
	DECLARE @cantidadDatos INT

	SET @medioDePagoContado = (SELECT VALOR
	FROM TA_CONFIGURACION
	WHERE CLAVE='MedioDePagoContado')
	SET @cuentaEfectivo = (SELECT CODIGO
	FROM MA_CUENTAS
	WHERE CodigoOpcional=@medioDePagoContado)

	IF @idcaja = ''
		SET @fondoFijo = isnull((Select cambioInicial
	from V_Mv_CierreCaja
	where FechaOperativa = @fecha),0)
	ELSE
		SET @fondoFijo = isnull((Select cambioInicial
	from V_Mv_CierreCaja
	where FechaOperativa = @fecha and ltrim(idCaja) = @idcaja),0)

	IF @idcaja = ''
		BEGIN
		SELECT @cantidadDatos = COUNT(*)
		FROM VT_CONSOLIDADO_CAJA
		WHERE FECHA=@fecha

		IF @cantidadDatos > 0
				BEGIN
			DECLARE CRS CURSOR FOR
					SELECT CUENTA, DESCRIPCION, MONEDA, COTIZACION, ltrim(IDCAJAS) as IDCAJAS
			FROM VT_CONSOLIDADO_CAJA
			WHERE FECHA=@fecha
		END
			ELSE
				BEGIN
			DECLARE CRS CURSOR FOR
					SELECT @cuentaEfectivo as CUENTA, 'Efectivo' as DESCRIPCION, '   1' as MONEDA, 1 as COTIZACION, '1' as IDCAJAS
		END
	END
	ELSE
		BEGIN
		SELECT @cantidadDatos = COUNT(*)
		FROM VT_CONSOLIDADO_CAJA
		WHERE FECHA=@fecha AND LTRIM(IdCajas)=@idcaja
		IF @cantidadDatos > 0
				BEGIN
			DECLARE CRS CURSOR FOR
					SELECT CUENTA, DESCRIPCION, MONEDA, COTIZACION, ltrim(IDCAJAS) as IDCAJAS
			FROM VT_CONSOLIDADO_CAJA
			WHERE FECHA=@fecha AND ltrim(IDCAJAS)=@idcaja
		END
			ELSE
				BEGIN
			DECLARE CRS CURSOR FOR
					SELECT @cuentaEfectivo as CUENTA, 'Efectivo' as DESCRIPCION, '   1' as MONEDA, 1 as COTIZACION, '1' as IDCAJAS
		END
	END


	OPEN CRS
	FETCH NEXT FROM CRS INTO @cuenta,@descripcion,@moneda,@cotizacion, @idcaja
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @transferencias = isnull((Select convert(varchar,convert(decimal(15,2),sum(egreso))) as saldo
		from vt_transferenciascaja
		where cuenta = @cuenta and fecha = @fecha and ltrim(origen) = @idcaja and cotizacion = @cotizacion and moneda = @moneda),0)
		SET @cobranzas = isnull((Select convert(varchar,convert(decimal(15,2),sum(Importe * case when [debe-haber] = 'D' then 1 else -1 end))) as saldo
		from mv_asientos
		where cuenta = @cuenta and tc in ('CB','CBCT','CBFP') and fecha = @fecha and ltrim(idcajas) = @idcaja and cotizacion = @cotizacion and moneda = @moneda ),0)
		SET @ingresos = isnull((SELECT sum(importe) as saldo
		FROM MV_ASIENTOS
		where CUENTA = @cuenta AND [DEBE-HABER] = 'D' and fecha = @fecha and ltrim(idcajas) = @idcaja and not tc in('CB','CBCT','CBFP','TK ','TKFC','FC') and cotizacion = @cotizacion and moneda = @moneda
		group by Cuenta),0)

		IF @cuenta <> @cuentaEfectivo
			SET @saldoant = 0
		ELSE
			BEGIN
			IF @csaldoInicial = 1
					SET @saldoant = isnull((select sum(saldo) as saldo
			from vt_consolidado_caja
			where cuenta = @cuenta and fecha < @fecha and ltrim(idcajas) = @idcaja),0)		
				ELSE
					SET @saldoant = 0
		END
		SET @egresos = isnull((SELECT sum(importe) as saldo
		FROM MV_ASIENTOS
		where CUENTA = @cuenta AND [DEBE-HABER] = 'H' and not tc in('CB','CBCT','CBFP','TK ','TKFC','FC') and fecha = @fecha and ltrim(idcajas) = @idcaja and cotizacion = @cotizacion and moneda = @moneda
		group by Cuenta),0)
		SET @egresos = @egresos - @transferencias

		IF @csaldoInicial = 1
			SET @saldoant = @saldoant + @fondoFijo
		ELSE
			SET @saldoant = @fondoFijo

		SET @saldo = @saldoant + @cobranzas + @ingresos - @egresos - isnull(@transferencias,0)
		SET @saldomoneda = @saldo * @cotizacion



		INSERT INTO #temp
			(cuenta,descripcion,cobranzas,ingresos,egresos,transferencias,saldo,saldoant,moneda,cotizacion,idcajas,saldomoneda)
		VALUES
			(@cuenta, @descripcion, @cobranzas, @ingresos, @egresos, @transferencias, @saldo, @saldoant, @moneda, @cotizacion, @idcaja, @saldomoneda)
		FETCH NEXT FROM CRS INTO @cuenta,@descripcion,@moneda,@cotizacion,@idcaja
	END
	CLOSE CRS
	DEALLOCATE CRS

	SELECT
		cuenta, descripcion, moneda, idcajas,
		convert(varchar,convert(decimal(15,2),cobranzas)) as cobranzas,
		convert(varchar,convert(decimal(15,2),ingresos)) as ingresos,
		convert(varchar,convert(decimal(15,2),egresos)) as egresos,
		convert(varchar,convert(decimal(15,2),transferencias)) as transferencias,
		convert(varchar,convert(decimal(15,2),saldo)) as saldo,
		convert(varchar,convert(decimal(15,2),saldoant)) as saldoant,
		convert(varchar,convert(decimal(15,2),cotizacion)) as cotizacion,
		convert(varchar,convert(decimal(15,2),saldomoneda)) as saldomoneda
	FROM #temp




END




GO

/****** Object:  StoredProcedure [dbo].[sp_web_getSaldosCuentas]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO










CREATE PROCEDURE [dbo].[sp_web_getSaldosCuentas]
	@tipo nvarchar(2),
	@cuenta nvarchar(9),
	@ocultaSaldoCero nvarchar(1),
	@idvendedor nvarchar(4) = ''
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @WHERE NVARCHAR(250)
	DECLARE @rs NVARCHAR(MAX)

	SET @WHERE = ''

	IF @tipo = '' SET @tipo = 'CL'

	IF @tipo <> ''
		SET @WHERE = ' TipoVista=''' + @tipo + ''''

	if @cuenta != ''
		SET @WHERE = @WHERE + ' AND cuenta = ''' + @cuenta + ''''

	if @ocultaSaldoCero = '1'
		SET @WHERE = @WHERE + ' AND saldo > 0 '

	if @idvendedor <> ''
		SET @WHERE = @WHERE + ' AND ltrim(b.idvendedor)= ''' + @idvendedor + ''''


	SET @rs = '
	SELECT cuenta,descripcion,convert(varchar,convert(decimal(15,2),a.totaldebe)) as totaldebe,
	convert(varchar,convert(decimal(15,2),a.totalhaber)) as totalhaber, 
	convert(varchar,convert(decimal(15,2),a.saldo)) as saldo,isnull(c.nombre,'''') as vendedor,isnull(b.telefono,'''') as telefono,isnull(b.contacto,'''') as contacto
	FROM VE_SALDOSCTA a LEFT JOIN MA_CUENTASADIC b on a.CUENTA=b.CODIGO LEFT JOIN V_TA_VENDEDORES c on b.IdVendedor = c.idvendedor
	WHERE ' + @WHERE + ' ORDER BY CUENTA'

	EXEC(@rs)

END






GO

/****** Object:  StoredProcedure [dbo].[sp_web_getSaldosStock]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO












CREATE PROCEDURE [dbo].[sp_web_getSaldosStock]
	@iddeposito nvarchar(4),
	@idarticulo nvarchar(25),
	@page int = 1
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @WHERE NVARCHAR(250)
	DECLARE @rs NVARCHAR(MAX)
	DECLARE @from NVARCHAR(10), @until NVARCHAR(10), @rowsOfPage INT;

	SET @rowsOfPage = 31

	IF @page = 1
		SET @from = 1
	ELSE
		SET @from = (@page * @rowsOfPage) - @rowsOfPage + 1

	SET @until = (@page * @rowsOfPage)

	SET @WHERE = ''
	IF @iddeposito != ''
		SET @WHERE = ' AND LTRIM(a.deposito) = ''' + @iddeposito + ''''

	if @idarticulo != ''
		SET @WHERE = @WHERE + ' AND LTRIM(a.idarticulo) = ''' + @idarticulo + ''''



	SET @rs = 'SELECT * FROM (
	SELECT ROW_NUMBER() OVER (ORDER BY a.IDARTICULO) as RowNr, ltrim(a.idarticulo) as idarticulo,a.descripcion,a.idunidad,convert(varchar,convert(decimal(15,2),a.stock)) as stock,a.deposito,a.descrubro,
	convert(varchar,convert(decimal(15,2),a.costo)) as costo,
	(Select convert(varchar,convert(decimal(15,2),isnull(sum(Cant_BL),0))) from v_MV_stock where (anulado = 0 or anulado = null) and idarticulo = a.idarticulo and IDDeposito = a.deposito) as stockbl
	FROM STK_MA_ARTICULOS a
	WHERE ((a.suspendido=0 or a.suspendido is null) and (a.no_controla_stock=0 or a.no_controla_stock is null)) 
	' + @WHERE + ') g
	WHERE RowNr BETWEEN ' + @from + ' AND ' + @until

	EXEC(@rs)

END







GO

/****** Object:  StoredProcedure [dbo].[sp_web_getSaldosStockCardTotal]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO












CREATE PROCEDURE [dbo].[sp_web_getSaldosStockCardTotal]
	@iddeposito nvarchar(4),
	@idarticulo nvarchar(25)
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @WHERE NVARCHAR(250)
	DECLARE @rs NVARCHAR(MAX)


	SET @WHERE = ''
	IF @iddeposito != ''
		SET @WHERE = ' AND LTRIM(a.deposito) = ''' + @iddeposito + ''''

	if @idarticulo != ''
		SET @WHERE = @WHERE + ' AND LTRIM(a.idarticulo) = ''' + @idarticulo + ''''


	SET @rs = '
	SELECT convert(varchar,convert(decimal(15,2),SUM(stock))) as stock, 
	convert(varchar,convert(decimal(15,2),SUM(valorizado))) as valorizado,
	convert(varchar,convert(decimal(15,2),SUM(costo))) as costo
	FROM (
	SELECT ltrim(a.idarticulo) as idarticulo,a.descripcion,a.stock,
	a.costo,
	a.costo * a.stock as valorizado
	FROM STK_MA_ARTICULOS a
	WHERE ((a.suspendido=0 or a.suspendido is null) and (a.no_controla_stock=0 or a.no_controla_stock is null)) 
	' + @WHERE + '
	) AS c
	'


	EXEC(@rs)

END







GO

/****** Object:  StoredProcedure [dbo].[sp_web_getSaldosStockPagination]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO










CREATE PROCEDURE [dbo].[sp_web_getSaldosStockPagination]
	@iddeposito nvarchar(4),
	@idarticulo nvarchar(25)
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @WHERE NVARCHAR(250)
	DECLARE @rs NVARCHAR(MAX)
	DECLARE @rowsOfPage INT

	SET @rowsOfPage = 31

	SET @WHERE = ''
	IF @iddeposito != ''
		SET @WHERE = ' AND LTRIM(a.deposito) = ''' + @iddeposito + ''''

	if @idarticulo != ''
		SET @WHERE = @WHERE + ' AND LTRIM(a.idarticulo) = ''' + @idarticulo + ''''



	SET @rs = '
	SELECT (COUNT(*)/30)+1  as cantidad from(
	SELECT ltrim(a.idarticulo) as idarticulo,a.descripcion,a.idunidad,convert(varchar,convert(decimal(15,2),a.stock)) as stock,a.deposito,a.descrubro,
	convert(varchar,convert(decimal(15,2),a.costo)) as costo,
	(Select convert(varchar,convert(decimal(15,2),isnull(sum(Cant_BL),0))) from v_MV_stock where (anulado = 0 or anulado = null) and idarticulo = a.idarticulo and IDDeposito = a.deposito) as stockbl
	FROM STK_MA_ARTICULOS a
	WHERE ((a.suspendido=0 or a.suspendido is null) and (a.no_controla_stock=0 or a.no_controla_stock is null)) 
	' + @WHERE + ') as d'
	EXEC(@rs)

END







GO

/****** Object:  StoredProcedure [dbo].[sp_web_getSaldoTJCaja]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO











CREATE PROCEDURE [dbo].[sp_web_getSaldoTJCaja]
	@fecha nvarchar(25),
	@idcaja nvarchar(4)
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @WHERE NVARCHAR(250)
	DECLARE @rs NVARCHAR(MAX)


	SET @WHERE = ''

	IF @idcaja != ''
		SET @WHERE = ' AND LTRIM(a.idcajas) = ''' + @idcaja + ''''

	if @fecha != ''
		SET @WHERE = @WHERE + ' AND a.fecha = ''' + @fecha + ''''


	SET @rs = '
	SELECT  a.CUENTA + '' '' + b.DESCRIPCION AS tarjeta, convert(varchar,convert(decimal(15,2),sum(a.IMPORTE))) as importe, a.idcajas
    FROM dbo.MV_ASIENTOS a INNER JOIN dbo.MA_CUENTAS b ON a.CUENTA = b.CODIGO
    WHERE (b.MedioDePago = N''TJ'')  AND (a.TC = ''CB'' OR a.TC = ''CBCT'' OR a.TC = ''CBFP'')
    ' + @WHERE + '
    GROUP BY A.CUENTA, B.DESCRIPCION, a.idcajas
    ORDER BY A.CUENTA
	'

	EXEC(@rs)

END







GO

/****** Object:  StoredProcedure [dbo].[sp_web_getStockDepositos]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO













CREATE PROCEDURE [dbo].[sp_web_getStockDepositos]
	@idarticulo nvarchar(25)
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @rs NVARCHAR(MAX)
	DECLARE @real MONEY
	DECLARE @comprometido MONEY
	DECLARE @sugerido NVARCHAR(20)
	DECLARE @coeficiente FLOAT
	DECLARE @udVenta NVARCHAR(4)
	DECLARE @udPedido NVARCHAR(4)

	SET @real = isnull((SELECT isnull(sum(STOCK),0)
	FROM STK_MA_ARTICULOS
	WHERE ltrim(IDARTICULO) = ltrim(@idarticulo)
	group by idarticulo ),0)

	SET @comprometido = isnull((SELECT isnull(SUM(saldo),0)
	FROM VT_V_MV_INSUMOS_SALDOSRM
	WHERE ltrim(IDARTICULO) = ltrim(@idarticulo)),0)

	SET @sugerido =  isnull(CONVERT(varchar(20), @real - @comprometido),'0')

	--Tomo la equivalencia del pedido
	SELECT @coeficiente = isnull(S_TA_EQUIV.COEFICIENTE,0), @udPedido = V_MA_ARTICULOS.UD_TTE, @udVenta = V_MA_ARTICULOS.IDUNIDAD
	FROM V_MA_ARTICULOS
		LEFT JOIN S_TA_EQUIV on V_MA_ARTICULOS.IDARTICULO = S_TA_EQUIV.IDARTICULO
			and V_MA_ARTICULOS.IDUNIDAD=S_TA_EQUIV.IDUNIDAD_EQUIV and V_MA_ARTICULOS.UD_TTE=S_TA_EQUIV.IDUNIDAD
	WHERE LTRIM(V_MA_ARTICULOS.IDARTICULO)=LTRIM(@idarticulo)

	if @coeficiente = 0 SET @coeficiente = 1
	
	IF @coeficiente > 0 and @udPedido <> @udVenta AND @udPedido<>''
		BEGIN
		SET @real = ROUND(@real / @coeficiente,0)
		SET @comprometido = ROUND(@comprometido / @coeficiente,0)
		SET @sugerido = ROUND(@sugerido / @coeficiente,0)
	END

	SET @rs = '
	SELECT deposito, convert(varchar,convert(decimal(15,2),stock)) as stock FROM (
	SELECT ''@REAL'' as deposito, ''' + CONVERT(varchar(20),@real) + ''' as stock
	UNION
	SELECT ''@COMPROMETIDO'' as deposito, ''' + CONVERT(varchar(20),@comprometido) + '''
	UNION
	SELECT ''@SUGERIDO'' as deposito,''' + @sugerido + ''' as stock
	UNION
	SELECT isnull(ltrim(a.DEPOSITO),'''')  + '' '' + isnull(b.descripcion,'''') as deposito, ROUND(ISNULL(sum(a.stock / ''' + CONVERT(varchar(20),@coeficiente) + '''),0),0) as stock
	FROM Stk_Ma_Articulos a LEFT JOIN V_TA_DEPOSITO b ON a.DEPOSITO = b.idDeposito WHERE LTRIM(a.idarticulo)=''' + @idarticulo + '''
	group by a.IDARTICULO,a.DEPOSITO, b.Descripcion	) AS A WHERE deposito<>'''''


	/*
	SET @rs = '
	SELECT deposito, convert(varchar,convert(decimal(15,2),stock)) as stock FROM (
	SELECT ''@REAL'' as deposito, isnull(sum(STOCK),0) as stock FROM STK_MA_ARTICULOS WHERE ltrim(IDARTICULO) = ''' + @idarticulo + ''' group by idarticulo 
	UNION
	SELECT ''@COMPROMETIDO'' as deposito,isnull(stock,0) as stock FROM wsSysMobileStockComprometidoArticulos WHERE ltrim(IDARTICULO) = ''' + @idarticulo + '''
	UNION
	SELECT ''@SUGERIDO'' as deposito,''' + @sugerido + ''' as stock
	UNION
	SELECT isnull(ltrim(a.DEPOSITO),'''')  + '' '' + isnull(b.descripcion,'''') as deposito, ISNULL(sum(a.stock),0) as stock
	FROM Stk_Ma_Articulos a LEFT JOIN V_TA_DEPOSITO b ON a.DEPOSITO = b.idDeposito WHERE LTRIM(a.idarticulo)=''' + @idarticulo + '''
	group by a.IDARTICULO,a.DEPOSITO, b.Descripcion	) AS A WHERE deposito<>'''''
	*/
	EXEC(@rs)

END




GO

/****** Object:  StoredProcedure [dbo].[sp_web_getTareaHelpdesk]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO












CREATE PROCEDURE [dbo].[sp_web_getTareaHelpdesk]
	@idcomprobante	nvarchar(13)
AS

SET NOCOUNT ON


SELECT tipo, tc, isnull(estado_actual,'') as estado_actual, idcomprobante, idtarea, descripcion, observaciones, convert(NVARCHAR(18),fecha,103) + ' ' + convert(NVARCHAR(18),fecha,108) as fecha, isnull(color,0) as color, (minutos /60) as horas
FROM (
																SELECT 'C' as tipo, (SELECT TOP 1
				ISNULL(CAST(OBSERVACIONES as NVARCHAR(MAX)) ,'') as observaciones
			FROM V_MV_STATUS
			WHERE TC='OT' AND IdComprobante=@idcomprobante
			ORDER BY NroMov DESC) as estado_actual,
			tc, idcomprobante, IDTAREA, DESCRIPCION, ISNULL(CAST(DescripcionAdicional  as NVARCHAR(MAX)) ,'') as observaciones, FechaEstInicio as fecha,
			(SELECT TOP 1
				color
			FROM V_MV_STATUS LEFT JOIN V_TA_STATUS ON V_MV_STATUS.IdEstado = V_TA_STATUS.CodigoEstado
			WHERE TC='OT' AND IdComprobante=@idcomprobante
			ORDER BY NroMov DESC) as color, horas as minutos
		FROM
			V_MV_CpteTareas
		WHERE idcomprobante=@idcomprobante
	UNION
		SELECT 'D' as tipo, isnull(v_ta_tecnicos.nombre,usuario) as estado_actual, TC, IDCOMPROBANTE, IDTarea, Descripcion, ISNULL(CAST(OBSERVACIONES as NVARCHAR(MAX)) ,'') as observaciones, fecha, 0 as color, MINUTOS
		FROM V_MV_Diarios LEFT JOIN V_TA_TECNICOS ON V_MV_DIARIOS.idtecnico =  
	V_TA_TECNICOS.idtecnico
		WHERE idcomprobante=@idcomprobante AND (V_MV_Diarios.IdTecnico='' or V_MV_Diarios.IdTecnico is null)
	UNION
		SELECT 'T' as tipo, isnull(v_ta_tecnicos.nombre,usuario) as estado_actual, TC, IDCOMPROBANTE, IDTarea, Descripcion, ISNULL(CAST(OBSERVACIONES as NVARCHAR(MAX)) ,'') as observaciones, fecha, 0 as color, MINUTOS
		FROM V_MV_Diarios LEFT JOIN V_TA_TECNICOS ON V_MV_DIARIOS.idtecnico =  
	V_TA_TECNICOS.idtecnico
		WHERE idcomprobante=@idcomprobante AND (V_MV_Diarios.IdTecnico <>'') order by iddiario offset 1 rows
	UNION
		SELECT 'S' as tipo, '' as estado_actual, TC, IdComprobante, IdTarea, '' as descripcion, ISNULL(CAST(OBSERVACIONES as NVARCHAR(MAX)) ,'') as observaciones, FechaHora as fecha, color, 0 as minutos
		FROM V_MV_STATUS
			LEFT JOIN V_TA_STATUS ON V_MV_STATUS.IdEstado = V_TA_STATUS.CodigoEstado
		WHERE idcomprobante=@idcomprobante
	UNION
		SELECT 'Y' as tipo,
			(case when documento like '%\%' then reverse(left(reverse(documento), charindex('\', reverse(documento)) - 1)) else '' end) as estado_actual,
			tc, IDCOMPROBANTE, CAST(id as nvarchar(100)) as idtarea, (case when documento like '%.%' then reverse(left(reverse(documento), charindex('.', reverse(documento)) - 1)) else '' end) as descripcion
	, documento as observaciones, GETDATE() as fecha, 0 as color, 0 as horas
		from V_MV_CpteDoc
		where IDCOMPROBANTE=@idcomprobante
	UNION
		SELECT 'X' as tipo, '' as estado_actual, TC, IdComprobante, '' as idtarea, '' as descripcion, ISNULL(CAST(OBSERVACIONES as NVARCHAR(MAX)) ,'') as observaciones, '01/01/3000' as fecha, 0 as color, 0 as minutos
		FROM V_MV_CPTE
		WHERE idcomprobante=@idcomprobante AND TC='OT'
	) AS D
ORDER BY fecha
GO

/****** Object:  StoredProcedure [dbo].[sp_web_getTareas]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO












CREATE PROCEDURE [dbo].[sp_web_getTareas]
	@idcliente nvarchar(9) = '',
	@estado nvarchar(1) = '',
	@presupuesto nvarchar(13) = '',
	@fechaDesde nvarchar(10),
	@fechaHasta nvarchar(10),
	@idtarea nvarchar(4) = ''
AS

BEGIN

	SET NOCOUNT ON;
	DECLARE @rs NVARCHAR(MAX)
	DECLARE @whCuenta NVARCHAR(200)
	DECLARE @whPresupuesto NVARCHAR(200)
	DECLARE @whEstado NVARCHAR(200)
	DECLARE @whIdTarea NVARCHAR(200)
	DECLARE @top NVARCHAR(5)

	SET @top = '30'

	IF @idtarea <> ''
		SET @whIdTarea = ' and ltrim(a.idtarea) = ''' + @idtarea + ''' '
	ELSE
		SET @whIdTarea = ''

	IF @idcliente <> ''
		SET @whCuenta = ' and b.cuenta = ''' + @idcliente +  ''' ' 
	ELSE
		SET @whCuenta = ''

	IF @presupuesto <> ''
		SET @whPresupuesto = ' and b.comprobanteorigen = ''' + @presupuesto +  ''' ' 
	ELSE
		SET @whPresupuesto = ''

	IF @estado <> ''
		BEGIN
		IF @estado = 'P'
				SET @whEstado = ' WHERE (tipo=''P'' OR tipo=''E'' OR tipo is null) '
			ELSE
				SET @whEstado = ' WHERE tipo = ''' + @estado + ''' '
		END
	ELSE
		SET @whEstado = ''

	IF @whEstado <> ''
		SET @whEstado = @whEstado + ' AND (fecha>=''' + @fechaDesde + ' 00:00:01'' AND fecha<=''' + @fechaHasta + ' 23:59:59'') '
	ELSE
		SET @whEstado = ' WHERE (fecha>=''' + @fechaDesde + ' 00:00:01'' AND fecha<=''' + @fechaHasta + ' 23:59:59'') '



	SET @rs = '
	SELECT idtarea,isnull(descripcion_tarea,'''') as descripcion_tarea,fecha as fechaorden,CONVERT(NVARCHAR(10),fecha,103) as fecha,id,descripcion,isnull(idtecnico,'''') as idtecnico,isnull(NombreTecnico,'''') as nombre_tecnico,idcomprobante,cuenta,nombre,isnull(idestado,'''') as idestado,isnull(estado,'''') as estado
	,isnull(color,'''') as color,isnull(tipo,'''') as tipo,isnull(comprobanteorigen,'''') as presupuesto,descripcionadicional,horas as minutos,isnull(solicitante,'''') as solicitante FROM (
    Select  isnull(ltrim(idtarea),'''') as idtarea,descripcion_tarea,FechaEstInicio as fecha, id, z.descripcion, IdTecnico , NombreTecnico , IDCOMPROBANTE , CUENTA, nombre,idestado, x.Descripcion as Estado, x.Color, x.Tipo, comprobanteorigen,ISNULL(CAST(descripcionadicional as NVARCHAR(MAX)) ,'''') as descripcionadicional,horas,solicitante  from (
    Select top ' +  @top  + ' a.idtarea,d.DESCRIPCION as descripcion_tarea,a.FechaEstInicio, a.id, a.descripcion, a.idtecnico, c.Nombre as NombreTecnico,a.idcomprobante , b.cuenta,b.nombre, b.comprobanteorigen,ISNULL(CAST(a.descripcionadicional as NVARCHAR(MAX)) ,'''') as descripcionadicional,a.horas,b.solicitante,
    (select top 1 idestado from v_mv_status where a.IDCOMPROBANTE = V_MV_STATUS.IdComprobante and v_mv_status.tc = ''OT''
    ORDER BY v_mv_status.FechaHora Desc) as IdEstado 
    from v_mv_cptetareas a inner join v_mv_cpte b on a.tc = b.tc and a.idcomprobante = b.idcomprobante ' + @whCuenta + ' ' + @whIdTarea + '
	left outer  join v_ta_tecnicos c on a.IdTecnico = c.IdTecnico 
	LEFT JOIN V_TA_Tareas d on a.IDTAREA = d.IdTarea
	where a.FechaRealFin is null AND A.TC = ''OT'' 
    ' + @whPresupuesto + '
    order by a.fechaestinicio desc, a.idcomprobante desc
    ) z left outer join v_ta_status x on z.idestado = x.codigoestado where (tipo <> ''A'' or tipo is null)
    UNION
    Select  isnull(ltrim(idtarea),'''') as idtarea,descripcion_tarea,FechaEstInicio, id, z.descripcion, IdTecnico , NombreTecnico , IDCOMPROBANTE , CUENTA,nombre, idestado, x.Descripcion as Estado, x.Color, x.Tipo,COMPROBANTEORIGEN,ISNULL(CAST(descripcionadicional as NVARCHAR(MAX)) ,'''') as descripcionadicional,horas,solicitante from (
    Select top ' +  @top  + ' a.idtarea,d.DESCRIPCION as descripcion_tarea,a.FechaEstInicio, a.id, a.descripcion, a.idtecnico, c.Nombre as NombreTecnico,a.idcomprobante , b.cuenta,b.nombre, b.comprobanteorigen,ISNULL(CAST(a.descripcionadicional as NVARCHAR(MAX)) ,'''') as descripcionadicional,a.horas,b.solicitante,
    (select top 1 idestado from v_mv_status where a.IDCOMPROBANTE = V_MV_STATUS.IdComprobante and v_mv_status.tc = ''OT''
    ORDER BY v_mv_status.FechaHora Desc) as IdEstado
    from v_mv_cptetareas a inner join v_mv_cpte b on a.tc = b.tc and a.idcomprobante = b.idcomprobante ' + @whCuenta + '  ' + @whIdTarea + '
	left outer  join v_ta_tecnicos c on a.IdTecnico = c.IdTecnico 
	LEFT JOIN V_TA_Tareas d on a.IDTAREA = d.IdTarea
	where a.FechaRealFin <> '''' AND A.TC = ''OT''
    ' + @whPresupuesto + '
    order by a.fechaestinicio desc, a.idcomprobante desc 
    ) z left outer join v_ta_status x on z.idestado = x.codigoestado where (tipo <> ''A'' or tipo is null)
    ) as j ' + @whEstado + '  ORDER by fechaorden desc,id desc '

	EXEC(@rs)
END






GO

/****** Object:  StoredProcedure [dbo].[sp_web_getTransferenciasCaja]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO












CREATE PROCEDURE [dbo].[sp_web_getTransferenciasCaja]
	@fecha nvarchar(25),
	@idcaja nvarchar(4)
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @WHERE NVARCHAR(250)
	DECLARE @rs NVARCHAR(MAX)


	SET @WHERE = ''

	IF @idcaja != ''
		SET @WHERE = ' AND LTRIM(a.idcajas) = ''' + @idcaja + ''''

	if @fecha != ''
		SET @WHERE = @WHERE + ' AND a.fecha = ''' + @fecha + ''''



	SET @rs = '	
	SELECT CONVERT(NVARCHAR(10),A.fecha,103) as fecha, A.cuenta, dbo.MA_CUENTAS.descripcion,convert(varchar,convert(decimal(15,2),A.importe)) AS egreso, convert(varchar,convert(decimal(15,2),B.importe)) AS ingreso,
    A.IdCajas AS origen, B.IdCajas AS destino, A.moneda ,convert(varchar,convert(decimal(15,2),A.cotizacion)) as cotizacion , a.tc, a.sucursal, a.numero, a.letra
    FROM (SELECT TC, SUCURSAL, NUMERO, LETRA, IdCajas, CUENTA, FECHA, [DEBE-HABER], SUM(IMPORTE) AS Importe, MONEDA, COTIZACION
    From dbo.MV_ASIENTOS WHERE ([DEBE-HABER] = ''H'') GROUP BY TC, SUCURSAL, NUMERO, LETRA, IdCajas, CUENTA, FECHA, [DEBE-HABER], MONEDA, COTIZACION) AS A
    FULL OUTER JOIN
    (SELECT TC, SUCURSAL, NUMERO, LETRA, IdCajas, CUENTA, FECHA, [DEBE-HABER], SUM(IMPORTE) AS Importe, MONEDA, COTIZACION
    FROM dbo.MV_ASIENTOS AS MV_ASIENTOS_1 WHERE ([DEBE-HABER] = ''D'') GROUP BY TC, SUCURSAL, NUMERO, LETRA, IdCajas, CUENTA, FECHA, [DEBE-HABER], MONEDA, COTIZACION) AS B
    ON A.IdCajas <> B.IdCajas AND A.CUENTA = B.CUENTA AND A.TC = B.TC AND A.SUCURSAL = B.SUCURSAL AND A.NUMERO = B.NUMERO AND A.LETRA = B.LETRA AND A.MONEDA = B.MONEDA AND A.COTIZACION = B.COTIZACION
    INNER JOIN dbo.MA_CUENTAS ON dbo.MA_CUENTAS.CODIGO = A.CUENTA
    WHERE (NOT (B.IdCajas IS NULL)) AND (NOT (dbo.MA_CUENTAS.MedioDePago IS NULL)) AND (dbo.MA_CUENTAS.MedioDePago <> '''')
    ' + @WHERE

	EXEC(@rs)

END







GO

/****** Object:  StoredProcedure [dbo].[sp_web_setCobranza]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO









CREATE PROCEDURE [dbo].[sp_web_setCobranza]
	@Tc 							 nvarchar(4) = null,
	@pCliente						 nvarchar(15) = null,
	@pVendedor						 nvarchar(4) = null,
	@pFecha	     					 datetime = null,
	@pImporte						 real=0,
	@pObs							 varchar(250),
	@pMp							 varchar(100),
	@idWeb							 varchar(100),
	@pChequeNumero					 nvarchar(50) = null,
	@pChequeVencimiento				 datetime = null,
	@pChequeIdBanco				     nvarchar(4) = null,
	@pResultado 					 smallint = NULL OUTPUT,
	@pMensaje 						 varchar(255) = NULL OUTPUT
AS
DECLARE @IdComprobante NVARCHAR(13)
DECLARE @nombre NVARCHAR(50)
DECLARE @domicilio NVARCHAR(50)
DECLARE @calle NVARCHAR(50)
DECLARE @numero NVARCHAR(50)
DECLARE @piso NVARCHAR(50)
DECLARE @departamento NVARCHAR(50)
DECLARE @telefono NVARCHAR(100)
DECLARE @localidad NVARCHAR(50)
DECLARE @idProvincia NVARCHAR(4)
DECLARE @codigoPostal NVARCHAR(10)
DECLARE @documentoTipo NVARCHAR(4)
DECLARE @documentoNumero NVARCHAR(13)
DECLARE @condicionIva NVARCHAR(50)
DECLARE @idCondCpraVta NVARCHAR(4)
DECLARE @comentarios NVARCHAR(100)
DECLARE @clasePrecio int
DECLARE @idlista NVARCHAR(4)
DECLARE @FechaHoraGrabacion DATETIME
DECLARE @unegocio NVARCHAR(4)
DECLARE @USUARIO AS NVARCHAR(50)

SET NOCOUNT ON
IF @Tc = '' SET @Tc = 'CB'

SELECT @nombre = ISNULL(RAZON_SOCIAL,''),
	@calle = ISNULL(CALLE,'.'),
	@numero = ISNULL(NUMERO,'.'),
	@piso = ISNULL(PISO,''),
	@departamento = ISNULL(DEPARTAMENTO,''),
	@telefono = TELEFONO,
	@localidad = LOCALIDAD,
	@idProvincia = PROVINCIA,
	@codigoPostal = CPOSTAL,
	@documentoTipo = DOCUMENTO_TIPO,
	@documentoNumero = NUMERO_DOCUMENTO,
	@condicionIva = IVA,
	@idCondCpraVta = IDCOND_CPRA_VTA,
	@clasePrecio = CLASE,
	@comentarios = OBSERVACIONES,
	@idlista= IdLista
FROM VT_CLIENTES
WHERE CODIGO = @pCliente

SET @domicilio = @calle + ' ' + @numero
IF (@piso <> '') SET @domicilio= @domicilio+ ' ' + LTRIM(RTRIM(@piso)) + ' Piso '
IF (@departamento <> '') SET @domicilio= @domicilio+ ' Dpto: ' +  LTRIM(RTRIM(@departamento))
IF (@condicionIva=NULL) SET @condicionIva = '   1'
SET @idComprobante = dbo.FN_OBTIENE_PROXIMO_NUMERO_CPTE (@tc,'9999','X')
IF (@clasePrecio IS NULL) OR (@clasePrecio = NULL)
	SET @clasePrecio = 1

IF @pChequeIdBanco <> ''
	SET @pChequeIdBanco = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pChequeIdBanco)),4)
ELSE
	SET @pChequeIdBanco = Null

IF @pObs = ''
	SET @pObs = 'Cob. ' + @nombre

SET @USUARIO = SYSTEM_USER
SET @pVendedor = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pVendedor)),4)

SELECT @unegocio = VALOR
FROM TA_CONFIGURACION
WHERE CLAVE ='UNEGOCIO'

SET @unegocio=dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@unegocio)),4)

IF (@unegocio IS NULL) OR (@unegocio='')
	SET @unegocio='   1'

SET @FechaHoraGrabacion  = @pFecha
SET @pFecha = CONVERT(VARCHAR,@pFecha,103)

DECLARE @pIdReparto INT
SET @pIdReparto=0

DECLARE @NroAsiento INT
DECLARE @Periodo NVARCHAR(6)
DECLARE @CuentaMP NVARCHAR(15)
DECLARE @Mes_operativo INT

SET @CuentaMP = @pMp
IF @CuentaMP = '' SET @CuentaMP = (SELECT VALOR
FROM TA_CONFIGURACION
WHERE CLAVE='CUENTA_CAJA')
--Efectivo
IF @CuentaMP = '' SET @CuentaMP	= '111010001'

SET @Mes_operativo = month(@pFecha)

SET @Periodo = (SELECT top 1
	periodo
FROM MV_EJERCICIOS
WHERE [FECHA DESDE]<=@pFecha and [FECHA HASTA]>=@pFecha)
IF (@Periodo is null)
	SET @Periodo = '0'

SET @NroAsiento = (SELECT MAX([NUMERO ASIENTO])
FROM MV_ASIENTOS
WHERE MES_OPERATIVO=@Mes_operativo AND RTRIM(LTRIM(TIPO_REG))='CB' AND RTRIM(LTRIM(PERIODO))= @Periodo)
IF @NroAsiento is null or @NroAsiento = ''
	SET @NroAsiento = 1

SET NOCOUNT ON
BEGIN TRANSACTION
BEGIN
	INSERT INTO V_MV_CPTE
		( TC,IDCOMPROBANTE,IDCOMPLEMENTO,
		FECHA,FECHAESTFIN,CUENTA,
		NOMBRE,DOMICILIO,TELEFONO,
		LOCALIDAD,IDPROVINCIA,CODIGOPOSTAL,
		DOCUMENTOTIPO,DOCUMENTONUMERO,CONDICIONIVA,
		IDCOND_CPRA_VTA,COMENTARIOS,IMPORTE,IMPORTE_S_IVA,
		MONEDA,IDVENDEDOR,CLASEPRECIO,IdLista,FechaHora_Grabacion,IdReparto,UNEGOCIO,UNEGOCIO_DESTINO,Usuario,
		SUCURSAL,NUMERO,LETRA,OBSERVACIONES)
	VALUES
		(
			@Tc, @IdComprobante, 0,
			@pFecha, @pFecha, @pCliente,
			@Nombre, @Domicilio, @Telefono,
			@Localidad, @idProvincia, @codigoPostal,
			@documentoTipo, @documentoNumero, @condicionIva,
			@idCondCpraVta, @pObs, @pImporte, 0,
			'   1', @pVendedor, @clasePrecio, @idlista, @FechaHoraGrabacion, @pIdReparto, @unegocio, @unegocio, @USUARIO,
			SUBSTRING(@IdComprobante,1,4), SUBSTRING(@IdComprobante,5,8), RIGHT(@IdComprobante,1), 'Cobranza Web Nro: ' + @idWeb)

	INSERT INTO MV_ASIENTOS
		(CUENTA,SECUENCIA,MES_OPERATIVO,[NUMERO ASIENTO], FECHA, DETALLE,TC,SUCURSAL,
		NUMERO,LETRA,[DEBE-HABER],IMPORTE,MONEDA,COTIZACION,PERIODO,CABIMPORTE,TIPO_REG,CONTABILIZADO,
		FECHAHORA_GRABACION,FechaSubdiario, USUARIO_LOGEADO, IDCAJAS)
	VALUES
		(@CuentaMP, 1, @Mes_operativo, @NroAsiento, @pFecha, @pObs, @Tc, SUBSTRING(@IdComprobante,1,4), SUBSTRING(@IdComprobante,5,8), RIGHT(@IdComprobante,1), 'D', @pImporte, '   1', 1, @Periodo, @pImporte,
			@Tc, 0, @pFecha, @FechaHoraGrabacion, @USUARIO, '   1')

	INSERT INTO MV_ASIENTOS
		(CUENTA,SECUENCIA,MES_OPERATIVO,[NUMERO ASIENTO], FECHA, DETALLE,TC,SUCURSAL,
		NUMERO,LETRA,[DEBE-HABER],IMPORTE,MONEDA,COTIZACION,PERIODO,CABIMPORTE,TIPO_REG,CONTABILIZADO,
		FECHAHORA_GRABACION,FechaSubdiario, USUARIO_LOGEADO, IDCAJAS,NroComprobanteBancario,IdBanco,VENCIMIENTO)
	VALUES
		(@pCliente, 2, @Mes_operativo, @NroAsiento, @pFecha, @pObs, @Tc, SUBSTRING(@IdComprobante,1,4), SUBSTRING(@IdComprobante,5,8), RIGHT(@IdComprobante,1), 'H', @pImporte, '   1', 1, @Periodo, @pImporte,
			@Tc, 0, @pFecha, @FechaHoraGrabacion, @USUARIO, '   1',@pChequeNumero,@pChequeIdBanco,@pChequeVencimiento)

	IF @@ERROR <> 0 OR @@ROWCOUNT <> 1
					BEGIN
		ROLLBACK TRANSACTION

		SET @pResultado = 21
		SET @pMensaje = 'No pudo darse de alta EL PEDIDO correctamente'
		RETURN
	END
	COMMIT TRANSACTION
	SET @pResultado = 11
	SET @pMensaje = 'El Pedido se ha dado de alta con ?xito'

END



GO

/****** Object:  StoredProcedure [dbo].[sp_web_setCobranzaConPago]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO









CREATE PROCEDURE [dbo].[sp_web_setCobranzaConPago]
	@Tc 							 nvarchar(4) = null,
	@pCliente						 nvarchar(15) = null,
	@pVendedor						 nvarchar(4) = null,
	@pFecha	     					 datetime = null,
	@pImporte						 real=0,
	@pObs							 varchar(250),
	@pMp							 varchar(100),
	@idWeb							 varchar(100),
	@pChequeNumero					 nvarchar(50) = null,
	@pChequeVencimiento				 datetime = null,
	@pChequeIdBanco				     nvarchar(4) = null,
	@pResultado 					 smallint = NULL OUTPUT,
	@pMensaje 						 varchar(255) = NULL OUTPUT
AS
DECLARE @IdComprobante NVARCHAR(13)
DECLARE @nombre NVARCHAR(50)
DECLARE @domicilio NVARCHAR(50)
DECLARE @calle NVARCHAR(50)
DECLARE @numero NVARCHAR(50)
DECLARE @piso NVARCHAR(50)
DECLARE @departamento NVARCHAR(50)
DECLARE @telefono NVARCHAR(100)
DECLARE @localidad NVARCHAR(50)
DECLARE @idProvincia NVARCHAR(4)
DECLARE @codigoPostal NVARCHAR(10)
DECLARE @documentoTipo NVARCHAR(4)
DECLARE @documentoNumero NVARCHAR(13)
DECLARE @condicionIva NVARCHAR(50)
DECLARE @idCondCpraVta NVARCHAR(4)
DECLARE @comentarios NVARCHAR(100)
DECLARE @clasePrecio int
DECLARE @idlista NVARCHAR(4)
DECLARE @FechaHoraGrabacion DATETIME
DECLARE @unegocio NVARCHAR(4)
DECLARE @USUARIO AS NVARCHAR(50)

SET NOCOUNT ON
IF @Tc = '' SET @Tc = 'CB'

SELECT @nombre = ISNULL(RAZON_SOCIAL,''),
	@calle = ISNULL(CALLE,'.'),
	@numero = ISNULL(NUMERO,'.'),
	@piso = ISNULL(PISO,''),
	@departamento = ISNULL(DEPARTAMENTO,''),
	@telefono = TELEFONO,
	@localidad = LOCALIDAD,
	@idProvincia = PROVINCIA,
	@codigoPostal = CPOSTAL,
	@documentoTipo = DOCUMENTO_TIPO,
	@documentoNumero = NUMERO_DOCUMENTO,
	@condicionIva = IVA,
	@idCondCpraVta = IDCOND_CPRA_VTA,
	@clasePrecio = CLASE,
	@comentarios = OBSERVACIONES,
	@idlista= IdLista
FROM VT_CLIENTES
WHERE CODIGO = @pCliente

SET @domicilio = @calle + ' ' + @numero
IF (@piso <> '') SET @domicilio= @domicilio+ ' ' + LTRIM(RTRIM(@piso)) + ' Piso '
IF (@departamento <> '') SET @domicilio= @domicilio+ ' Dpto: ' +  LTRIM(RTRIM(@departamento))
IF (@condicionIva=NULL) SET @condicionIva = '   1'
SET @idComprobante = dbo.FN_OBTIENE_PROXIMO_NUMERO_CPTE (@tc,'9999','X')
IF (@clasePrecio IS NULL) OR (@clasePrecio = NULL)
	SET @clasePrecio = 1

IF @pChequeIdBanco <> ''
	SET @pChequeIdBanco = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pChequeIdBanco)),4)
ELSE
	SET @pChequeIdBanco = Null

IF @pObs = ''
	SET @pObs = 'Cob. ' + @nombre

SET @USUARIO = SYSTEM_USER
SET @pVendedor = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pVendedor)),4)

SELECT @unegocio = VALOR
FROM TA_CONFIGURACION
WHERE CLAVE ='UNEGOCIO'

SET @unegocio=dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@unegocio)),4)

IF (@unegocio IS NULL) OR (@unegocio='')
	SET @unegocio='   1'

SET @FechaHoraGrabacion  = @pFecha
SET @pFecha = CONVERT(VARCHAR,@pFecha,103)

DECLARE @pIdReparto INT
SET @pIdReparto=0

DECLARE @NroAsiento INT
DECLARE @Periodo NVARCHAR(6)
DECLARE @CuentaMP NVARCHAR(15)
DECLARE @Mes_operativo INT

SET @CuentaMP = @pMp
IF @CuentaMP = '' SET @CuentaMP = (SELECT VALOR
FROM TA_CONFIGURACION
WHERE CLAVE='CUENTA_CAJA')
--Efectivo
IF @CuentaMP = '' SET @CuentaMP	= '111010001'

SET @Mes_operativo = month(@pFecha)

SET @Periodo = (SELECT top 1
	periodo
FROM MV_EJERCICIOS
WHERE [FECHA DESDE]<=@pFecha and [FECHA HASTA]>=@pFecha)
IF (@Periodo is null)
	SET @Periodo = '0'

SET @NroAsiento = (SELECT MAX([NUMERO ASIENTO])
FROM MV_ASIENTOS
WHERE MES_OPERATIVO=@Mes_operativo AND RTRIM(LTRIM(TIPO_REG))='CB' AND RTRIM(LTRIM(PERIODO))= @Periodo)
IF @NroAsiento is null or @NroAsiento = ''
	SET @NroAsiento = 1

SET NOCOUNT ON
BEGIN TRANSACTION
BEGIN
	INSERT INTO V_MV_CPTE
		( TC,IDCOMPROBANTE,IDCOMPLEMENTO,
		FECHA,FECHAESTFIN,CUENTA,
		NOMBRE,DOMICILIO,TELEFONO,
		LOCALIDAD,IDPROVINCIA,CODIGOPOSTAL,
		DOCUMENTOTIPO,DOCUMENTONUMERO,CONDICIONIVA,
		IDCOND_CPRA_VTA,COMENTARIOS,IMPORTE,IMPORTE_S_IVA,
		MONEDA,IDVENDEDOR,CLASEPRECIO,IdLista,FechaHora_Grabacion,IdReparto,UNEGOCIO,UNEGOCIO_DESTINO,Usuario,
		SUCURSAL,NUMERO,LETRA,OBSERVACIONES)
	VALUES
		(
			@Tc, @IdComprobante, 0,
			@pFecha, @pFecha, @pCliente,
			@Nombre, @Domicilio, @Telefono,
			@Localidad, @idProvincia, @codigoPostal,
			@documentoTipo, @documentoNumero, @condicionIva,
			@idCondCpraVta, @pObs, @pImporte, 0,
			'   1', @pVendedor, @clasePrecio, @idlista, @FechaHoraGrabacion, @pIdReparto, @unegocio, @unegocio, @USUARIO,
			SUBSTRING(@IdComprobante,1,4), SUBSTRING(@IdComprobante,5,8), RIGHT(@IdComprobante,1), 'Cobranza Web Nro: ' + @idWeb)

	INSERT INTO MV_ASIENTOS
		(CUENTA,SECUENCIA,MES_OPERATIVO,[NUMERO ASIENTO], FECHA, DETALLE,TC,SUCURSAL,
		NUMERO,LETRA,[DEBE-HABER],IMPORTE,MONEDA,COTIZACION,PERIODO,CABIMPORTE,TIPO_REG,CONTABILIZADO,
		FECHAHORA_GRABACION,FechaSubdiario, USUARIO_LOGEADO, IDCAJAS)
	VALUES
		(@CuentaMP, 1, @Mes_operativo, @NroAsiento, @pFecha, @pObs, @Tc, SUBSTRING(@IdComprobante,1,4), SUBSTRING(@IdComprobante,5,8), RIGHT(@IdComprobante,1), 'D', @pImporte, '   1', 1, @Periodo, @pImporte,
			@Tc, 0, @pFecha, @FechaHoraGrabacion, @USUARIO, '   1')

	INSERT INTO MV_ASIENTOS
		(CUENTA,SECUENCIA,MES_OPERATIVO,[NUMERO ASIENTO], FECHA, DETALLE,TC,SUCURSAL,
		NUMERO,LETRA,[DEBE-HABER],IMPORTE,MONEDA,COTIZACION,PERIODO,CABIMPORTE,TIPO_REG,CONTABILIZADO,
		FECHAHORA_GRABACION,FechaSubdiario, USUARIO_LOGEADO, IDCAJAS,NroComprobanteBancario,IdBanco,VENCIMIENTO)
	VALUES
		(@pCliente, 2, @Mes_operativo, @NroAsiento, @pFecha, @pObs, @Tc, SUBSTRING(@IdComprobante,1,4), SUBSTRING(@IdComprobante,5,8), RIGHT(@IdComprobante,1), 'H', @pImporte, '   1', 1, @Periodo, @pImporte,
			@Tc, 0, @pFecha, @FechaHoraGrabacion, @USUARIO, '   1',@pChequeNumero,@pChequeIdBanco,@pChequeVencimiento)

	IF @@ERROR <> 0 OR @@ROWCOUNT <> 1
					BEGIN
		ROLLBACK TRANSACTION

		SET @pResultado = 21
		SET @pMensaje = 'No pudo darse de alta EL PEDIDO correctamente'
		RETURN
	END
	COMMIT TRANSACTION
	SET @pResultado = 11
	SET @pMensaje = 'El Pedido se ha dado de alta con ?xito'

END



GO

/****** Object:  StoredProcedure [dbo].[sp_web_setExtensionTareas]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO








CREATE PROCEDURE [dbo].[sp_web_setExtensionTareas]
	@pIdTecnico						NVARCHAR(4) = NULL,
	@pCliente						 nvarchar(15) = null,
	@pFecha	     					 datetime = null,
	@pObs							 varchar(MAX),
	@pidEstado                       varchar(4) = null,
	@minutos						 int = 10,
	@pNombreContacto                 varchar(50) = null,
	@pTareaId                 		 varchar(4) = null,
	@pIdCpte						 NVARCHAR(13) = NULL OUTPUT,
	@pResultado 					 smallint = NULL OUTPUT,
	@pMensaje 						 varchar(255) = NULL OUTPUT
AS
DECLARE @Tc NVARCHAR(4)
DECLARE @IdComprobante NVARCHAR(13)
DECLARE @nombre NVARCHAR(50)
DECLARE @domicilio NVARCHAR(50)
DECLARE @calle NVARCHAR(50)
DECLARE @numero NVARCHAR(50)
DECLARE @piso NVARCHAR(50)
DECLARE @departamento NVARCHAR(50)
DECLARE @telefono NVARCHAR(100)
DECLARE @localidad NVARCHAR(50)
DECLARE @idProvincia NVARCHAR(4)
DECLARE @codigoPostal NVARCHAR(10)
DECLARE @documentoTipo NVARCHAR(4)
DECLARE @documentoNumero NVARCHAR(13)
DECLARE @condicionIva NVARCHAR(50)
DECLARE @idCondCpraVta NVARCHAR(4)
DECLARE @comentarios NVARCHAR(100)
DECLARE @clasePrecio int
DECLARE @idlista NVARCHAR(4)
DECLARE @FechaHoraGrabacion DATETIME
DECLARE @unegocio NVARCHAR(4)
DECLARE @USUARIO AS NVARCHAR(50)
DECLARE @descTarea as NVARCHAR(50)
DECLARE @pidTarea as NVARCHAR(4)
DECLARE @NROMOV INT
DECLARE @descEstado NVARCHAR(100)
DECLARE @finalizada BIT
DECLARE @fechaRealFin DATETIME
DECLARE @pCpteExistente NVARCHAR(13)
DECLARE @idDIario INT
DECLARE @estadoOtExistente NVARCHAR(4)

SET NOCOUNT ON
SET @Tc = 'OT'

IF @pTareaId = ''
	BEGIN
		SET @pidTarea = 'vs'
		SET @descTarea = 'TAREAS VARIAS'
	END
ELSE
	BEGIN
		SET @pidTarea = @pTareaId
		SELECT @descTarea = descripcion FROM V_TA_TAREAS WHERE ltrim(idtarea)=@pTareaId
	END
	
SELECT @nombre = RAZON_SOCIAL,
	@calle = ISNULL(CALLE,'.'),
	@numero = ISNULL(NUMERO,'.'),
	@piso = ISNULL(PISO,''),
	@departamento = ISNULL(DEPARTAMENTO,''),
	@telefono = TELEFONO,
	@localidad = LOCALIDAD,
	@idProvincia = PROVINCIA,
	@codigoPostal = CPOSTAL,
	@documentoTipo = DOCUMENTO_TIPO,
	@documentoNumero = NUMERO_DOCUMENTO,
	@condicionIva = IVA,
	@idCondCpraVta = IDCOND_CPRA_VTA,
	@clasePrecio = CLASE,
	@comentarios = OBSERVACIONES,
	@idlista= IdLista
FROM VT_CLIENTES
WHERE CODIGO = @pCliente

SET @domicilio = @calle + ' ' + @numero
IF (@piso <> '') SET @domicilio= @domicilio+ ' ' + LTRIM(RTRIM(@piso)) + ' Piso '
IF (@departamento <> '') SET @domicilio= @domicilio+ ' Dpto: ' +  LTRIM(RTRIM(@departamento))
IF (@condicionIva=NULL) SET @condicionIva = '   1'
SET @idComprobante = dbo.FN_OBTIENE_PROXIMO_NUMERO_CPTE (@tc,'9999','X')
IF (@clasePrecio IS NULL) OR (@clasePrecio = NULL)
	SET @clasePrecio = 1

IF @pObs = ''
	SET @pObs = 'Cob. ' + @nombre

SET @USUARIO = @pNombreContacto
SET @pIdTecnico = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pIdTecnico)),4)

SELECT @unegocio = VALOR
FROM TA_CONFIGURACION
WHERE CLAVE ='UNEGOCIO'

SET @unegocio= '' --dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pVendedor)),4)

IF (@unegocio IS NULL) OR (@unegocio='')
	SET @unegocio='   1'

SET @FechaHoraGrabacion  = GETDATE()
SET @pFecha = CONVERT(VARCHAR,@pFecha,103)

SET @pidEstado = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pidEstado)),4)

DECLARE @pPResupuesto NVARCHAR(13)

SET @pPResupuesto = (SELECT TOP 1 a.idcomprobante
FROM v_mv_cpte a LEFT JOIN V_MV_CpteTareas b ON a.TC = b.TC and a.IDCOMPROBANTE = b.IDCOMPROBANTE 
WHERE a.TC='PR' and (a.NROORDENDETRABAJO ='' OR a.NROORDENDETRABAJO is null) AND a.FINALIZADA=0 AND a.CUENTA=@pCliente
GROUP BY a.tc, a.IDCOMPROBANTE, a.FECHA,a.fechaestfin,a.comentarios,b.descripcion
ORDER BY a.fecha DESC)

DECLARE @pIdReparto INT
SET @pIdReparto=0

IF ltrim(@pidEstado)='3'
	BEGIN
		SET @fechaRealFin = @FechaHoraGrabacion
		SET @finalizada = 1
	END
ELSE 
	BEGIN
		SET @fechaRealFin = null
		SET @finalizada = 0
	END

SET NOCOUNT ON
BEGIN TRANSACTION

--Busco una OT cargada en los ultimos 5 minutos
SELECT TOP 1 @pCpteExistente = IdComprobante FROM V_MV_CPTE WHERE TC='OT' AND CUENTA=@pCliente AND FechaHora_Grabacion>=DATEADD(minute,-5,@FechaHoraGrabacion) ORDER BY V_MV_CPTE.FechaHora_Grabacion DESC
IF @pCpteExistente <>'' and not @pCpteExistente is null
	SELECT TOP 1 @estadoOtExistente = ltrim(IdEstado) FROM V_MV_STATUS WHERE TC='OT' AND IdComprobante=@pCpteExistente ORDER BY FechaHora DESC
ELSE
	SET @estadoOtExistente = ''

BEGIN
	IF (@pCpteExistente = '' or @pCpteExistente is null) or (@estadoOtExistente = '' or @estadoOtExistente is null or @estadoOtExistente <>'3')
		BEGIN
			INSERT INTO V_MV_CPTE
				( TC,IDCOMPROBANTE,IDCOMPLEMENTO,
				FECHA,FECHAESTFIN,CUENTA,
				NOMBRE,DOMICILIO,TELEFONO,
				LOCALIDAD,IDPROVINCIA,CODIGOPOSTAL,
				DOCUMENTOTIPO,DOCUMENTONUMERO,CONDICIONIVA,
				IDCOND_CPRA_VTA,COMENTARIOS,IMPORTE,IMPORTE_S_IVA,
				MONEDA,IDVENDEDOR,CLASEPRECIO,IdLista,FechaHora_Grabacion,IdReparto,UNEGOCIO,UNEGOCIO_DESTINO,Usuario,SUCURSAL,NUMERO,LETRA,FINALIZADA,ANULADA,APROBADO,ExentoIVAServicios,ExentoIVAArticulos,ExentoIVAOtros,
				Complementario,Impreso,TCORIGEN,COMPROBANTEORIGEN)
			VALUES
				(
					@Tc, @IdComprobante, 0,
					@pFecha, @pFecha, @pCliente,
					@Nombre, @Domicilio, @Telefono,
					@Localidad, @idProvincia, @codigoPostal,
					@documentoTipo, @documentoNumero, @condicionIva,
					@idCondCpraVta, '', 0, 0,
					'   1', @pIdTecnico, @clasePrecio, @idlista, @FechaHoraGrabacion, @pIdReparto, @unegocio, @unegocio, @USUARIO,
					SUBSTRING(@IdComprobante,1,4), SUBSTRING(@IdComprobante,5,8), SUBSTRING(@IdComprobante,12,1), @finalizada,0,0,0,0,0,0,0,'PR',@pPResupuesto)

			INSERT INTO V_MV_CPTETAREAS
				(TC,IDCOMPROBANTE,IDCOMPLEMENTO,IDTAREA,DESCRIPCION,HORAS,EXENTO,
				DESCRIPCIONADICIONAL,FECHAESTINICIO,SECUENCIA, USUARIO,IdTecnico,FechaRealFin,VALORHORA,VALORHORA_S_IVA)
			VALUES
				(@Tc, @IdComprobante, 0, dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pidTarea)),4), @descTarea, @minutos, 0,
					@pObs, @FechaHoraGrabacion, 1, @USUARIO, @pIdTecnico,@fechaRealFin,0,0)

			--IF @finalizada = 1
			--	BEGIN
					
					SET @idDIario = (SELECT MAX(IDDIARIO) +1 FROM V_MV_Diarios)
					INSERT INTO V_MV_Diarios
						(IDDiario,TC,IDCOMPROBANTE,IDCOMPLEMENTO,IDTAREA,DESCRIPCION,IdTecnico,FECHA,FECHAINICIO,FECHAFIN,MINUTOS,OBSERVACIONES,
						MATRICULA,CUENTA,AUTORIZADOPOR,NUMEROAUTORIZACION,Prioridad,Usuario,IdTecnico2,FHPresentacion,FHEmision,NroExp,FHEntrega,KM,HS)
					VALUES
						(@idDIario,@Tc, @IdComprobante, 0, dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pidTarea)),4), @descTarea,@pIdTecnico, @FechaHoraGrabacion,@FechaHoraGrabacion,@fechaRealFin,@minutos,
							@pObs,'', @pCliente,Null,NUll,2, @USUARIO,'',Null,Null,Null,Null,0,0)
			--	END

			SET @NROMOV = (SELECT MAX(NROMOV)+1 FROM V_MV_STATUS)
			SET @descEstado = (SELECT DESCRIPCION FROM V_TA_STATUS WHERE CodigoEstado=@pidEstado)

			INSERT INTO V_MV_STATUS (NroMov,UNegocio,TC,IdComprobante,IdTarea,IdEstado,FechaHora,Usuario,Cuenta,Observaciones,Secuencia,IdTecnico)
			VALUES(@NROMOV,'   1','OT',@idComprobante,@pidTarea,@pidEstado,@pFecha,@Usuario,@pCliente,@descEstado,1,@pIdTecnico)
		END
	ELSE
		BEGIN
			SET @idDIario = (SELECT MAX(IDDIARIO) +1 FROM V_MV_Diarios)
			INSERT INTO V_MV_Diarios
				(IDDiario,TC,IDCOMPROBANTE,IDCOMPLEMENTO,IDTAREA,DESCRIPCION,IdTecnico,FECHA,FECHAINICIO,FECHAFIN,MINUTOS,OBSERVACIONES,
				MATRICULA,CUENTA,AUTORIZADOPOR,NUMEROAUTORIZACION,Prioridad,Usuario,IdTecnico2,FHPresentacion,FHEmision,NroExp,FHEntrega,KM,HS)
			VALUES
				(@idDIario,@Tc, @pCpteExistente, 0, dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pidTarea)),4), @descTarea,@pIdTecnico, @FechaHoraGrabacion,@FechaHoraGrabacion,@fechaRealFin,@minutos,
					@pObs,'', @pCliente,Null,NUll,2, @USUARIO,'',Null,Null,Null,Null,0,0)
		END

	IF @@ERROR <> 0 OR @@ROWCOUNT <> 1
					BEGIN
		ROLLBACK TRANSACTION

		SET @pResultado = 21
		SET @pIdCpte = NULL
		SET @pMensaje = 'No pudo darse de alta la tarea'
		RETURN
	END
	COMMIT TRANSACTION
	SET @pResultado = 11
	SET @pIdCpte = @IdComprobante
	SET @pMensaje = 'La tarea se ha creado con exito'

END



GO

/****** Object:  StoredProcedure [dbo].[sp_web_setRespuestaTarea]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO











CREATE PROCEDURE [dbo].[sp_web_setRespuestaTarea]
	@Tipo as VarChar(1) = 'V',
	@IdDiario INT,
	@Tc as NvarChar(4),
	@idComprobante as NvarChar(13),
	@idTecnico as NvarChar(4),
	@idTecnico2 as NvarChar(4),
	@Fecha as Datetime,
	@FechaFin as Datetime,
	@idTarea as NvarChar(4),
	@Descripcion as NvarChar(250),
	@Observaciones as Ntext,
	@Matricula as nvarchar(20),
	@Cuenta as nvarchar(15),
	@Minutos as int,
	@Usuario as nvarchar(50),
	@ConImagen as Int,
	@Prioridad as Int,
	@IDRETORNO as int OUTPUT
AS

BEGIN
	SET NOCOUNT ON;
	DECLARE @ErrorSave INT
	DECLARE @MinimoMinutos INT
	DECLARE @FechaHoraGrabacion DATETIME
	DECLARE @NROMOV INT
	SET @FechaHoraGrabacion  = GETDATE()
	SET @MinimoMinutos = CAST((select Valor
	from TA_CONFIGURACION
	where clave = 'MinutosMinimoTarea') AS int)
	if (@Minutos <= @MinimoMinutos)	SET @Minutos = @MinimoMinutos
	SET @ErrorSave = 0

	UPDATE V_MV_CpteTareas SET FHEntrega = NULL WHERE TC = @Tc AND IDCOMPROBANTE = @idComprobante
	IF @TIpo = 'A'  GOTO ALTA
	IF @TIpo = 'B'  GOTO BAJA
	IF @TIpo = 'M'  GOTO MODIFICACION
	IF @Tipo = 'V'   
	   BEGIN
		IF EXISTS(Select idDiario
		from V_MV_Diarios
		where IDDiario  = @IdDiario) 
					 GOTO MODIFICACION
				 ELSE
					GOTO ALTA
	END
	GOTO FIN
	ALTA:

	set @IdDiario = (SELECT MAX(IDDIARIO)+1
	FROM V_MV_Diarios)
	INSERT INTO V_MV_Diarios
		(
		IdDiario,
		Tc,
		idComprobante,
		idTecnico ,
		Fecha ,
		FechaFin ,
		idTarea ,
		Descripcion ,
		Observaciones ,
		Matricula ,
		Cuenta ,
		Minutos,
		IDCOMPLEMENTO ,
		IdTecnico2,
		Prioridad,
		Usuario
		)
	VALUES
		(
			@IdDiario,
			@Tc,
			@idComprobante,
			@idTecnico ,
			@Fecha ,
			@FechaFin ,
			@idTarea ,
			@Descripcion ,
			@Observaciones ,
			@Matricula ,
			@Cuenta ,
			@Minutos,
			'0' ,
			@idTecnico2,
			@Prioridad,
			@Usuario    
    )
	IF (@@ERROR <> 0)    
    BEGIN
		SET @ErrorSave = @@ERROR
		GOTO ERRORES
	END
	SET @IDRETORNO = @@IDENTITY
	UPDATE V_MV_CpteTareas SET IdTecnico2 = @idTecnico, Prioridad = @Prioridad WHERE TC = @Tc AND IDCOMPROBANTE = @idComprobante
	SET @NROMOV = (SELECT MAX(NROMOV)+1
	FROM V_MV_STATUS)
	INSERT INTO V_MV_STATUS
		(NroMov,UNegocio,TC,IdComprobante,IdTarea,IdEstado,FechaHora,Usuario,Cuenta,Observaciones,Secuencia,IdTecnico)
	VALUES(@NROMOV, '   1', 'OT', @idComprobante, @idTarea, '   1', @FechaHoraGrabacion, @Usuario, @Cuenta, 'PENDIENTE', 1, '9999')
	GOTO FIN
	MODIFICACION:
	IF @ConImagen = 0
BEGIN
		UPDATE V_MV_Diarios SET    
	Tc=				   @Tc,
	idComprobante=	   @idComprobante,
	idTecnico =		   @idTecnico ,
	Fecha =			   @Fecha ,
	FechaFin =		   @FechaFin ,
	idTarea =		   @idTarea ,
	Descripcion =	   @Descripcion ,
	Matricula =		   @Matricula ,
	Cuenta =		   @Cuenta ,
	Minutos	=		   @Minutos ,
	Prioridad	=	   @Prioridad ,
	IdTecnico2 =	   @idTecnico2       
   WHERE IdDiario = @IdDiario
	END
ELSE
   UPDATE V_MV_Diarios SET    
	Tc=				   @Tc,
	idComprobante=	   @idComprobante,
	idTecnico =		   @idTecnico ,
	Fecha =			   @Fecha ,
	FechaFin =		   @FechaFin ,
	idTarea =		   @idTarea ,
	Descripcion =	   @Descripcion ,
	Observaciones =	   @Observaciones ,
	Matricula =		   @Matricula ,
	Cuenta =		   @Cuenta ,
	Minutos	=		   @Minutos ,
	Prioridad	=	   @Prioridad ,
	IdTecnico2 =		   @idTecnico2       
   WHERE IdDiario = @IdDiario
	IF (@@ERROR <> 0)    
    BEGIN
		SET @ErrorSave = @@ERROR
		GOTO ERRORES
	END
	SET @NROMOV = (SELECT MAX(NROMOV)+1
	FROM V_MV_STATUS)
	INSERT INTO V_MV_STATUS
		(NroMov,UNegocio,TC,IdComprobante,IdTarea,IdEstado,FechaHora,Usuario,Cuenta,Observaciones,Secuencia,IdTecnico)
	VALUES(@NROMOV, '   1', 'OT', @idComprobante, @idTarea, '   1', @FechaHoraGrabacion, @Usuario, @Cuenta, 'PENDIENTE', 1, '9999')

	GOTO FIN
	BAJA:
	DELETE V_MV_Diarios  WHERE IdDiario = @IdDiario
	IF (@@ERROR <> 0)    
    BEGIN
		SET @ErrorSave = @@ERROR
		GOTO ERRORES
	END
	GOTO FIN
	ERRORES:
	BEGIN
		RAISERROR ('Error al actualizar V_MV_DIARIOS', 16, 1)
		RETURN @ERRORSAVE
	END
	FIN:
END
GO

/****** Object:  StoredProcedure [dbo].[sp_web_setTareas]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO












CREATE PROCEDURE [dbo].[sp_web_setTareas]
	@pCliente						 nvarchar(15) = null,
	@pVendedor						 nvarchar(4) = null,
	@pFecha	     					 datetime = null,
	@pObs							 varchar(250),
	@pidTarea                        varchar(4) = null,
	@pResultado 					 smallint = NULL OUTPUT,
	@pMensaje 						 varchar(255) = NULL OUTPUT
AS
DECLARE @Tc NVARCHAR(4)
DECLARE @IdComprobante NVARCHAR(13)
DECLARE @nombre NVARCHAR(50)
DECLARE @domicilio NVARCHAR(50)
DECLARE @calle NVARCHAR(50)
DECLARE @numero NVARCHAR(50)
DECLARE @piso NVARCHAR(50)
DECLARE @departamento NVARCHAR(50)
DECLARE @telefono NVARCHAR(100)
DECLARE @localidad NVARCHAR(50)
DECLARE @idProvincia NVARCHAR(4)
DECLARE @codigoPostal NVARCHAR(10)
DECLARE @documentoTipo NVARCHAR(4)
DECLARE @documentoNumero NVARCHAR(13)
DECLARE @condicionIva NVARCHAR(50)
DECLARE @idCondCpraVta NVARCHAR(4)
DECLARE @comentarios NVARCHAR(100)
DECLARE @clasePrecio int
DECLARE @idlista NVARCHAR(4)
DECLARE @FechaHoraGrabacion DATETIME
DECLARE @unegocio NVARCHAR(4)
DECLARE @USUARIO AS NVARCHAR(50)
DECLARE @descTarea as NVARCHAR(50)

SET NOCOUNT ON
SET @Tc = 'OT'

SELECT @nombre = RAZON_SOCIAL,
	@calle = ISNULL(CALLE,'.'),
	@numero = ISNULL(NUMERO,'.'),
	@piso = ISNULL(PISO,''),
	@departamento = ISNULL(DEPARTAMENTO,''),
	@telefono = TELEFONO,
	@localidad = LOCALIDAD,
	@idProvincia = PROVINCIA,
	@codigoPostal = CPOSTAL,
	@documentoTipo = DOCUMENTO_TIPO,
	@documentoNumero = NUMERO_DOCUMENTO,
	@condicionIva = IVA,
	@idCondCpraVta = IDCOND_CPRA_VTA,
	@clasePrecio = CLASE,
	@comentarios = OBSERVACIONES,
	@idlista= IdLista
FROM VT_CLIENTES
WHERE CODIGO = @pCliente

SET @domicilio = @calle + ' ' + @numero
IF (@piso <> '') SET @domicilio= @domicilio+ ' ' + LTRIM(RTRIM(@piso)) + ' Piso '
IF (@departamento <> '') SET @domicilio= @domicilio+ ' Dpto: ' +  LTRIM(RTRIM(@departamento))
IF (@condicionIva=NULL) SET @condicionIva = '   1'
SET @idComprobante = dbo.FN_OBTIENE_PROXIMO_NUMERO_CPTE (@tc,'9999','X')
IF (@clasePrecio IS NULL) OR (@clasePrecio = NULL)
	SET @clasePrecio = 1

IF @pObs = ''
	SET @pObs = 'Cob. ' + @nombre

SET @USUARIO = SYSTEM_USER
SET @pVendedor = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pVendedor)),4)

SELECT @unegocio = VALOR
FROM TA_CONFIGURACION
WHERE CLAVE ='UNEGOCIO'

SET @unegocio=dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pVendedor)),4)

IF (@unegocio IS NULL) OR (@unegocio='')
	SET @unegocio='   1'

SET @FechaHoraGrabacion  = @pFecha
SET @pFecha = CONVERT(VARCHAR,@pFecha,103)

DECLARE @pIdReparto INT
SET @pIdReparto=0

SET @descTarea = ''
IF @pidTarea <> '' SELECT @descTarea = Descripcion
FROM V_TA_TAREAS
WHERE LTRIM(RTRIM(IDTAREA)) = ltrim(rtrim(@pidTarea))

SET NOCOUNT ON
BEGIN TRANSACTION
BEGIN
	INSERT INTO V_MV_CPTE
		( TC,IDCOMPROBANTE,IDCOMPLEMENTO,
		FECHA,FECHAESTFIN,CUENTA,
		NOMBRE,DOMICILIO,TELEFONO,
		LOCALIDAD,IDPROVINCIA,CODIGOPOSTAL,
		DOCUMENTOTIPO,DOCUMENTONUMERO,CONDICIONIVA,
		IDCOND_CPRA_VTA,COMENTARIOS,IMPORTE,IMPORTE_S_IVA,
		MONEDA,IDVENDEDOR,CLASEPRECIO,IdLista,FechaHora_Grabacion,IdReparto,UNEGOCIO,UNEGOCIO_DESTINO,Usuario,SUCURSAL,NUMERO,LETRA)
	VALUES
		(
			@Tc, @IdComprobante, 0,
			@pFecha, @pFecha, @pCliente,
			@Nombre, @Domicilio, @Telefono,
			@Localidad, @idProvincia, @codigoPostal,
			@documentoTipo, @documentoNumero, @condicionIva,
			@idCondCpraVta, '', 0, 0,
			'   1', @pVendedor, @clasePrecio, @idlista, @FechaHoraGrabacion, @pIdReparto, @unegocio, @unegocio, @USUARIO,
			SUBSTRING(@IdComprobante,1,4), SUBSTRING(@IdComprobante,5,8), SUBSTRING(@IdComprobante,12,1))

	INSERT INTO V_MV_CPTETAREAS
		(TC,IDCOMPROBANTE,IDCOMPLEMENTO,IDTAREA,DESCRIPCION,HORAS,EXENTO,
		DESCRIPCIONADICIONAL,FECHAESTINICIO,SECUENCIA, USUARIO)
	VALUES
		(@Tc, @IdComprobante, 0, dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pidTarea)),4), @descTarea, 1, 0,
			@pObs, @FechaHoraGrabacion, 1, @USUARIO)

	IF @@ERROR <> 0 OR @@ROWCOUNT <> 1
					BEGIN
		ROLLBACK TRANSACTION
		PRINT(ERROR_MESSAGE())
		SET @pResultado = 21
		SET @pMensaje = 'No pudo darse de alta EL PEDIDO correctamente'
		RETURN
	END
	COMMIT TRANSACTION
	SET @pResultado = 11
	SET @pMensaje = 'El Pedido se ha dado de alta con ?xito'

END


GO

/****** Object:  StoredProcedure [dbo].[sp_web_V_MV_CPTE]    Script Date: 25/04/2023 11:23:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[sp_web_V_MV_CPTE]
	@pCliente						 nvarchar(15) = null,
	@pVendedor						 nvarchar(4) = null,
	@pFecha	     					 datetime = null,
	@pObservaciones					 NVARCHAR(250) = null,
	@pLat							 NVARCHAR(15) = null,
	@pLng							 NVARCHAR(15) = null,
	@pTC							 NVARCHAR(4) = null,
	@pResultado 					 smallint = NULL OUTPUT,
	@pMensaje 						 varchar(255) = NULL OUTPUT,
	@pIdComprobanteRES				 int = NULL OUTPUT
AS
--DECLARE @Tc NVARCHAR(4)
DECLARE @IdComprobante NVARCHAR(13)
DECLARE @nombre NVARCHAR(50)
DECLARE @domicilio NVARCHAR(50)
DECLARE @calle NVARCHAR(50)
DECLARE @numero NVARCHAR(50)
DECLARE @piso NVARCHAR(50)
DECLARE @departamento NVARCHAR(50)
DECLARE @telefono NVARCHAR(100)
DECLARE @localidad NVARCHAR(50)
DECLARE @idProvincia NVARCHAR(4)
DECLARE @codigoPostal NVARCHAR(10)
DECLARE @documentoTipo NVARCHAR(4)
DECLARE @documentoNumero NVARCHAR(15)
DECLARE @condicionIva NVARCHAR(50)
DECLARE @idCondCpraVta NVARCHAR(4)
DECLARE @comentarios NVARCHAR(100)
DECLARE @idLista NVARCHAR(4)
DECLARE @vendedorCliente NVARCHAR(4)
DECLARE @clasePrecio int

SET NOCOUNT ON

IF @pTC = '' SET @pTC = 'NP'

IF @pCliente = ''
	SET @pCliente = (SELECT VALOR FROM TA_CONFIGURACION WHERE CLAVE='CUENTACONSUMIDORFINAL')

SELECT @nombre = isnull(RAZON_SOCIAL,''),
	@calle = ISNULL(CALLE,'.'),
	@numero = ISNULL(NUMERO,'.'),
	@piso = ISNULL(PISO,''),
	@departamento = ISNULL(DEPARTAMENTO,''),
	@telefono = TELEFONO,
	@localidad = LOCALIDAD,
	@idProvincia = PROVINCIA,
	@codigoPostal = CPOSTAL,
	@documentoTipo = DOCUMENTO_TIPO,
	@documentoNumero = NUMERO_DOCUMENTO,
	@condicionIva = IVA,
	@idCondCpraVta = IDCOND_CPRA_VTA,
	@clasePrecio = CLASE,
	@idLista = IDLISTA,
	@vendedorCliente = idvendedor
FROM VT_CLIENTES
WHERE CODIGO = @pCliente

SET @domicilio = @calle + ' ' + @numero
IF (@piso <> '') SET @domicilio= @domicilio+ ' ' + LTRIM(RTRIM(@piso)) + ' Piso '
IF (@departamento <> '') SET @domicilio= @domicilio+ ' Dpto: ' +  LTRIM(RTRIM(@departamento))
IF (@condicionIva=NULL) SET @condicionIva = '   1'

SET @idComprobante = dbo.FN_OBTIENE_PROXIMO_NUMERO_CPTE (@pTC,'9999','X')

IF (@clasePrecio IS NULL) OR (@clasePrecio = NULL)
	SET @clasePrecio = 1

IF @pVendedor = '' OR @pVendedor IS NULL
	SET @pVendedor = @vendedorCliente

SET @pVendedor = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@pVendedor)),4)
SET @idLista = dbo.FN_FMT_LEERCODIGO(LTRIM(RTRIM(@idLista)),4)

SET DATEFORMAT YMD
SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY
	INSERT INTO V_MV_CPTE
	(TC,IDCOMPROBANTE,IDCOMPLEMENTO,
	FECHA,FECHAESTFIN,FECHAESTINICIO,CUENTA,
	NOMBRE,DOMICILIO,TELEFONO,
	LOCALIDAD,IDPROVINCIA,CODIGOPOSTAL,
	DOCUMENTOTIPO,DOCUMENTONUMERO,CONDICIONIVA,
	IDCOND_CPRA_VTA,COMENTARIOS,IMPORTE,IMPORTE_S_IVA,
	MONEDA,IDVENDEDOR,CLASEPRECIO,UNEGOCIO_DESTINO,IdLista,IDMOTIVOCPRAVTA,IDDEPOSITO,AlicIva,ImporteIva,NEtoGravado,NetoNoGravado,Unegocio,
	FechaHora_Grabacion)
	VALUES
	(
		@pTC, @IdComprobante, 0,
		@pFecha, @pFecha, @pFecha,@pCliente,
		@Nombre, @Domicilio, isnull(@Telefono,''),
		@Localidad, @idProvincia, ltrim(@codigoPostal),
		@documentoTipo, ltrim(@documentoNumero), @condicionIva,
		@idCondCpraVta, @pObservaciones, 0, 0,
		'   1', @pVendedor, @clasePrecio, '   1', @idLista,'   1','   1',21,0,0,0,'   1', GETDATE())

	

	IF @@ERROR <> 0 OR @@ROWCOUNT <> 1
		BEGIN
			ROLLBACK TRANSACTION
			SET @pIdComprobanteRES = NULL
			SET @pResultado = 21
			SET @pMensaje = 'No pudo darse de alta el pedido correctamente'
			RETURN
		END
	ELSE
		BEGIN
			COMMIT TRANSACTION

			SET @pResultado = 11
			SET @pMensaje = 'El Pedido se ha dado de alta con �xito'
			SET @pIdComprobanteRES = @@IDENTITY

			INSERT INTO S_TA_UBICACIONES_VENDEDOR (lat,long,idvendedor,fechahora,idcomprobante)
			VALUES (@pLat,@pLng,@pVendedor,GETDATE(), @IdComprobante)
		END
END TRY
BEGIN CATCH
	ROLLBACK TRANSACTION
	SET @pIdComprobanteRES = NULL
	SET @pResultado = ERROR_NUMBER()
	SET @pMensaje = ERROR_MESSAGE()
END CATCH
	

GO








GO

IF NOT EXISTS (
    SELECT * FROM sys.tables t 
    JOIN sys.schemas s ON (t.schema_id = s.schema_id) 
    WHERE s.name = 'dbo' AND t.name = 'AUX_WEB_CARRITO') 	
    CREATE TABLE dbo.AUX_WEB_CARRITO (
        [id] [int] IDENTITY(1,1) NOT NULL,
	[idarticulo] [nvarchar](25) NULL,
	[descripcion] [nvarchar](100) NULL,
	[precio] [float] NULL,
	[cantidad] [float] NULL,
	[descuento] [float] NULL,
	[presentacion] [varchar](5) NULL,
	[idCliente] [nvarchar](9) NULL,
        );